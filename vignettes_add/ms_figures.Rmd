---
title: "Hypothesis testing"
output:
  html_document: 
    fig_width: 10
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
library(dplyr)
library(tibble)
library(rsofun)
library(ggplot2)
library(ggpubr) # ggarrange
library(patchwork)
library(ggthemes)
library(scales)

show_col(colorblind_pal()(8))

library(lme4) #lmer model
library(lmerTest) #p-values
library(effects) #plot effectslibrary(MuMIn) #r.squaredGLMM
library(merTools) #predictInterval
library(lattice) #xyplot
library(PerformanceAnalytics)
library(MuMIn)
library(ggeffects) # plot effects
library(ggpubr) # ggarrange
library(ggridges) # stat_density_ridges
library(PerformanceAnalytics)
library(sjPlot)
```

# Read model outputs

## DBH Mortality gs-leuning 

### LUE - Different environmental conditions

```{r}
ea1sa1DBHp1gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea1sa1DBHp1gl_out_annual_tile.csv")
ea1sa1DBHp1gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea1sa1DBHp1gl_out_annual_cohorts.csv")
ea1sa1DBHp2gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea1sa1DBHp2gl_out_annual_tile.csv")
ea1sa1DBHp2gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea1sa1DBHp2gl_out_annual_cohorts.csv")
ea1sa1DBHp3gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea1sa1DBHp3gl_out_annual_tile.csv")
ea1sa1DBHp3gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea1sa1DBHp3gl_out_annual_cohorts.csv")

ea2sa1DBHp1gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea2sa1DBHp1gl_out_annual_tile.csv")
ea2sa1DBHp1gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea2sa1DBHp1gl_out_annual_cohorts.csv")
ea2sa1DBHp2gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea2sa1DBHp2gl_out_annual_tile.csv")
ea2sa1DBHp2gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea2sa1DBHp2gl_out_annual_cohorts.csv")
ea2sa1DBHp3gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea2sa1DBHp3gl_out_annual_tile.csv")
ea2sa1DBHp3gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea2sa1DBHp3gl_out_annual_cohorts.csv")

ea3sa1DBHp1gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea3sa1DBHp1gl_out_annual_tile.csv")
ea3sa1DBHp1gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea3sa1DBHp1gl_out_annual_cohorts.csv")
ea3sa1DBHp2gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea3sa1DBHp2gl_out_annual_tile.csv")
ea3sa1DBHp2gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea3sa1DBHp2gl_out_annual_cohorts.csv")
ea3sa1DBHp3gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea3sa1DBHp3gl_out_annual_tile.csv")
ea3sa1DBHp3gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea3sa1DBHp3gl_out_annual_cohorts.csv")

ggplot() + 
  geom_line(data=ea1sa1DBHp3gl_out_annual_tile, aes(x=year, y=plantC, color='Control'),alpha=.7) + 
  geom_line(data=ea2sa1DBHp3gl_out_annual_tile, aes(x=year, y=plantC, color='+15'),alpha=.7) +
  geom_line(data=ea3sa1DBHp3gl_out_annual_tile, aes(x=year, y=plantC, color='+30'),alpha=.7)
```

## GR Mortality gs-leuning 

### LUE - Different environmental conditions

```{r}
ea1sa1GRp1gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea1sa1GRp1gl_out_annual_tile.csv")
ea1sa1GRp1gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea1sa1GRp1gl_out_annual_cohorts.csv")
ea1sa1GRp2gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea1sa1GRp2gl_out_annual_tile.csv")
ea1sa1GRp2gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea1sa1GRp2gl_out_annual_cohorts.csv")
ea1sa1GRp3gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea1sa1GRp3gl_out_annual_tile.csv")
ea1sa1GRp3gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea1sa1GRp3gl_out_annual_cohorts.csv")

ea2sa1GRp1gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea2sa1GRp1gl_out_annual_tile.csv")
ea2sa1GRp1gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea2sa1GRp1gl_out_annual_cohorts.csv")
ea2sa1GRp2gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea2sa1GRp2gl_out_annual_tile.csv")
ea2sa1GRp2gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea2sa1GRp2gl_out_annual_cohorts.csv")
ea2sa1GRp3gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea2sa1GRp3gl_out_annual_tile.csv")
ea2sa1GRp3gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea2sa1GRp3gl_out_annual_cohorts.csv")

ea3sa1GRp1gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea3sa1GRp1gl_out_annual_tile.csv")
ea3sa1GRp1gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea3sa1GRp1gl_out_annual_cohorts.csv")
ea3sa1GRp2gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea3sa1GRp2gl_out_annual_tile.csv")
ea3sa1GRp2gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea3sa1GRp2gl_out_annual_cohorts.csv")
ea3sa1GRp3gl_out_annual_tile    <- read.csv("~/rsofun/outputs_lm3ppa/ea3sa1GRp3gl_out_annual_tile.csv")
ea3sa1GRp3gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/ea3sa1GRp3gl_out_annual_cohorts.csv")

ggplot() + 
  geom_line(data=ea1sa1GRp1gl_out_annual_tile, aes(x=year, y=plantC, color='Control'),alpha=.7) + 
  geom_line(data=ea2sa1GRp1gl_out_annual_tile, aes(x=year, y=plantC, color='+15'),alpha=.7) +
  geom_line(data=ea3sa1GRp1gl_out_annual_tile, aes(x=year, y=plantC, color='+30'),alpha=.7)

```

# Exploring relationships and plotting

## LUE levels

### a) Mortality formulations

#### DBH
```{r, fig.width = 5, fig.height = 5}
scaleFUN <- function(x) sprintf("%.2f", x)

fig1a_dbh <- ggplot(data.frame(x = c(0, 1.06)), aes(x)) + 
  stat_function(fun = ~ 0.1*.x ^ 1.5, col="#009E73") +  
  stat_function(fun = ~ 0.1*.x ^ 2.3, col="#0072B2") + 
  stat_function(fun = ~ 0.1*.x ^ 3.5, col="#D55E00") + 
  labs(x='DBH', y='m') +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
                   axis.text = element_text(size = 10),axis.title = element_text(size = 11),
                   legend.text = element_text(size = 10),legend.title = element_text(size = 11),
                   plot.title = element_text(size = 11)) +
  scale_x_continuous(limits=c(0,1.1), breaks=seq(0,1.1,0.25)) +
  scale_y_continuous(limits=c(0,0.15), breaks=seq(0,0.15,0.05)) 

fig1a_dbh

ggplot(data.frame(x = c(0, 1.06)), aes(x)) + 
  stat_function(fun = ~ 0.1*.x ^ 1.5, col="#009E73") +  
  stat_function(fun = ~ 0.1*.x ^ 2.5, col="#0072B2") + 
  stat_function(fun = ~ 0.1*.x ^ 5.0, col="#D55E00") + 
  labs(x='DBH (m)', y='Mortality') +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
                   axis.text = element_text(size = 10),axis.title = element_text(size = 11),
                   legend.text = element_text(size = 10),legend.title = element_text(size = 11),
                   plot.title = element_text(size = 11)) +
  scale_x_continuous(limits=c(0,1.1), breaks=seq(0,1.1,0.25)) +
  scale_y_continuous(limits=c(0,0.15), breaks=seq(0,0.15,0.05)) +
  annotate("text", x = 0.85, y = 0.15, label = expression(paste("y = 0.1", x^1.5)),col="#009E73") +
  annotate("text", x = 0.85, y = 0.14, label = expression(paste("y = 0.1", x^2.5)),col="#0072B2") +
  annotate("text", x = 0.85, y = 0.13, label = expression(paste("y = 0.1", x^5.0)),col="#D55E00")

```

#### GR
```{r}

fig1a_gr <- ggplot(data.frame(x = c(0, 20)), aes(x)) + 
  stat_function(fun = ~ 0.15/(1+(exp(-0.5*(.x-10)))), col="#009E73") +
  stat_function(fun = ~ 0.15/(1+(exp(-0.8*(.x-10)))), col="#0072B2") +
  stat_function(fun = ~ 0.15/(1+(exp(-1.4*(.x-10)))), col="#D55E00") +
  labs(x='GR', y='m') + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) +
  scale_x_continuous(limits=c(0,20), breaks=seq(0,20,5)) +
  scale_y_continuous(limits=c(0,0.15),breaks=seq(0,0.15,0.05))

fig1a_gr
```

### b) Stand develop: Stand biomass vs. time

#### DBH 
```{r, fig.width = 5, fig.height = 5}
fig1b_dbh <- ggplot() + 
  geom_line(data=ea2sa1DBHp1gl_out_annual_tile, aes(x=year, y=plantC, color='x1', linetype='+15%'),alpha=.7) + 
  geom_line(data=ea2sa1DBHp2gl_out_annual_tile, aes(x=year, y=plantC, color='x2', linetype='+15%'),alpha=.7) +
  geom_line(data=ea2sa1DBHp3gl_out_annual_tile, aes(x=year, y=plantC, color='x3', linetype='+15%'),alpha=.7) +
  geom_line(data=ea3sa1DBHp1gl_out_annual_tile, aes(x=year, y=plantC, color='x1', linetype='+30%'),alpha=.7) + 
  geom_line(data=ea3sa1DBHp2gl_out_annual_tile, aes(x=year, y=plantC, color='x2', linetype='+30%'),alpha=.7) +
  geom_line(data=ea3sa1DBHp3gl_out_annual_tile, aes(x=year, y=plantC, color='x3', linetype='+30%'),alpha=.7) +
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_linetype_manual("Level of LUE", breaks = c("+15%", "+30%"), 
                     values = c("longdash","solid")) +
  labs(x = "Year", y = "B") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) +
  scale_x_continuous(limits=c(0,1500),breaks=seq(0,1500,500)) +
  scale_y_continuous(limits=c(0,51),breaks=seq(0,50,15))

fig1b_dbh

leg1 <- get_legend(fig1b_dbh)
leg1 <- as_ggplot(leg1)

# Changes in biomass
B_DBH_ea1p1 <- ea1sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_DBH_ea2p1 <- ea2sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_DBH_ea3p1 <- ea3sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_DBH_ea2p1/B_DBH_ea1p1
B_DBH_ea3p1/B_DBH_ea2p1
B_DBH_ea1p1
B_DBH_ea2p1
B_DBH_ea3p1

B_DBH_ea1p2 <- ea1sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_DBH_ea2p2 <- ea2sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_DBH_ea3p2 <- ea3sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_DBH_ea2p2/B_DBH_ea1p2
B_DBH_ea3p2/B_DBH_ea2p2

B_DBH_ea1p3 <- ea1sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_DBH_ea2p3 <- ea2sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_DBH_ea3p3 <- ea3sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_DBH_ea2p3/B_DBH_ea1p3
B_DBH_ea3p3/B_DBH_ea2p3

ggplot() + 
  geom_line(data=ea2sa1DBHp1gl_out_annual_tile, aes(x=year, y=plantC, color='x1', linetype='+15%'),alpha=.7) + 
  geom_line(data=ea2sa1DBHp2gl_out_annual_tile, aes(x=year, y=plantC, color='x2', linetype='+15%'),alpha=.7) +
  geom_line(data=ea2sa1DBHp3gl_out_annual_tile, aes(x=year, y=plantC, color='x3', linetype='+15%'),alpha=.7) +
  geom_line(data=ea3sa1DBHp1gl_out_annual_tile, aes(x=year, y=plantC, color='x1', linetype='+30%'),alpha=.7) + 
  geom_line(data=ea3sa1DBHp2gl_out_annual_tile, aes(x=year, y=plantC, color='x2', linetype='+30%'),alpha=.7) +
  geom_line(data=ea3sa1DBHp3gl_out_annual_tile, aes(x=year, y=plantC, color='x3', linetype='+30%'),alpha=.7) +
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_linetype_manual("Level of LUE", breaks = c("+15%", "+30%"), 
                     values = c("longdash","solid")) +
  labs(x = "Year", y = expression(paste("Biomass (Kg C ", m^-2, " ", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        plot.title = element_text(size = 11)) +
  scale_x_continuous(limits=c(0,1500),breaks=seq(0,1500,500)) +
  scale_y_continuous(limits=c(0,51),breaks=seq(0,50,15))
```

#### GR 
```{r, fig.width = 5, fig.height = 5}
fig1b_gr <- ggplot() + 
  geom_line(data=ea2sa1GRp1gl_out_annual_tile, aes(x=year, y=plantC, color='x1', linetype='+15%'),alpha=.7) + 
  geom_line(data=ea2sa1GRp2gl_out_annual_tile, aes(x=year, y=plantC, color='x2', linetype='+15%'),alpha=.7) +
  geom_line(data=ea2sa1GRp3gl_out_annual_tile, aes(x=year, y=plantC, color='x3', linetype='+15%'),alpha=.7) +
  geom_line(data=ea3sa1GRp1gl_out_annual_tile, aes(x=year, y=plantC, color='x1', linetype='+30%'),alpha=.7) + 
  geom_line(data=ea3sa1GRp2gl_out_annual_tile, aes(x=year, y=plantC, color='x2', linetype='+30%'),alpha=.7) +
  geom_line(data=ea3sa1GRp3gl_out_annual_tile, aes(x=year, y=plantC, color='x3', linetype='+30%'),alpha=.7) +
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_linetype_manual("Level of LUE", breaks = c("+15%", "+30%"), 
                     values = c("longdash","solid")) +
   labs(x = "Year", y = "B") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) +
  scale_x_continuous(limits=c(0,1500),breaks=seq(0,1500,500)) +
  scale_y_continuous(limits=c(0,51),breaks=seq(0,50,15))

fig1b_gr

# Changes in biomass

B_GR_ea1p2 <- ea1sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_GR_ea2p2 <- ea2sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_GR_ea3p2 <- ea3sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_GR_ea2p2/B_GR_ea1p2
B_GR_ea3p2/B_GR_ea2p2
B_GR_ea1p2
B_GR_ea2p2
B_GR_ea3p2

B_GR_ea1p2 <- ea1sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_GR_ea2p2 <- ea2sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_GR_ea3p2 <- ea3sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_GR_ea2p2/B_GR_ea1p2
B_GR_ea3p2/B_GR_ea2p2

B_GR_ea1p3 <- ea1sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_GR_ea2p3 <- ea2sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_GR_ea3p3 <- ea3sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(plantC))
B_GR_ea2p3/B_GR_ea1p3
B_GR_ea3p3/B_GR_ea2p3
```

### c) Growth (NPP)

#### DBH
```{r, fig.width = 6, fig.height = 6}
fig1c_dbh <- ggplot() + 
  geom_line(data=ea2sa1DBHp1gl_out_annual_tile, aes(x=year, y=NPP, color='x1', linetype='+15%'),alpha=.7) + 
  geom_line(data=ea2sa1DBHp2gl_out_annual_tile, aes(x=year, y=NPP, color='x2', linetype='+15%'),alpha=.7) +
  geom_line(data=ea2sa1DBHp3gl_out_annual_tile, aes(x=year, y=NPP, color='x3', linetype='+15%'),alpha=.7) +
  geom_line(data=ea3sa1DBHp1gl_out_annual_tile, aes(x=year, y=NPP, color='x1', linetype='+30%'),alpha=.7) + 
  geom_line(data=ea3sa1DBHp2gl_out_annual_tile, aes(x=year, y=NPP, color='x2', linetype='+30%'),alpha=.7) +
  geom_line(data=ea3sa1DBHp3gl_out_annual_tile, aes(x=year, y=NPP, color='x3', linetype='+30%'),alpha=.7) +
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_linetype_manual("Level of LUE", breaks = c("+15%", "+30%"), 
                     values = c("longdash","solid")) +
  labs(x = "Year", y = "G") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) +
  scale_x_continuous(limits=c(0,1500),breaks=seq(0,1500,500)) +
  scale_y_continuous(limits=c(0,2.05),breaks=seq(0,2,0.5))

fig1c_dbh

# Changes in growth
G_DBH_ea1p1 <- ea1sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_DBH_ea2p1 <- ea2sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_DBH_ea3p1 <- ea3sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_DBH_ea2p1/G_DBH_ea1p1
G_DBH_ea3p1/G_DBH_ea2p1
G_DBH_ea1p1
G_DBH_ea2p1
G_DBH_ea3p1

G_DBH_ea1p2 <- ea1sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_DBH_ea2p2 <- ea2sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_DBH_ea3p2 <- ea3sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_DBH_ea2p2/G_DBH_ea1p2
G_DBH_ea3p2/G_DBH_ea2p2

G_DBH_ea1p3 <- ea1sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_DBH_ea2p3 <- ea2sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_DBH_ea3p3 <- ea3sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_DBH_ea2p3/G_DBH_ea1p3
G_DBH_ea3p3/G_DBH_ea2p3
```

#### GR
```{r, fig.width = 6, fig.height = 6}
fig1c_gr <- ggplot() + 
  geom_line(data=ea2sa1GRp1gl_out_annual_tile, aes(x=year, y=NPP, color='x1', linetype='+15%'),alpha=.7) + 
  geom_line(data=ea2sa1GRp2gl_out_annual_tile, aes(x=year, y=NPP, color='x2', linetype='+15%'),alpha=.7) +
  geom_line(data=ea2sa1GRp3gl_out_annual_tile, aes(x=year, y=NPP, color='x3', linetype='+15%'),alpha=.7) +
  geom_line(data=ea3sa1GRp1gl_out_annual_tile, aes(x=year, y=NPP, color='x1', linetype='+30%'),alpha=.7) + 
  geom_line(data=ea3sa1GRp2gl_out_annual_tile, aes(x=year, y=NPP, color='x2', linetype='+30%'),alpha=.7) +
  geom_line(data=ea3sa1GRp3gl_out_annual_tile, aes(x=year, y=NPP, color='x3', linetype='+30%'),alpha=.7) +
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_linetype_manual("Level of LUE", breaks = c("+15%", "+30%"), 
                     values = c("longdash","solid")) +
  labs(x = "Year", y = "G") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) +
  scale_x_continuous(limits=c(0,1500),breaks=seq(0,1500,500)) +
  scale_y_continuous(limits=c(0,2),breaks=seq(0,2,0.5))

fig1c_gr

# Changes in growth
G_GR_ea1p1 <- ea1sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_GR_ea2p1 <- ea2sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_GR_ea3p1 <- ea3sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_GR_ea2p1/G_GR_ea1p1
G_GR_ea3p1/G_GR_ea2p1
G_GR_ea1p1
G_GR_ea2p1
G_GR_ea3p1

G_GR_ea1p2 <- ea1sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_GR_ea2p2 <- ea2sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_GR_ea3p2 <- ea3sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_GR_ea2p2/G_GR_ea1p2
G_GR_ea3p2/G_GR_ea2p2

G_GR_ea1p3 <- ea1sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_GR_ea2p3 <- ea2sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_GR_ea3p3 <- ea3sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(NPP))
G_GR_ea2p3/G_GR_ea1p3
G_GR_ea3p3/G_GR_ea2p3
```

### d) Mortality (Both mortality and biomass turnover)

#### DBH
```{r, fig.width = 6, fig.height = 6}
fig1d_dbh <- ggplot() + 
  geom_line(data=ea2sa1DBHp1gl_out_annual_tile, aes(x=year, y=c_deadtrees+m_turnover, color='x1', linetype='+15%'),alpha=.7) + 
  geom_line(data=ea2sa1DBHp2gl_out_annual_tile, aes(x=year, y=c_deadtrees+m_turnover, color='x2', linetype='+15%'),alpha=.7) +
  geom_line(data=ea2sa1DBHp3gl_out_annual_tile, aes(x=year, y=c_deadtrees+m_turnover, color='x3', linetype='+15%'),alpha=.7) +
  geom_line(data=ea3sa1DBHp1gl_out_annual_tile, aes(x=year, y=c_deadtrees+m_turnover, color='x1', linetype='+30%'),alpha=.7) + 
  geom_line(data=ea3sa1DBHp2gl_out_annual_tile, aes(x=year, y=c_deadtrees+m_turnover, color='x2', linetype='+30%'),alpha=.7) +
  geom_line(data=ea3sa1DBHp3gl_out_annual_tile, aes(x=year, y=c_deadtrees+m_turnover, color='x3', linetype='+30%'),alpha=.7) +
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_linetype_manual("Level of LUE", breaks = c("+15%", "+30%"), 
                     values = c("longdash","solid")) +
  labs(x = "Year", y = "M") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) +
  scale_x_continuous(limits=c(0,1500),breaks=seq(0,1500,500)) +
  scale_y_continuous(limits=c(0,2.5),breaks=seq(0,2,0.5))

fig1d_dbh

# Changes in mortality
G_DBH_ea1p1 <- ea1sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_DBH_ea2p1 <- ea2sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_DBH_ea3p1 <- ea3sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_DBH_ea2p1/G_DBH_ea1p1
G_DBH_ea3p1/G_DBH_ea2p1
G_DBH_ea1p1
G_DBH_ea2p1
G_DBH_ea3p1

G_DBH_ea1p2 <- ea1sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_DBH_ea2p2 <- ea2sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_DBH_ea3p2 <- ea3sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_DBH_ea2p2/G_DBH_ea1p2
G_DBH_ea3p2/G_DBH_ea2p2

G_DBH_ea1p3 <- ea1sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_DBH_ea2p3 <- ea2sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_DBH_ea3p3 <- ea3sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_DBH_ea2p3/G_DBH_ea1p3
G_DBH_ea3p3/G_DBH_ea2p3
```

#### GR
```{r, fig.width = 6, fig.height = 6}
fig1d_gr <- ggplot() + 
  geom_line(data=ea2sa1GRp1gl_out_annual_tile, aes(x=year, y=c_deadtrees+m_turnover, color='x1', linetype='+15%'),alpha=.7) + 
  geom_line(data=ea2sa1GRp2gl_out_annual_tile, aes(x=year, y=c_deadtrees+m_turnover, color='x2', linetype='+15%'),alpha=.7) +
  geom_line(data=ea2sa1GRp3gl_out_annual_tile, aes(x=year, y=c_deadtrees+m_turnover, color='x3', linetype='+15%'),alpha=.7) +
  geom_line(data=ea3sa1GRp1gl_out_annual_tile, aes(x=year, y=c_deadtrees+m_turnover, color='x1', linetype='+30%'),alpha=.7) + 
  geom_line(data=ea3sa1GRp2gl_out_annual_tile, aes(x=year, y=c_deadtrees+m_turnover, color='x2', linetype='+30%'),alpha=.7) +
  geom_line(data=ea3sa1GRp3gl_out_annual_tile, aes(x=year, y=c_deadtrees+m_turnover, color='x3', linetype='+30%'),alpha=.7) +
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_linetype_manual("Level of LUE", breaks = c("+15%", "+30%"), 
                     values = c("longdash","solid")) +
  labs(x = "Year", y = "M") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) +
  scale_x_continuous(limits=c(0,1500),breaks=seq(0,1500,500)) +
  scale_y_continuous(limits=c(0,2.0),breaks=seq(0,2,0.5))

fig1d_gr

# Changes in mortality
G_GR_ea1p1 <- ea1sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_GR_ea2p1 <- ea2sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_GR_ea3p1 <- ea3sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_GR_ea2p1/G_GR_ea1p1
G_GR_ea3p1/G_GR_ea2p1
G_GR_ea1p1
G_GR_ea2p1
G_GR_ea3p1

G_GR_ea1p2 <- ea1sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_GR_ea2p2 <- ea2sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_GR_ea3p2 <- ea3sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_GR_ea2p2/G_GR_ea1p2
G_GR_ea3p2/G_GR_ea2p2

G_GR_ea1p3 <- ea1sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_GR_ea2p3 <- ea2sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_GR_ea3p3 <- ea3sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(meanB=mean(c_deadtrees+m_turnover))
G_GR_ea2p3/G_GR_ea1p3
G_GR_ea3p3/G_GR_ea2p3
```

### e) Relative change biomass (plantC) vs. NPP

#### DBH
```{r, fig.width = 5, fig.height = 5}

# DBH p1
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

B30 <- ea3sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B30=mean(plantC)) 
B15 <- ea2sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B15=mean(plantC))
B0  <- ea1sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB15_30 <- (B30$B30 - B15$B15)/B15$B15
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

DBHp1gl_RelChange_0_15 <- data.frame(dNPP0_15,dB0_15)
DBHp1gl_RelChange_15_30 <- data.frame(dNPP15_30,dB15_30)
DBHp1gl_RelChange_0_30 <- data.frame(dNPP0_30,dB0_30)

# DBH p2
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

B30 <- ea3sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B30=mean(plantC)) 
B15 <- ea2sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B15=mean(plantC))
B0  <- ea1sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB15_30 <- (B30$B30 - B15$B15)/B15$B15
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

DBHp2gl_RelChange_0_15 <- data.frame(dNPP0_15,dB0_15)
DBHp2gl_RelChange_15_30 <- data.frame(dNPP15_30,dB15_30)
DBHp2gl_RelChange_0_30 <- data.frame(dNPP0_30,dB0_30)

# DBH p3
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

B30 <- ea3sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B30=mean(plantC)) 
B15 <- ea2sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B15=mean(plantC))
B0  <- ea1sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB15_30 <- (B30$B30 - B15$B15)/B15$B15
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

DBHp3gl_RelChange_0_15 <- data.frame(dNPP0_15,dB0_15)
DBHp3gl_RelChange_15_30 <- data.frame(dNPP15_30,dB15_30)
DBHp3gl_RelChange_0_30 <- data.frame(dNPP0_30,dB0_30)

fig1e_dbh <- ggplot() + 
  geom_point(data=DBHp1gl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='x1', shape='0-15%'),size=3) + 
  geom_point(data=DBHp1gl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='x1', shape='0-30%'),size=3) + 
  geom_point(data=DBHp2gl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='x2', shape='0-15%'),size=3) + 
  geom_point(data=DBHp2gl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='x2', shape='0-30%'),size=3) + 
  geom_point(data=DBHp3gl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='x3', shape='0-15%'),size=3) + 
  geom_point(data=DBHp3gl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='x3', shape='0-30%'),size=3) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_shape_manual("Level of LUE", breaks = c("0-15%","0-30%"), 
                     values = c(16,17)) +  labs(x="dG/G", y="dB/B") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  scale_x_continuous(limits = c(0,0.5),breaks=seq(0,0.5,0.1)) + 
  scale_y_continuous(limits = c(0,0.5),breaks=seq(0,0.5,0.1)) +
  geom_abline(slope=1, intercept = 0.0, linetype="dashed") 

fig1e_dbh

leg2 <- get_legend(fig1e_dbh)
leg2 <- as_ggplot(leg2)

ggplot() + 
  geom_point(data=DBHp1gl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='x1', shape='0-15%'),size=3) + 
  geom_point(data=DBHp1gl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='x1', shape='0-30%'),size=3) + 
  geom_point(data=DBHp2gl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='x2', shape='0-15%'),size=3) + 
  geom_point(data=DBHp2gl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='x2', shape='0-30%'),size=3) + 
  geom_point(data=DBHp3gl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='x3', shape='0-15%'),size=3) + 
  geom_point(data=DBHp3gl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='x3', shape='0-30%'),size=3) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_shape_manual("Level of LUE", breaks = c("0-15%","0-30%"), 
                     values = c(16,17)) +  labs(x="dG/G", y="dB/B") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  scale_x_continuous(limits = c(0,0.5),breaks=seq(0,0.5,0.1)) + 
  scale_y_continuous(limits = c(0,0.5),breaks=seq(0,0.5,0.1)) +
  geom_abline(slope=1, intercept = 0.0, linetype="dashed") 
```

#### GR

```{r, fig.width = 5, fig.height = 5}
# GR p1
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

B30 <- ea3sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B30=mean(plantC)) 
B15 <- ea2sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B15=mean(plantC))
B0  <- ea1sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB15_30 <- (B30$B30 - B15$B15)/B15$B15
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

GRp1gl_RelChange_0_15 <- data.frame(dNPP0_15,dB0_15)
GRp1gl_RelChange_15_30 <- data.frame(dNPP15_30,dB15_30)
GRp1gl_RelChange_0_30 <- data.frame(dNPP0_30,dB0_30)

# GR p2
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

B30 <- ea3sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B30=mean(plantC)) 
B15 <- ea2sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B15=mean(plantC))
B0  <- ea1sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB15_30 <- (B30$B30 - B15$B15)/B15$B15
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

GRp2gl_RelChange_0_15 <- data.frame(dNPP0_15,dB0_15)
GRp2gl_RelChange_15_30 <- data.frame(dNPP15_30,dB15_30)
GRp2gl_RelChange_0_30 <- data.frame(dNPP0_30,dB0_30)

# GR p3
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

B30 <- ea3sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B30=mean(plantC)) 
B15 <- ea2sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B15=mean(plantC))
B0  <- ea1sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB15_30 <- (B30$B30 - B15$B15)/B15$B15
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

GRp3gl_RelChange_0_15 <- data.frame(dNPP0_15,dB0_15)
GRp3gl_RelChange_15_30 <- data.frame(dNPP15_30,dB15_30)
GRp3gl_RelChange_0_30 <- data.frame(dNPP0_30,dB0_30)

fig1e_gr <- ggplot() + 
  geom_point(data=GRp1gl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='x1', shape='0-15%'),size=3) + 
  geom_point(data=GRp1gl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='x1', shape='0-30%'),size=3) + 
  geom_point(data=GRp2gl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='x2', shape='0-15%'),size=3) + 
  geom_point(data=GRp2gl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='x2', shape='0-30%'),size=3) + 
  geom_point(data=GRp3gl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='x3', shape='0-15%'),size=3) + 
  geom_point(data=GRp3gl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='x3', shape='0-30%'),size=3) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_shape_manual("Level of LUE", breaks = c("0-15%","0-30%"), 
                     values = c(16,17)) +  labs(x="dG/G", y="dB/B") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  scale_x_continuous(limits = c(0.0,0.5)) + 
  scale_y_continuous(limits = c(0.0,0.5)) +
  geom_abline(slope=1, intercept = 0.0, linetype="dashed")

fig1e_gr
```

### f) Relative change mortality vs. NPP

#### DBH
```{r, fig.width = 5, fig.height = 5}
# DBH 1
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

M30 <- ea3sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M30=mean(c_deadtrees+m_turnover)) 
M15 <- ea2sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M15=mean(c_deadtrees+m_turnover))
M0  <- ea1sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M0=mean(c_deadtrees+m_turnover))
dM0_15 <- (M15$M15 - M0$M0)/M0$M0
dM15_30 <- (M30$M30 - M15$M15)/M15$M15
dM0_30 <- (M30$M30 - M0$M0)/M0$M0

DBHp1gl_RelChange_0_15 <- data.frame(dNPP0_15,dM0_15)
DBHp1gl_RelChange_15_30 <- data.frame(dNPP15_30,dM15_30)
DBHp1gl_RelChange_0_30 <- data.frame(dNPP0_30,dM0_30)

# DBH p2
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

M30 <- ea3sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M30=mean(c_deadtrees+m_turnover)) 
M15 <- ea2sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M15=mean(c_deadtrees+m_turnover))
M0  <- ea1sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M0=mean(c_deadtrees+m_turnover))
dM0_15 <- (M15$M15 - M0$M0)/M0$M0
dM15_30 <- (M30$M30 - M15$M15)/M15$M15
dM0_30 <- (M30$M30 - M0$M0)/M0$M0

DBHp2gl_RelChange_0_15 <- data.frame(dNPP0_15,dM0_15)
DBHp2gl_RelChange_15_30 <- data.frame(dNPP15_30,dM15_30)
DBHp2gl_RelChange_0_30 <- data.frame(dNPP0_30,dM0_30)

# DBH p3
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

M30 <- ea3sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M30=mean(c_deadtrees+m_turnover)) 
M15 <- ea2sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M15=mean(c_deadtrees+m_turnover))
M0  <- ea1sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M0=mean(c_deadtrees+m_turnover))
dM0_15 <- (M15$M15 - M0$M0)/M0$M0
dM15_30 <- (M30$M30 - M15$M15)/M15$M15
dM0_30 <- (M30$M30 - M0$M0)/M0$M0

DBHp3gl_RelChange_0_15 <- data.frame(dNPP0_15,dM0_15)
DBHp3gl_RelChange_15_30 <- data.frame(dNPP15_30,dM15_30)
DBHp3gl_RelChange_0_30 <- data.frame(dNPP0_30,dM0_30)

fig1f_dbh <- ggplot() + 
  geom_point(data=DBHp1gl_RelChange_0_15, aes(x=dNPP0_15, y=dM0_15, color='x1', shape='0-15%'),size=3) + 
  geom_point(data=DBHp1gl_RelChange_0_30, aes(x=dNPP0_30, y=dM0_30, color='x1', shape='0-30%'),size=3) + 
  geom_point(data=DBHp2gl_RelChange_0_15, aes(x=dNPP0_15, y=dM0_15, color='x2', shape='0-15%'),size=3) + 
  geom_point(data=DBHp2gl_RelChange_0_30, aes(x=dNPP0_30, y=dM0_30, color='x2', shape='0-30%'),size=3) + 
  geom_point(data=DBHp3gl_RelChange_0_15, aes(x=dNPP0_15, y=dM0_15, color='x3', shape='0-15%'),size=3) + 
  geom_point(data=DBHp3gl_RelChange_0_30, aes(x=dNPP0_30, y=dM0_30, color='x3', shape='0-30%'),size=3) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_shape_manual("Level of LUE", breaks = c("0-15%","0-30%"), 
                     values = c(16,17)) +  labs(x="dG/G", y="dM/M") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  scale_x_continuous(limits = c(0,0.5)) + 
  scale_y_continuous(limits = c(0,0.5)) +
  geom_abline(slope=1, intercept = 0.0, linetype="dashed")

fig1f_dbh
```

#### GR
```{r, fig.width = 5, fig.height = 5}
# GR 1
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

M30 <- ea3sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M30=mean(c_deadtrees+m_turnover)) 
M15 <- ea2sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M15=mean(c_deadtrees+m_turnover))
M0  <- ea1sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M0=mean(c_deadtrees+m_turnover))
dM0_15 <- (M15$M15 - M0$M0)/M0$M0
dM15_30 <- (M30$M30 - M15$M15)/M15$M15
dM0_30 <- (M30$M30 - M0$M0)/M0$M0

GRp1gl_RelChange_0_15 <- data.frame(dNPP0_15,dM0_15)
GRp1gl_RelChange_15_30 <- data.frame(dNPP15_30,dM15_30)
GRp1gl_RelChange_0_30 <- data.frame(dNPP0_30,dM0_30)

# GR p2
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

M30 <- ea3sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M30=mean(c_deadtrees+m_turnover)) 
M15 <- ea2sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M15=mean(c_deadtrees+m_turnover))
M0  <- ea1sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M0=mean(c_deadtrees+m_turnover))
dM0_15 <- (M15$M15 - M0$M0)/M0$M0
dM15_30 <- (M30$M30 - M15$M15)/M15$M15
dM0_30 <- (M30$M30 - M0$M0)/M0$M0

GRp2gl_RelChange_0_15 <- data.frame(dNPP0_15,dM0_15)
GRp2gl_RelChange_15_30 <- data.frame(dNPP15_30,dM15_30)
GRp2gl_RelChange_0_30 <- data.frame(dNPP0_30,dM0_30)

# GR p3
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  #NPP or A_NPP
NPP15 <- ea2sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

M30 <- ea3sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M30=mean(c_deadtrees+m_turnover)) #plantC or A_Biomass
M15 <- ea2sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M15=mean(c_deadtrees+m_turnover))
M0  <- ea1sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M0=mean(c_deadtrees+m_turnover))
dM0_15 <- (M15$M15 - M0$M0)/M0$M0
dM15_30 <- (M30$M30 - M15$M15)/M15$M15
dM0_30 <- (M30$M30 - M0$M0)/M0$M0

GRp3gl_RelChange_0_15 <- data.frame(dNPP0_15,dM0_15)
GRp3gl_RelChange_15_30 <- data.frame(dNPP15_30,dM15_30)
GRp3gl_RelChange_0_30 <- data.frame(dNPP0_30,dM0_30)

fig1f_gr <- ggplot() + 
  geom_point(data=GRp1gl_RelChange_0_15, aes(x=dNPP0_15, y=dM0_15, color='x1', shape='0-15%'),size=3) + 
  geom_point(data=GRp1gl_RelChange_0_30, aes(x=dNPP0_30, y=dM0_30, color='x1', shape='0-30%'),size=3) + 
  geom_point(data=GRp2gl_RelChange_0_15, aes(x=dNPP0_15, y=dM0_15, color='x2', shape='0-15%'),size=3) + 
  geom_point(data=GRp2gl_RelChange_0_30, aes(x=dNPP0_30, y=dM0_30, color='x2', shape='0-30%'),size=3) + 
  geom_point(data=GRp3gl_RelChange_0_15, aes(x=dNPP0_15, y=dM0_15, color='x3', shape='0-15%'),size=3) + 
  geom_point(data=GRp3gl_RelChange_0_30, aes(x=dNPP0_30, y=dM0_30, color='x3', shape='0-30%'),size=3) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_shape_manual("Level of LUE", breaks = c("0-15%","0-30%"), 
                     values = c(16,17)) +  labs(x="dG/G", y="dM/M") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  scale_x_continuous(limits = c(0,0.5)) + 
  scale_y_continuous(limits = c(0,0.5)) +
  geom_abline(slope=1, intercept = 0.0, linetype="dashed")

fig1f_gr
```

### g) Relative change k vs. NPP
k is the turnover rate, i.e., the inverse of turnover time (tau) k=1/c_turnover_time. k can be also calcualted as k=(c_deadtrees+m_turnover)/plantC

#### DBH
```{r, fig.width = 5, fig.height = 5}
# DBH 1
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

k30 <- ea3sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k30=mean(1/c_turnover_time)) 
k15 <- ea2sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k15=mean(1/c_turnover_time))
k0  <- ea1sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k0=mean(1/c_turnover_time))
dk0_15 <- (k15$k15 - k0$k0)/k0$k0
dk15_30 <- (k30$k30 - k15$k15)/k15$k15
dk0_30 <- (k30$k30 - k0$k0)/k0$k0

DBHp1gl_RelChange_0_15 <- data.frame(dNPP0_15,dk0_15)
DBHp1gl_RelChange_15_30 <- data.frame(dNPP15_30,dk15_30)
DBHp1gl_RelChange_0_30 <- data.frame(dNPP0_30,dk0_30)

# DBH 2
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

k30 <- ea3sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k30=mean(1/c_turnover_time)) 
k15 <- ea2sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k15=mean(1/c_turnover_time))
k0  <- ea1sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k0=mean(1/c_turnover_time))
dk0_15 <- (k15$k15 - k0$k0)/k0$k0
dk15_30 <- (k30$k30 - k15$k15)/k15$k15
dk0_30 <- (k30$k30 - k0$k0)/k0$k0

DBHp2gl_RelChange_0_15 <- data.frame(dNPP0_15,dk0_15)
DBHp2gl_RelChange_15_30 <- data.frame(dNPP15_30,dk15_30)
DBHp2gl_RelChange_0_30 <- data.frame(dNPP0_30,dk0_30)

# DBH 3
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

k30 <- ea3sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k30=mean(1/c_turnover_time)) 
k15 <- ea2sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k15=mean(1/c_turnover_time))
k0  <- ea1sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k0=mean(1/c_turnover_time))
dk0_15 <- (k15$k15 - k0$k0)/k0$k0
dk15_30 <- (k30$k30 - k15$k15)/k15$k15
dk0_30 <- (k30$k30 - k0$k0)/k0$k0

DBHp3gl_RelChange_0_15 <- data.frame(dNPP0_15,dk0_15)
DBHp3gl_RelChange_15_30 <- data.frame(dNPP15_30,dk15_30)
DBHp3gl_RelChange_0_30 <- data.frame(dNPP0_30,dk0_30)

fig1g_dbh <- ggplot() + 
  geom_point(data=DBHp1gl_RelChange_0_15, aes(x=dNPP0_15, y=dk0_15, color='x1', shape='0-15%'),size=3) + 
  geom_point(data=DBHp1gl_RelChange_0_30, aes(x=dNPP0_30, y=dk0_30, color='x1', shape='0-30%'),size=3) + 
  geom_point(data=DBHp2gl_RelChange_0_15, aes(x=dNPP0_15, y=dk0_15, color='x2', shape='0-15%'),size=3) + 
  geom_point(data=DBHp2gl_RelChange_0_30, aes(x=dNPP0_30, y=dk0_30, color='x2', shape='0-30%'),size=3) + 
  geom_point(data=DBHp3gl_RelChange_0_15, aes(x=dNPP0_15, y=dk0_15, color='x3', shape='0-15%'),size=3) + 
  geom_point(data=DBHp3gl_RelChange_0_30, aes(x=dNPP0_30, y=dk0_30, color='x3', shape='0-30%'),size=3) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_shape_manual("Level of LUE", breaks = c("0-15%","0-30%"), 
                     values = c(16,17)) +  labs(x="dG/G", y="dk/k") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  scale_x_continuous(limits = c(0,0.50), breaks = seq(0,0.5,0.10)) + 
  scale_y_continuous(limits = c(0,0.16), breaks = seq(0,0.15,0.05)) + 
  geom_hline(yintercept =  0.0, linetype="dashed")

fig1g_dbh

ggplot() + 
  geom_point(data=DBHp1gl_RelChange_0_15, aes(x=dNPP0_15, y=dk0_15, color='x1', shape='0-15%'),size=3) + 
  geom_point(data=DBHp1gl_RelChange_0_30, aes(x=dNPP0_30, y=dk0_30, color='x1', shape='0-30%'),size=3) + 
  geom_point(data=DBHp2gl_RelChange_0_15, aes(x=dNPP0_15, y=dk0_15, color='x2', shape='0-15%'),size=3) + 
  geom_point(data=DBHp2gl_RelChange_0_30, aes(x=dNPP0_30, y=dk0_30, color='x2', shape='0-30%'),size=3) + 
  geom_point(data=DBHp3gl_RelChange_0_15, aes(x=dNPP0_15, y=dk0_15, color='x3', shape='0-15%'),size=3) + 
  geom_point(data=DBHp3gl_RelChange_0_30, aes(x=dNPP0_30, y=dk0_30, color='x3', shape='0-30%'),size=3) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_shape_manual("Level of LUE", breaks = c("0-15%","0-30%"), 
                     values = c(16,17)) +  labs(x="dG/G", y="dk/k") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "none",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  scale_x_continuous(limits = c(0,0.50), breaks = seq(0,0.5,0.10)) + 
  scale_y_continuous(limits = c(0,0.16), breaks = seq(0,0.15,0.05)) + 
  geom_hline(yintercept =  0.0, linetype="dashed")
```

#### GR
```{r, fig.width = 5, fig.height = 5}
# GR 1
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

k30 <- ea3sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k30=mean(1/c_turnover_time)) 
k15 <- ea2sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k15=mean(1/c_turnover_time))
k0  <- ea1sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k0=mean(1/c_turnover_time))
dk0_15 <- (k15$k15 - k0$k0)/k0$k0
dk15_30 <- (k30$k30 - k15$k15)/k15$k15
dk0_30 <- (k30$k30 - k0$k0)/k0$k0

GRp1gl_RelChange_0_15 <- data.frame(dNPP0_15,dk0_15)
GRp1gl_RelChange_15_30 <- data.frame(dNPP15_30,dk15_30)
GRp1gl_RelChange_0_30 <- data.frame(dNPP0_30,dk0_30)

# GR 2
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

k30 <- ea3sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k30=mean(1/c_turnover_time)) 
k15 <- ea2sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k15=mean(1/c_turnover_time))
k0  <- ea1sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k0=mean(1/c_turnover_time))
dk0_15 <- (k15$k15 - k0$k0)/k0$k0
dk15_30 <- (k30$k30 - k15$k15)/k15$k15
dk0_30 <- (k30$k30 - k0$k0)/k0$k0

GRp2gl_RelChange_0_15 <- data.frame(dNPP0_15,dk0_15)
GRp2gl_RelChange_15_30 <- data.frame(dNPP15_30,dk15_30)
GRp2gl_RelChange_0_30 <- data.frame(dNPP0_30,dk0_30)

# NSC 3
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

k30 <- ea3sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k30=mean(1/c_turnover_time)) 
k15 <- ea2sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k15=mean(1/c_turnover_time))
k0  <- ea1sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k0=mean(1/c_turnover_time))
dk0_15 <- (k15$k15 - k0$k0)/k0$k0
dk15_30 <- (k30$k30 - k15$k15)/k15$k15
dk0_30 <- (k30$k30 - k0$k0)/k0$k0

GRp3gl_RelChange_0_15 <- data.frame(dNPP0_15,dk0_15)
GRp3gl_RelChange_15_30 <- data.frame(dNPP15_30,dk15_30)
GRp3gl_RelChange_0_30 <- data.frame(dNPP0_30,dk0_30)

fig1g_gr <- ggplot() + 
  geom_point(data=GRp1gl_RelChange_0_15, aes(x=dNPP0_15, y=dk0_15, color='x1', shape='0-15%'),size=3) + 
  geom_point(data=GRp1gl_RelChange_0_30, aes(x=dNPP0_30, y=dk0_30, color='x1', shape='0-30%'),size=3) + 
  geom_point(data=GRp2gl_RelChange_0_15, aes(x=dNPP0_15, y=dk0_15, color='x2', shape='0-15%'),size=3) + 
  geom_point(data=GRp2gl_RelChange_0_30, aes(x=dNPP0_30, y=dk0_30, color='x2', shape='0-30%'),size=3) + 
  geom_point(data=GRp3gl_RelChange_0_15, aes(x=dNPP0_15, y=dk0_15, color='x3', shape='0-15%'),size=3) + 
  geom_point(data=GRp3gl_RelChange_0_30, aes(x=dNPP0_30, y=dk0_30, color='x3', shape='0-30%'),size=3) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_shape_manual("Level of LUE", breaks = c("0-15%","0-30%"), 
                     values = c(16,17)) +  labs(x="dG/G", y="dk/k") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  scale_x_continuous(limits = c(0,0.50), breaks = seq(0,0.5,0.10)) + 
  scale_y_continuous(limits = c(0,0.015), breaks = seq(0,0.015,0.005)) +
  geom_hline(yintercept =  0.0, linetype="dashed")

fig1g_gr
```

### g*) Carbon Turnover time vs. time
Plot c_turnover_time or plantC/NPP

#### DBH 
```{r, fig.width = 5, fig.height = 5}
fig1gg_dbh <- ggplot() +  
  geom_line(data=ea1sa1DBHp1gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x1', linetype='Control'),alpha=.7) + 
  geom_line(data=ea1sa1DBHp2gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x2', linetype='Control'),alpha=.7) +
  geom_line(data=ea1sa1DBHp3gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x3', linetype='Control'),alpha=.7) +
  geom_line(data=ea2sa1DBHp1gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x1', linetype='+15%'),alpha=.7) + 
  geom_line(data=ea2sa1DBHp2gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x2', linetype='+15%'),alpha=.7) +
  geom_line(data=ea2sa1DBHp3gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x3', linetype='+15%'),alpha=.7) +
  geom_line(data=ea3sa1DBHp1gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x1', linetype='+30%'),alpha=.7) + 
  geom_line(data=ea3sa1DBHp2gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x2', linetype='+30%'),alpha=.7) +
  geom_line(data=ea3sa1DBHp3gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x3', linetype='+30%'),alpha=.7) +
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","longdash","solid")) +
  labs(x = "Year", y = expression(paste("Carbon turnover time ( ", tau, " , ", yr, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  scale_x_continuous(limits = c(470,1500), breaks = seq(500,1500,500)) + 
  scale_y_continuous(limits = c(0,30), breaks = seq(0,30,10))

fig1ggg_dbh <- ggplot() + 
  geom_line(data=ea1sa1DBHp1gl_out_annual_tile, aes(x=year, y=plantC/(c_deadtrees+m_turnover), color='x1', linetype='Control'),alpha=.7) + 
  geom_line(data=ea1sa1DBHp2gl_out_annual_tile, aes(x=year, y=plantC/(c_deadtrees+m_turnover), color='x2', linetype='Control'),alpha=.7) +
  geom_line(data=ea1sa1DBHp3gl_out_annual_tile, aes(x=year, y=plantC/(c_deadtrees+m_turnover), color='x3', linetype='Control'),alpha=.7) +
  geom_line(data=ea2sa1DBHp1gl_out_annual_tile, aes(x=year, y=plantC/(c_deadtrees+m_turnover), color='x1', linetype='+15%'),alpha=.7) + 
  geom_line(data=ea2sa1DBHp2gl_out_annual_tile, aes(x=year, y=plantC/(c_deadtrees+m_turnover), color='x2', linetype='+15%'),alpha=.7) +
  geom_line(data=ea2sa1DBHp3gl_out_annual_tile, aes(x=year, y=plantC/(c_deadtrees+m_turnover), color='x3', linetype='+15%'),alpha=.7) +
  geom_line(data=ea3sa1DBHp1gl_out_annual_tile, aes(x=year, y=plantC/(c_deadtrees+m_turnover), color='x1', linetype='+30%'),alpha=.7) + 
  geom_line(data=ea3sa1DBHp2gl_out_annual_tile, aes(x=year, y=plantC/(c_deadtrees+m_turnover), color='x2', linetype='+30%'),alpha=.7) +
  geom_line(data=ea3sa1DBHp3gl_out_annual_tile, aes(x=year, y=plantC/(c_deadtrees+m_turnover), color='x3', linetype='+30%'),alpha=.7) +
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","longdash","solid")) +
  labs(x = "Year", y = expression(paste("Carbon turnover time ( ", tau, " , ", yr, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 

fig1gg_dbh
fig1ggg_dbh
```

#### GR 
```{r, fig.width = 5, fig.height = 5}
fig1gg_gr <- ggplot() + 
  geom_line(data=ea1sa1GRp1gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x1', linetype='Control'),alpha=.7) + 
  geom_line(data=ea1sa1GRp2gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x2', linetype='Control'),alpha=.7) +
  geom_line(data=ea1sa1GRp3gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x3', linetype='Control'),alpha=.7) +
  geom_line(data=ea2sa1GRp1gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x1', linetype='+15%'),alpha=.7) + 
  geom_line(data=ea2sa1GRp2gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x2', linetype='+15%'),alpha=.7) +
  geom_line(data=ea2sa1GRp3gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x3', linetype='+15%'),alpha=.7) +
  geom_line(data=ea3sa1GRp1gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x1', linetype='+30%'),alpha=.7) + 
  geom_line(data=ea3sa1GRp2gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x2', linetype='+30%'),alpha=.7) +
  geom_line(data=ea3sa1GRp3gl_out_annual_tile, aes(x=year, y=plantC/NPP, color='x3', linetype='+30%'),alpha=.7) +
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","longdash","solid")) +
  labs(x = "Year", y = expression(paste("Carbon turnover time ( ", tau, " , ", yr, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  scale_x_continuous(limits = c(470,1500), breaks = seq(500,1500,500)) + 
  scale_y_continuous(limits = c(0,30), breaks = seq(0,30,10))

fig1gg_gr
```

### h) Relative longevity vs. growth rates

Hypothesis: The negative relationship between longevity vs. growth rates arises from variations between (across) species, but disappears when looking at variations between sites (within sps).

Two plots:

- Different species at a given site: x = growth rate, y = longevity (or 1/mortality). Each point is one species (differing by wood density, root:shoot ratio). Add info either by using color ~site (given LUE, growing season length, PAR); or by combining data from multiple sites and normalizing growth rates and longevity by site-level mean.
- Same species at different sites (differing by LUE, growing season length, PAR): x = growth rate, y = longevity. Each point is one site (show mean and standard deviations with x and y errorbars)

- longevity is maximum age at tile-level, plot mean across multiple years after spinup
- plot change in DBH instead of NPP. Take the oldest cohort, and calculate DBH/age

#### DBH
```{r, fig.width = 5, fig.height = 5}

# DBH p1
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

L30 <- ea3sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L30=mean(MaxAge))
L15 <- ea2sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L15=mean(MaxAge))
L0  <- ea1sa1DBHp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L0=mean(MaxAge))
dL0_15 <- (L15$L15 - L0$L0)/L0$L0
dL15_30 <- (L30$L30 - L15$L15)/L15$L15
dL0_30 <- (L30$L30 - L0$L0)/L0$L0

DBHp1gl_RelChange_0_15 <- data.frame(dNPP0_15,dL0_15)
DBHp1gl_RelChange_15_30 <- data.frame(dNPP15_30,dL15_30)
DBHp1gl_RelChange_0_30 <- data.frame(dNPP0_30,dL0_30)

# DBH p2
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

L30 <- ea3sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L30=mean(MaxAge))
L15 <- ea2sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L15=mean(MaxAge))
L0  <- ea1sa1DBHp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L0=mean(MaxAge))
dL0_15 <- (L15$L15 - L0$L0)/L0$L0
dL15_30 <- (L30$L30 - L15$L15)/L15$L15
dL0_30 <- (L30$L30 - L0$L0)/L0$L0

DBHp2gl_RelChange_0_15 <- data.frame(dNPP0_15,dL0_15)
DBHp2gl_RelChange_15_30 <- data.frame(dNPP15_30,dL15_30)
DBHp2gl_RelChange_0_30 <- data.frame(dNPP0_30,dL0_30)

# DBH p3
NPP30 <- ea3sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

L30 <- ea3sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L30=mean(MaxAge))
L15 <- ea2sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L15=mean(MaxAge))
L0  <- ea1sa1DBHp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L0=mean(MaxAge))
dL0_15 <- (L15$L15 - L0$L0)/L0$L0
dL15_30 <- (L30$L30 - L15$L15)/L15$L15
dL0_30 <- (L30$L30 - L0$L0)/L0$L0

DBHp3gl_RelChange_0_15 <- data.frame(dNPP0_15,dL0_15)
DBHp3gl_RelChange_15_30 <- data.frame(dNPP15_30,dL15_30)
DBHp3gl_RelChange_0_30 <- data.frame(dNPP0_30,dL0_30)

fig1h_dbh <- ggplot() + 
  geom_point(data=DBHp1gl_RelChange_0_15, aes(x=dNPP0_15, y=dL0_15, color='x1', shape='0-15%'),size=3) + 
  geom_point(data=DBHp1gl_RelChange_0_30, aes(x=dNPP0_30, y=dL0_30, color='x1', shape='0-30%'),size=3) + 
  geom_point(data=DBHp2gl_RelChange_0_15, aes(x=dNPP0_15, y=dL0_15, color='x2', shape='0-15%'),size=3) + 
  geom_point(data=DBHp2gl_RelChange_0_30, aes(x=dNPP0_30, y=dL0_30, color='x2', shape='0-30%'),size=3) + 
  geom_point(data=DBHp3gl_RelChange_0_15, aes(x=dNPP0_15, y=dL0_15, color='x3', shape='0-15%'),size=3) + 
  geom_point(data=DBHp3gl_RelChange_0_30, aes(x=dNPP0_30, y=dL0_30, color='x3', shape='0-30%'),size=3) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_shape_manual("Level of LUE", breaks = c("0-15%","0-30%"), 
                     values = c(16,17)) +  labs(x="dG/G", y="dL/L") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  scale_x_continuous(limits = c(0,0.50), breaks = seq(0,0.5,0.10)) + 
  scale_y_continuous(limits = c(-0.15,0), breaks = seq(-0.15,0,0.05)) +
  geom_hline(yintercept =  0.0, linetype="dashed")

fig1h_dbh
```

#### GR
```{r, fig.width = 5, fig.height = 5}
# GR p1
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

L30 <- ea3sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L30=mean(MaxAge))
L15 <- ea2sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L15=mean(MaxAge))
L0  <- ea1sa1GRp1gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L0=mean(MaxAge))
dL0_15 <- (L15$L15 - L0$L0)/L0$L0
dL15_30 <- (L30$L30 - L15$L15)/L15$L15
dL0_30 <- (L30$L30 - L0$L0)/L0$L0

GRp1gl_RelChange_0_15 <- data.frame(dNPP0_15,dL0_15)
GRp1gl_RelChange_15_30 <- data.frame(dNPP15_30,dL15_30)
GRp1gl_RelChange_0_30 <- data.frame(dNPP0_30,dL0_30)

# GR p2
# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea3sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

L30 <- ea3sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L30=mean(MaxAge))
L15 <- ea2sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L15=mean(MaxAge))
L0  <- ea1sa1GRp2gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L0=mean(MaxAge))
dL0_15 <- (L15$L15 - L0$L0)/L0$L0
dL15_30 <- (L30$L30 - L15$L15)/L15$L15
dL0_30 <- (L30$L30 - L0$L0)/L0$L0

GRp2gl_RelChange_0_15 <- data.frame(dNPP0_15,dL0_15)
GRp2gl_RelChange_15_30 <- data.frame(dNPP15_30,dL15_30)
GRp2gl_RelChange_0_30 <- data.frame(dNPP0_30,dL0_30)

# DBH p3
NPP30 <- ea3sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  
NPP15 <- ea2sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

L30 <- ea3sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L30=mean(MaxAge))
L15 <- ea2sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L15=mean(MaxAge))
L0  <- ea1sa1GRp3gl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L0=mean(MaxAge))
dL0_15 <- (L15$L15 - L0$L0)/L0$L0
dL15_30 <- (L30$L30 - L15$L15)/L15$L15
dL0_30 <- (L30$L30 - L0$L0)/L0$L0

GRp3gl_RelChange_0_15 <- data.frame(dNPP0_15,dL0_15)
GRp3gl_RelChange_15_30 <- data.frame(dNPP15_30,dL15_30)
GRp3gl_RelChange_0_30 <- data.frame(dNPP0_30,dL0_30)

fig1h_gr <- ggplot() + 
  geom_point(data=GRp1gl_RelChange_0_15, aes(x=dNPP0_15, y=dL0_15, color='x1', shape='0-15%'),size=3) + 
  geom_point(data=GRp1gl_RelChange_0_30, aes(x=dNPP0_30, y=dL0_30, color='x1', shape='0-30%'),size=3) + 
  geom_point(data=GRp2gl_RelChange_0_15, aes(x=dNPP0_15, y=dL0_15, color='x2', shape='0-15%'),size=3) + 
  geom_point(data=GRp2gl_RelChange_0_30, aes(x=dNPP0_30, y=dL0_30, color='x2', shape='0-30%'),size=3) + 
  geom_point(data=GRp3gl_RelChange_0_15, aes(x=dNPP0_15, y=dL0_15, color='x3', shape='0-15%'),size=3) + 
  geom_point(data=GRp3gl_RelChange_0_30, aes(x=dNPP0_30, y=dL0_30, color='x3', shape='0-30%'),size=3) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_shape_manual("Level of LUE", breaks = c("0-15%","0-30%"), 
                     values = c(16,17)) +  labs(x="dG/G", y="dL/L") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  scale_x_continuous(limits = c(0,0.50), breaks = seq(0,0.5,0.10)) + 
  scale_y_continuous(limits = c(-0.05,0), breaks = seq(-0.05,0,0.01)) +
  geom_hline(yintercept =  0.0, linetype="dashed")

fig1h_gr
```

### i) Self-thinning relationship

From annual_tile_output: QMD and Density12

#### DBH 
```{r, fig.width = 7, fig.height = 5}
fig2a_dbh <- ggplot() + 
  geom_point(data= subset(ea1sa1DBHp1gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_point(data=subset(ea2sa1DBHp1gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_point(data=subset(ea3sa1DBHp1gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_smooth(data= subset(ea1sa1DBHp1gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='Control'),col="#009E73",
              method = "lm",fullrange = T) + 
  geom_smooth(data= subset(ea2sa1DBHp1gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='+15%'),col="#009E73",
              method = "lm",fullrange = T) +
  geom_smooth(data= subset(ea3sa1DBHp1gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='+30%'),col="#009E73",
              method = "lm",fullrange = T) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + ggtitle("a)") + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2a_dbh

fig2b_dbh <- ggplot() + 
  geom_point(data= subset(ea1sa1DBHp2gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_point(data=subset(ea2sa1DBHp2gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_point(data=subset(ea3sa1DBHp2gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_smooth(data= subset(ea1sa1DBHp2gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='Control'),col="#0072B2",
              method = "lm",fullrange = T) + 
  geom_smooth(data= subset(ea2sa1DBHp2gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='+15%'),col="#0072B2",
              method = "lm",fullrange = T) +
  geom_smooth(data= subset(ea3sa1DBHp2gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='+30%'),col="#0072B2",
              method = "lm",fullrange = T) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + ggtitle("b)") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2b_dbh

fig2c_dbh <- ggplot() + 
  geom_point(data= subset(ea1sa1DBHp3gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_point(data=subset(ea2sa1DBHp3gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_point(data=subset(ea3sa1DBHp3gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_smooth(data= subset(ea1sa1DBHp3gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='Control'),col="#D55E00",
              method = "lm",fullrange = T) + 
  geom_smooth(data= subset(ea2sa1DBHp3gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='+15%'),col="#D55E00",
              method = "lm",fullrange = T) +
  geom_smooth(data= subset(ea3sa1DBHp3gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='+30%'),col="#D55E00",
              method = "lm",fullrange = T) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + ggtitle("c)") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2c_dbh
```

##### DBH p1 
```{r}

ea1sa1DBHp1gl_out_annual_tile <- ea1sa1DBHp1gl_out_annual_tile %>% 
  mutate(Mortality = "DBH") %>% 
  mutate(Parameter = "p1") %>% 
  mutate(LUE = "Control")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea1sa1DBHp1gl_out_annual_tile$NPP_kg_ha_year <- ea1sa1DBHp1gl_out_annual_tile$NPP * 10000

data_DBH_ea1p1 <- ea1sa1DBHp1gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_DBH_ea1p1$QMD_bins))
max(data_DBH_ea1p1$NPP_kg_ha_year)

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_DBH_ea1p1 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_DBH_ea1p1 <- data_DBH_ea1p1 %>% left_join(quantileX)
data_DBH_ea1p1Den <- data_DBH_ea1p1 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_DBH_ea1p1Rest <- data_DBH_ea1p1 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

ea2sa1DBHp1gl_out_annual_tile <- ea2sa1DBHp1gl_out_annual_tile %>%
  mutate(Mortality = "DBH") %>% 
  mutate(Parameter = "p1") %>% 
  mutate(LUE = "+15%")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea2sa1DBHp1gl_out_annual_tile$NPP_kg_ha_year <- ea2sa1DBHp1gl_out_annual_tile$NPP * 10000

data_DBH_ea2p1 <- ea2sa1DBHp1gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_DBH_ea2p1$QMD_bins))

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_DBH_ea2p1 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_DBH_ea2p1 <- data_DBH_ea2p1 %>% left_join(quantileX)
data_DBH_ea2p1Den <- data_DBH_ea2p1 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_DBH_ea2p1Rest <- data_DBH_ea2p1 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

ea3sa1DBHp1gl_out_annual_tile <- ea3sa1DBHp1gl_out_annual_tile %>% 
  mutate(Mortality = "DBH") %>% 
  mutate(Parameter = "p1") %>% 
  mutate(LUE = "+30%")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea3sa1DBHp1gl_out_annual_tile$NPP_kg_ha_year <- ea3sa1DBHp1gl_out_annual_tile$NPP * 10000

data_DBH_ea3p1 <- ea3sa1DBHp1gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_DBH_ea3p1$QMD_bins))

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_DBH_ea3p1 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_DBH_ea3p1 <- data_DBH_ea3p1 %>% left_join(quantileX)
data_DBH_ea3p1Den <- data_DBH_ea3p1 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_DBH_ea3p1Rest <- data_DBH_ea3p1 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

data_DBH_p1 <- rbind(data_DBH_ea1p1, data_DBH_ea2p1, data_DBH_ea3p1) 
data_DBH_p1Den <- rbind(data_DBH_ea1p1Den, data_DBH_ea2p1Den, data_DBH_ea3p1Den) 
data_DBH_p1Rest <- rbind(data_DBH_ea1p1Rest, data_DBH_ea2p1Rest, data_DBH_ea3p1Rest) 

data_DBH_p1Den <- data_DBH_p1Den %>% mutate(logDensity12=log(Density12),logQMD=log(QMD))
data_DBH_p1Rest <- data_DBH_p1Rest %>% mutate(logDensity12=log(Density12),logQMD=log(QMD))

ggplot() + 
  geom_point(data = data_DBH_p1, aes(x = log(QMD), y = log(Density12)), color="blue") +
  geom_point(data = data_DBH_p1Den, aes(x = log(QMD), y = log(Density12)), color="red") 

FitRes = lm(log(NPP_kg_ha_year) ~ QMD, data = data_DBH_p1Den, na.action = "na.exclude")
summary(FitRes)
plot(FitRes)
Res_NPP <- residuals(FitRes)
Fitted_NPP <- fitted(FitRes)
data_DBH_p1Den$Res_NPP <- Res_NPP

### STL model
#### as LUE change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * LUE, data = data_DBH_p1Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + LUE, data = data_DBH_p1Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDNoInter))
fig2aLUE_dbh <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","LUE"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "Level of LUE",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_DBH_p2Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2aLUE_dbh

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "LUE"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2aLUE_dbh <- ggplot() + 
  geom_point(data = data_DBH_p1Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#009E73",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2aLUE_dbh

#### as NPP change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * scale(NPP_kg_ha_year), data = data_DBH_p1Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + scale(NPP_kg_ha_year), data = data_DBH_p1Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDInter))
fig2aNPP_dbh <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","NPP_kg_ha_year[15000,17500,20000]"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "Level of NPP",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_DBH_p2Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2aNPP_dbh

hist(data_DBH_p1Den$NPP_kg_ha_year)

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "NPP[1.45,1.75,2.05]"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2aNPP_dbh <- ggplot() + 
  geom_point(data = data_DBH_p1Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#009E73",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "NPP", linetype = "NPP") + 
  scale_linetype_manual("NPP", breaks = c("1.45","1.75", "2.05"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2aNPP_dbh

#### as NPP Residuals change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * scale(Res_NPP), data = data_DBH_p1Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + scale(Res_NPP), data = data_DBH_p1Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDInter))
# Analysis of residuals
ResG <- residuals(Fit_QMDInter)
FittedG <- fitted(Fit_QMDInter)
par(mfrow=c(2,2))
plot(ResG ~ FittedG, xlab="Fitted values", ylab="Residuals", main="Residuals vs. fitted")
abline(h=0) ## Homocedasticity
plot(data_DBH_p1Den$logDensity12 ~ FittedG, xlab="FittedG", ylab="TreesPerHectareAHC1_2", main = "xyplot")
abline(0, 1) 
hist(ResG, main="Histogram of residuals", xlab="Residuals") ## Normality
boxplot(ResG,ylab = "Residuals")

fig2aRes_dbh <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","Res_NPP[-0.2, 0, 0.2]"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "Res_NPP",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_DBH_p2Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2aRes_dbh

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "Res_NPP[-0.2, 0, 0.2]"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2aRes_dbh <- ggplot() + 
  geom_point(data = data_DBH_p1Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#009E73",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Res_NPP", linetype = "Res_NPP") + 
  scale_linetype_manual("Res_NPP", breaks = c("-0.2","0", "0.2"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2aRes_dbh

```

##### DBH p2 
```{r}

ea1sa1DBHp2gl_out_annual_tile <- ea1sa1DBHp2gl_out_annual_tile %>% 
  mutate(Mortality = "DBH") %>% 
  mutate(Parameter = "p2") %>% 
  mutate(LUE = "Control")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea1sa1DBHp2gl_out_annual_tile$NPP_kg_ha_year <- ea1sa1DBHp2gl_out_annual_tile$NPP * 10000

data_DBH_ea1p2 <- ea1sa1DBHp2gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_DBH_ea1p2$QMD_bins))
max(data_DBH_ea1p2$NPP_kg_ha_year)

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_DBH_ea1p2 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_DBH_ea1p2 <- data_DBH_ea1p2 %>% left_join(quantileX)
data_DBH_ea1p2Den <- data_DBH_ea1p2 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_DBH_ea1p2Rest <- data_DBH_ea1p2 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

ea2sa1DBHp2gl_out_annual_tile <- ea2sa1DBHp2gl_out_annual_tile %>%
  mutate(Mortality = "DBH") %>% 
  mutate(Parameter = "p2") %>% 
  mutate(LUE = "+15%")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea2sa1DBHp2gl_out_annual_tile$NPP_kg_ha_year <- ea2sa1DBHp2gl_out_annual_tile$NPP * 10000

data_DBH_ea2p2 <- ea2sa1DBHp2gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_DBH_ea2p2$QMD_bins))

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_DBH_ea2p2 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_DBH_ea2p2 <- data_DBH_ea2p2 %>% left_join(quantileX)
data_DBH_ea2p2Den <- data_DBH_ea2p2 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_DBH_ea2p2Rest <- data_DBH_ea2p2 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

ea3sa1DBHp2gl_out_annual_tile <- ea3sa1DBHp2gl_out_annual_tile %>% 
  mutate(Mortality = "DBH") %>% 
  mutate(Parameter = "p2") %>% 
  mutate(LUE = "+30%")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea3sa1DBHp2gl_out_annual_tile$NPP_kg_ha_year <- ea3sa1DBHp2gl_out_annual_tile$NPP * 10000

data_DBH_ea3p2 <- ea3sa1DBHp2gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_DBH_ea3p2$QMD_bins))

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_DBH_ea3p2 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_DBH_ea3p2 <- data_DBH_ea3p2 %>% left_join(quantileX)
data_DBH_ea3p2Den <- data_DBH_ea3p2 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_DBH_ea3p2Rest <- data_DBH_ea3p2 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

data_DBH_p2 <- rbind(data_DBH_ea1p2, data_DBH_ea2p2, data_DBH_ea3p2) 
data_DBH_p2Den <- rbind(data_DBH_ea1p2Den, data_DBH_ea2p2Den, data_DBH_ea3p2Den) 
data_DBH_p2Rest <- rbind(data_DBH_ea1p2Rest, data_DBH_ea2p2Rest, data_DBH_ea3p2Rest) 

data_DBH_p2Den <- data_DBH_p2Den %>% mutate(logDensity12=log(Density12),logQMD=log(QMD))
data_DBH_p2Rest <- data_DBH_p2Rest %>% mutate(logDensity12=log(Density12),logQMD=log(QMD))

ggplot() + 
  geom_point(data = data_DBH_p2, aes(x = log(QMD), y = log(Density12)), color="blue") +
  geom_point(data = data_DBH_p2Den, aes(x = log(QMD), y = log(Density12)), color="red") 

FitRes = lm(log(NPP_kg_ha_year) ~ QMD, data = data_DBH_p2Den, na.action = "na.exclude")
summary(FitRes)
plot(FitRes)
Res_NPP <- residuals(FitRes)
Fitted_NPP <- fitted(FitRes)
data_DBH_p2Den$Res_NPP <- Res_NPP

### STL model
#### as LUE change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * LUE, data = data_DBH_p2Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + LUE, data = data_DBH_p2Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDNoInter))
fig2bLUE_dbh <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","LUE"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "LUE",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_DBH_p2Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2bLUE_dbh

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "LUE"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2bLUE_dbh <- ggplot() + 
  geom_point(data = data_DBH_p2Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#0072B2",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2bLUE_dbh

#### as NPP change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * scale(NPP), data = data_DBH_p2Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + scale(NPP), data = data_DBH_p2Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDInter))
fig2bNPP_dbh <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","NPP[1.45,1.75,2.05]"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "NPP",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_DBH_p2Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2bNPP_dbh

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "NPP[1.45,1.75,2.05]"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2bNPP_dbh <- ggplot() + 
  geom_point(data = data_DBH_p2Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#0072B2",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "NPP", linetype = "NPP") + 
  scale_linetype_manual("NPP", breaks = c("1.45","1.75", "2.05"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2bNPP_dbh

#### as NPP Residuals change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * scale(Res_NPP), data = data_DBH_p2Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + scale(Res_NPP), data = data_DBH_p2Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDInter))
# Analysis of residuals
ResG <- residuals(Fit_QMDInter)
FittedG <- fitted(Fit_QMDInter)
par(mfrow=c(2,2))
plot(ResG ~ FittedG, xlab="Fitted values", ylab="Residuals", main="Residuals vs. fitted")
abline(h=0) ## Homocedasticity
plot(data_DBH_p2Den$logDensity12 ~ FittedG, xlab="FittedG", ylab="TreesPerHectareAHC1_2", main = "xyplot")
abline(0, 1) 
hist(ResG, main="Histogram of residuals", xlab="Residuals") ## Normality
boxplot(ResG,ylab = "Residuals")

fig2bRes_dbh <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","Res_NPP[-0.2, 0, 0.2]"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "Res_NPP",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_DBH_p2Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2bRes_dbh

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "Res_NPP[-0.2, 0, 0.2]"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2bRes_dbh <- ggplot() + 
  geom_point(data = data_DBH_p3Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#0072B2",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Res_NPP", linetype = "Res_NPP") + 
  scale_linetype_manual("Res_NPP", breaks = c("-0.2","0", "0.2"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2bRes_dbh

```

##### DBH p3
```{r}

ea1sa1DBHp3gl_out_annual_tile <- ea1sa1DBHp3gl_out_annual_tile %>% 
  mutate(Mortality = "DBH") %>% 
  mutate(Parameter = "p3") %>% 
  mutate(LUE = "Control")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea1sa1DBHp3gl_out_annual_tile$NPP_kg_ha_year <- ea1sa1DBHp3gl_out_annual_tile$NPP * 10000

data_DBH_ea1p3 <- ea1sa1DBHp3gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_DBH_ea1p3$QMD_bins))
max(data_DBH_ea1p3$NPP_kg_ha_year)

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_DBH_ea1p3 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_DBH_ea1p3 <- data_DBH_ea1p3 %>% left_join(quantileX)
data_DBH_ea1p3Den <- data_DBH_ea1p3 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_DBH_ea1p3Rest <- data_DBH_ea1p3 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

ea2sa1DBHp3gl_out_annual_tile <- ea2sa1DBHp3gl_out_annual_tile %>%
  mutate(Mortality = "DBH") %>% 
  mutate(Parameter = "p3") %>% 
  mutate(LUE = "+15%")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea2sa1DBHp3gl_out_annual_tile$NPP_kg_ha_year <- ea2sa1DBHp3gl_out_annual_tile$NPP * 10000

data_DBH_ea2p3 <- ea2sa1DBHp3gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_DBH_ea2p3$QMD_bins))

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_DBH_ea2p3 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_DBH_ea2p3 <- data_DBH_ea2p3 %>% left_join(quantileX)
data_DBH_ea2p3Den <- data_DBH_ea2p3 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_DBH_ea2p3Rest <- data_DBH_ea2p3 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

ea3sa1DBHp3gl_out_annual_tile <- ea3sa1DBHp3gl_out_annual_tile %>% 
  mutate(Mortality = "DBH") %>% 
  mutate(Parameter = "p3") %>% 
  mutate(LUE = "+30%")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea3sa1DBHp3gl_out_annual_tile$NPP_kg_ha_year <- ea3sa1DBHp3gl_out_annual_tile$NPP * 10000

data_DBH_ea3p3 <- ea3sa1DBHp3gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_DBH_ea3p3$QMD_bins))

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_DBH_ea3p3 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_DBH_ea3p3 <- data_DBH_ea3p3 %>% left_join(quantileX)
data_DBH_ea3p3Den <- data_DBH_ea3p3 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_DBH_ea3p3Rest <- data_DBH_ea3p3 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

data_DBH_p3 <- rbind(data_DBH_ea1p3, data_DBH_ea2p3, data_DBH_ea3p3) 
data_DBH_p3Den <- rbind(data_DBH_ea1p3Den, data_DBH_ea2p3Den, data_DBH_ea3p3Den) 
data_DBH_p3Rest <- rbind(data_DBH_ea1p3Rest, data_DBH_ea2p3Rest, data_DBH_ea3p3Rest) 

data_DBH_p3Den <- data_DBH_p3Den %>% mutate(logDensity12=log(Density12),logQMD=log(QMD))
data_DBH_p3Rest <- data_DBH_p3Rest %>% mutate(logDensity12=log(Density12),logQMD=log(QMD))

ggplot() + 
  geom_point(data = data_DBH_p3, aes(x = log(QMD), y = log(Density12)), color="blue") +
  geom_point(data = data_DBH_p3Den, aes(x = log(QMD), y = log(Density12)), color="red") 

FitRes = lm(log(NPP_kg_ha_year) ~ QMD, data = data_DBH_p3Den, na.action = "na.exclude")
summary(FitRes)
plot(FitRes)
Res_NPP <- residuals(FitRes)
Fitted_NPP <- fitted(FitRes)
data_DBH_p3Den$Res_NPP <- Res_NPP

### STL model
#### as LUE change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * LUE, data = data_DBH_p3Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + LUE, data = data_DBH_p3Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDNoInter))
fig2cLUE_dbh <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","LUE"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "LUE",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_DBH_p3Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2cLUE_dbh

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "LUE"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2cLUE_dbh <- ggplot() + 
  geom_point(data = data_DBH_p3Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#D55E00",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2cLUE_dbh

#### as NPP change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * scale(NPP), data = data_DBH_p3Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + scale(NPP), data = data_DBH_p3Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDInter))
fig2cNPP_dbh <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","NPP[1.45,1.75,2.00]"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "NPP",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_DBH_p3Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2cNPP_dbh

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "NPP[1.45,1.75,2.05]"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2cNPP_dbh <- ggplot() + 
  geom_point(data = data_DBH_p3Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#D55E00",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "NPP", linetype = "NPP") + 
  scale_linetype_manual("NPP", breaks = c("1.45","1.75", "2.05"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2cNPP_dbh

#### as NPP Residuals change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * scale(Res_NPP), data = data_DBH_p3Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + scale(Res_NPP), data = data_DBH_p3Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDInter))
# Analysis of residuals
ResG <- residuals(Fit_QMDInter)
FittedG <- fitted(Fit_QMDInter)
par(mfrow=c(2,2))
plot(ResG ~ FittedG, xlab="Fitted values", ylab="Residuals", main="Residuals vs. fitted")
abline(h=0) ## Homocedasticity
plot(data_DBH_p3Den$logDensity12 ~ FittedG, xlab="FittedG", ylab="TreesPerHectareAHC1_2", main = "xyplot")
abline(0, 1) 
hist(ResG, main="Histogram of residuals", xlab="Residuals") ## Normality
boxplot(ResG,ylab = "Residuals")

fig2cRes_dbh <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","Res_NPP[-0.2, 0, 0.2]"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "Res_NPP",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_DBH_p3Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2cRes_dbh

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "Res_NPP[-0.2, 0, 0.2]"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2cRes_dbh <- ggplot() + 
  geom_point(data = data_DBH_p3Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#D55E00",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Res_NPP", linetype = "Res_NPP") + 
  scale_linetype_manual("Res_NPP", breaks = c("-0.2","0", "0.2"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2cRes_dbh

```

#### GR 
```{r, fig.width = 7, fig.height = 5}
fig2g_gr <- ggplot() + 
  geom_point(data= subset(ea1sa1GRp1gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_point(data=subset(ea2sa1GRp1gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_point(data=subset(ea3sa1GRp1gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_smooth(data= subset(ea1sa1GRp1gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='Control'),col="#009E73",
              method = "lm",fullrange = T) + 
  geom_smooth(data= subset(ea2sa1GRp1gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='+15%'),col="#009E73",
              method = "lm",fullrange = T) +
  geom_smooth(data= subset(ea3sa1GRp1gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='+30%'),col="#009E73",
              method = "lm",fullrange = T) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2g_gr

fig2h_gr <- ggplot() + 
  geom_point(data= subset(ea1sa1GRp2gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_point(data=subset(ea2sa1GRp2gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_point(data=subset(ea3sa1GRp2gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_smooth(data= subset(ea1sa1GRp2gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='Control'),col="#0072B2",
              method = "lm",fullrange = T) + 
  geom_smooth(data= subset(ea2sa1GRp2gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='+15%'),col="#0072B2",
              method = "lm",fullrange = T) +
  geom_smooth(data= subset(ea3sa1GRp2gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='+30%'),col="#0072B2",
              method = "lm",fullrange = T) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11))  #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2h_gr

fig2i_gr <- ggplot() + 
  geom_point(data= subset(ea1sa1GRp3gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_point(data=subset(ea2sa1GRp3gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_point(data=subset(ea3sa1GRp3gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12)),alpha=.5,size=1,col="grey") + 
  geom_smooth(data= subset(ea1sa1GRp3gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='Control'),col="#D55E00",
              method = "lm",fullrange = T) + 
  geom_smooth(data= subset(ea2sa1GRp3gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='+15%'),col="#D55E00",
              method = "lm",fullrange = T) +
  geom_smooth(data= subset(ea3sa1GRp3gl_out_annual_tile, year>=750), aes(x=log(QMD), y=log(Density12), linetype='+30%'),col="#D55E00",
              method = "lm",fullrange = T) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11))  #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2i_gr
```

##### GR p1 
```{r}

ea1sa1GRp1gl_out_annual_tile <- ea1sa1GRp1gl_out_annual_tile %>% 
  mutate(Mortality = "GR") %>% 
  mutate(Parameter = "p1") %>% 
  mutate(LUE = "Control")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea1sa1GRp1gl_out_annual_tile$NPP_kg_ha_year <- ea1sa1GRp1gl_out_annual_tile$NPP * 10000

data_GR_ea1p1 <- ea1sa1GRp1gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_GR_ea1p1$QMD_bins))
max(data_GR_ea1p1$NPP_kg_ha_year)

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_GR_ea1p1 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_GR_ea1p1 <- data_GR_ea1p1 %>% left_join(quantileX)
data_GR_ea1p1Den <- data_GR_ea1p1 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_GR_ea1p1Rest <- data_GR_ea1p1 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

ea2sa1GRp1gl_out_annual_tile <- ea2sa1GRp1gl_out_annual_tile %>%
  mutate(Mortality = "GR") %>% 
  mutate(Parameter = "p1") %>% 
  mutate(LUE = "+15%")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea2sa1GRp1gl_out_annual_tile$NPP_kg_ha_year <- ea2sa1GRp1gl_out_annual_tile$NPP * 10000

data_GR_ea2p1 <- ea2sa1GRp1gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_GR_ea2p1$QMD_bins))

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_GR_ea2p1 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_GR_ea2p1 <- data_GR_ea2p1 %>% left_join(quantileX)
data_GR_ea2p1Den <- data_GR_ea2p1 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_GR_ea2p1Rest <- data_GR_ea2p1 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

ea3sa1GRp1gl_out_annual_tile <- ea3sa1GRp1gl_out_annual_tile %>% 
  mutate(Mortality = "GR") %>% 
  mutate(Parameter = "p1") %>% 
  mutate(LUE = "+30%")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea3sa1GRp1gl_out_annual_tile$NPP_kg_ha_year <- ea3sa1GRp1gl_out_annual_tile$NPP * 10000

data_GR_ea3p1 <- ea3sa1GRp1gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_GR_ea3p1$QMD_bins))

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_GR_ea3p1 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_GR_ea3p1 <- data_GR_ea3p1 %>% left_join(quantileX)
data_GR_ea3p1Den <- data_GR_ea3p1 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_GR_ea3p1Rest <- data_GR_ea3p1 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

data_GR_p1 <- rbind(data_GR_ea1p1, data_GR_ea2p1, data_GR_ea3p1) 
data_GR_p1Den <- rbind(data_GR_ea1p1Den, data_GR_ea2p1Den, data_GR_ea3p1Den) 
data_GR_p1Rest <- rbind(data_GR_ea1p1Rest, data_GR_ea2p1Rest, data_GR_ea3p1Rest) 

data_GR_p1Den <- data_GR_p1Den %>% mutate(logDensity12=log(Density12),logQMD=log(QMD))
data_GR_p1Rest <- data_GR_p1Rest %>% mutate(logDensity12=log(Density12),logQMD=log(QMD))

ggplot() + 
  geom_point(data = data_GR_p1, aes(x = log(QMD), y = log(Density12)), color="blue") +
  geom_point(data = data_GR_p1Den, aes(x = log(QMD), y = log(Density12)), color="red") 

FitRes = lm(log(NPP_kg_ha_year) ~ QMD, data = data_GR_p1Den, na.action = "na.exclude")
summary(FitRes)
plot(FitRes)
Res_NPP <- residuals(FitRes)
Fitted_NPP <- fitted(FitRes)
data_GR_p1Den$Res_NPP <- Res_NPP

### STL model
#### as LUE change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * LUE, data = data_GR_p1Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + LUE, data = data_GR_p1Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDNoInter))
fig2aLUE_gr <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","LUE"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "LUE",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_GR_p2Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2aLUE_gr

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "LUE"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2aLUE_gr <- ggplot() + 
  geom_point(data = data_GR_p1Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#009E73",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2aLUE_gr

#### as NPP change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * scale(NPP), data = data_GR_p1Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + scale(NPP), data = data_GR_p1Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDInter))
fig2aNPP_gr <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","NPP[1.45,1.75,2.00]"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "NPP",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_GR_p2Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2aNPP_gr

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "NPP[1.45,1.75,2.05]"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2aNPP_gr <- ggplot() + 
  geom_point(data = data_GR_p1Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#009E73",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "NPP", linetype = "NPP") + 
  scale_linetype_manual("NPP", breaks = c("1.45","1.75", "2.05"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2aNPP_gr

#### as NPP Residuals change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * scale(Res_NPP), data = data_GR_p1Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + scale(Res_NPP), data = data_GR_p1Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDInter))
# Analysis of residuals
ResG <- residuals(Fit_QMDInter)
FittedG <- fitted(Fit_QMDInter)
par(mfrow=c(2,2))
plot(ResG ~ FittedG, xlab="Fitted values", ylab="Residuals", main="Residuals vs. fitted")
abline(h=0) ## Homocedasticity
plot(data_GR_p1Den$logDensity12 ~ FittedG, xlab="FittedG", ylab="TreesPerHectareAHC1_2", main = "xyplot")
abline(0, 1) 
hist(ResG, main="Histogram of residuals", xlab="Residuals") ## Normality
boxplot(ResG,ylab = "Residuals")

fig2aRes_gr <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","Res_NPP[-0.2, 0, 0.2]"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "Res_NPP",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_GR_p2Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2aRes_gr

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "Res_NPP[-0.2, 0, 0.2]"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2aRes_gr <- ggplot() + 
  geom_point(data = data_GR_p1Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#009E73",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Res_NPP", linetype = "Res_NPP") + 
  scale_linetype_manual("Res_NPP", breaks = c("-0.2","0", "0.2"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2aRes_gr

```

##### GR p2 
```{r}

ea1sa1GRp2gl_out_annual_tile <- ea1sa1GRp2gl_out_annual_tile %>% 
  mutate(Mortality = "GR") %>% 
  mutate(Parameter = "p2") %>% 
  mutate(LUE = "Control")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea1sa1GRp2gl_out_annual_tile$NPP_kg_ha_year <- ea1sa1GRp2gl_out_annual_tile$NPP * 10000

data_GR_ea1p2 <- ea1sa1GRp2gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_GR_ea1p2$QMD_bins))
max(data_GR_ea1p2$NPP_kg_ha_year)

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_GR_ea1p2 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_GR_ea1p2 <- data_GR_ea1p2 %>% left_join(quantileX)
data_GR_ea1p2Den <- data_GR_ea1p2 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_GR_ea1p2Rest <- data_GR_ea1p2 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

ea2sa1GRp2gl_out_annual_tile <- ea2sa1GRp2gl_out_annual_tile %>%
  mutate(Mortality = "GR") %>% 
  mutate(Parameter = "p2") %>% 
  mutate(LUE = "+15%")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea2sa1GRp2gl_out_annual_tile$NPP_kg_ha_year <- ea2sa1GRp2gl_out_annual_tile$NPP * 10000

data_GR_ea2p2 <- ea2sa1GRp2gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_GR_ea2p2$QMD_bins))

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_GR_ea2p2 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_GR_ea2p2 <- data_GR_ea2p2 %>% left_join(quantileX)
data_GR_ea2p2Den <- data_GR_ea2p2 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_GR_ea2p2Rest <- data_GR_ea2p2 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

ea3sa1GRp2gl_out_annual_tile <- ea3sa1GRp2gl_out_annual_tile %>% 
  mutate(Mortality = "GR") %>% 
  mutate(Parameter = "p2") %>% 
  mutate(LUE = "+30%")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea3sa1GRp2gl_out_annual_tile$NPP_kg_ha_year <- ea3sa1GRp2gl_out_annual_tile$NPP * 10000

data_GR_ea3p2 <- ea3sa1GRp2gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_GR_ea3p2$QMD_bins))

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_GR_ea3p2 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_GR_ea3p2 <- data_GR_ea3p2 %>% left_join(quantileX)
data_GR_ea3p2Den <- data_GR_ea3p2 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_GR_ea3p2Rest <- data_GR_ea3p2 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

data_GR_p2 <- rbind(data_GR_ea1p2, data_GR_ea2p2, data_GR_ea3p2) 
data_GR_p2Den <- rbind(data_GR_ea1p2Den, data_GR_ea2p2Den, data_GR_ea3p2Den) 
data_GR_p2Rest <- rbind(data_GR_ea1p2Rest, data_GR_ea2p2Rest, data_GR_ea3p2Rest) 

data_GR_p2Den <- data_GR_p2Den %>% mutate(logDensity12=log(Density12),logQMD=log(QMD))
data_GR_p2Rest <- data_GR_p2Rest %>% mutate(logDensity12=log(Density12),logQMD=log(QMD))

ggplot() + 
  geom_point(data = data_GR_p2, aes(x = log(QMD), y = log(Density12)), color="blue") +
  geom_point(data = data_GR_p2Den, aes(x = log(QMD), y = log(Density12)), color="red") 

FitRes = lm(log(NPP_kg_ha_year) ~ QMD, data = data_GR_p2Den, na.action = "na.exclude")
summary(FitRes)
plot(FitRes)
Res_NPP <- residuals(FitRes)
Fitted_NPP <- fitted(FitRes)
data_GR_p2Den$Res_NPP <- Res_NPP

### STL model
#### as LUE change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * LUE, data = data_GR_p2Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + LUE, data = data_GR_p2Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDNoInter))
fig2bLUE_gr <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","LUE"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "LUE",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_GR_p2Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2bLUE_gr

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "LUE"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2bLUE_gr <- ggplot() + 
  geom_point(data = data_GR_p2Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#0072B2",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2bLUE_gr

#### as NPP change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * scale(NPP), data = data_GR_p2Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + scale(NPP), data = data_GR_p2Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDInter))
fig2bNPP_gr <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","NPP[1.45,1.75,2.00]"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "NPP",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_GR_p2Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2bNPP_gr

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "NPP[1.45,1.75,2.05]"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2bNPP_gr <- ggplot() + 
  geom_point(data = data_GR_p2Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#0072B2",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "NPP", linetype = "NPP") + 
  scale_linetype_manual("NPP", breaks = c("1.45","1.75", "2.05"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2bNPP_gr

#### as NPP Residuals change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * scale(Res_NPP), data = data_GR_p2Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + scale(Res_NPP), data = data_GR_p2Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDInter))
# Analysis of residuals
ResG <- residuals(Fit_QMDInter)
FittedG <- fitted(Fit_QMDInter)
par(mfrow=c(2,2))
plot(ResG ~ FittedG, xlab="Fitted values", ylab="Residuals", main="Residuals vs. fitted")
abline(h=0) ## Homocedasticity
plot(data_GR_p2Den$logDensity12 ~ FittedG, xlab="FittedG", ylab="TreesPerHectareAHC1_2", main = "xyplot")
abline(0, 1) 
hist(ResG, main="Histogram of residuals", xlab="Residuals") ## Normality
boxplot(ResG,ylab = "Residuals")

fig2bRes_gr <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","Res_NPP[-0.2, 0, 0.2]"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "Res_NPP",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_GR_p2Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2bRes_gr

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "Res_NPP[-0.2, 0, 0.2]"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2bRes_gr <- ggplot() + 
  geom_point(data = data_GR_p2Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#0072B2",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Res_NPP", linetype = "Res_NPP") + 
  scale_linetype_manual("Res_NPP", breaks = c("-0.2","0", "0.2"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2bRes_gr

```

##### GR p3
```{r}

ea1sa1GRp3gl_out_annual_tile <- ea1sa1GRp3gl_out_annual_tile %>% 
  mutate(Mortality = "GR") %>% 
  mutate(Parameter = "p3") %>% 
  mutate(LUE = "Control")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea1sa1GRp3gl_out_annual_tile$NPP_kg_ha_year <- ea1sa1GRp3gl_out_annual_tile$NPP * 10000

data_GR_ea1p3 <- ea1sa1GRp3gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_GR_ea1p3$QMD_bins))
max(data_GR_ea1p3$NPP_kg_ha_year)

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_GR_ea1p3 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_GR_ea1p3 <- data_GR_ea1p3 %>% left_join(quantileX)
data_GR_ea1p3Den <- data_GR_ea1p3 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_GR_ea1p3Rest <- data_GR_ea1p3 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

ea2sa1GRp3gl_out_annual_tile <- ea2sa1GRp3gl_out_annual_tile %>%
  mutate(Mortality = "GR") %>% 
  mutate(Parameter = "p3") %>% 
  mutate(LUE = "+15%")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea2sa1GRp3gl_out_annual_tile$NPP_kg_ha_year <- ea2sa1GRp3gl_out_annual_tile$NPP * 10000

data_GR_ea2p3 <- ea2sa1GRp3gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_GR_ea2p3$QMD_bins))

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_GR_ea2p3 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_GR_ea2p3 <- data_GR_ea2p3 %>% left_join(quantileX)
data_GR_ea2p3Den <- data_GR_ea2p3 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_GR_ea2p3Rest <- data_GR_ea2p3 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

ea3sa1GRp3gl_out_annual_tile <- ea3sa1GRp3gl_out_annual_tile %>% 
  mutate(Mortality = "GR") %>% 
  mutate(Parameter = "p3") %>% 
  mutate(LUE = "+30%")

# Convert NPP from KgC/m2/yr to KgC/ha/yr
ea3sa1GRp3gl_out_annual_tile$NPP_kg_ha_year <- ea3sa1GRp3gl_out_annual_tile$NPP * 10000

data_GR_ea3p3 <- ea3sa1GRp3gl_out_annual_tile %>% filter(year>=750) %>% mutate(QMD_bins = cut(QMD, breaks = 30)) 
sort(unique(data_GR_ea3p3$QMD_bins))

# Select from each QMD bins the number of plots with higher density
# Includes a sensitivity analysis using quantiles from 0.5 to 0.9
valueQuantile = 0.75
quantileX <- data_GR_ea3p3 %>% group_by(QMD_bins) %>% summarise(quantile(Density12, c(valueQuantile))) 
max(quantileX$`quantile(Density12, c(valueQuantile))`)
data_GR_ea3p3 <- data_GR_ea3p3 %>% left_join(quantileX)
data_GR_ea3p3Den <- data_GR_ea3p3 %>% filter(Density12>=`quantile(Density12, c(valueQuantile))`)
data_GR_ea3p3Rest <- data_GR_ea3p3 %>% filter(Density12<`quantile(Density12, c(valueQuantile))`)

data_GR_p3 <- rbind(data_GR_ea1p3, data_GR_ea2p3, data_GR_ea3p3) 
data_GR_p3Den <- rbind(data_GR_ea1p3Den, data_GR_ea2p3Den, data_GR_ea3p3Den) 
data_GR_p3Rest <- rbind(data_GR_ea1p3Rest, data_GR_ea2p3Rest, data_GR_ea3p3Rest) 

data_GR_p3Den <- data_GR_p3Den %>% mutate(logDensity12=log(Density12),logQMD=log(QMD))
data_GR_p3Rest <- data_GR_p3Rest %>% mutate(logDensity12=log(Density12),logQMD=log(QMD))

ggplot() + 
  geom_point(data = data_GR_p3, aes(x = log(QMD), y = log(Density12)), color="blue") +
  geom_point(data = data_GR_p3Den, aes(x = log(QMD), y = log(Density12)), color="red") 

FitRes = lm(log(NPP_kg_ha_year) ~ QMD, data = data_GR_p3Den, na.action = "na.exclude")
summary(FitRes)
plot(FitRes)
Res_NPP <- residuals(FitRes)
Fitted_NPP <- fitted(FitRes)
data_GR_p3Den$Res_NPP <- Res_NPP

### STL model
#### as LUE change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * LUE, data = data_GR_p3Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + LUE, data = data_GR_p3Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDNoInter))
fig2cLUE_gr <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","LUE"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "LUE",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_GR_p3Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2cLUE_gr

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "LUE"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2cLUE_gr <- ggplot() + 
  geom_point(data = data_GR_p3Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#D55E00",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2cLUE_gr

#### as NPP change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * scale(NPP), data = data_GR_p3Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + scale(NPP), data = data_GR_p3Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDInter))
fig2cNPP_gr <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","NPP[1.45,1.75,2.00]"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "NPP",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_GR_p3Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2cNPP_gr

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "NPP[1.45,1.75,2.05]"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2cNPP_gr <- ggplot() + 
  geom_point(data = data_GR_p3Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#D55E00",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "NPP", linetype = "NPP") + 
  scale_linetype_manual("NPP", breaks = c("1.45","1.75", "2.05"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2cNPP_gr

#### as NPP Residuals change
Fit_QMDInter = lm(logDensity12 ~ scale(logQMD) * scale(Res_NPP), data = data_GR_p3Den, na.action = "na.exclude")
Fit_QMDNoInter = lm(logDensity12 ~ scale(logQMD) + scale(Res_NPP), data = data_GR_p3Den, na.action = "na.exclude")
AICc(Fit_QMDInter,Fit_QMDNoInter)
summary(Fit_QMDInter)
summary(Fit_QMDNoInter)
plot(allEffects(Fit_QMDInter))
# Analysis of residuals
ResG <- residuals(Fit_QMDInter)
FittedG <- fitted(Fit_QMDInter)
par(mfrow=c(2,2))
plot(ResG ~ FittedG, xlab="Fitted values", ylab="Residuals", main="Residuals vs. fitted")
abline(h=0) ## Homocedasticity
plot(data_GR_p3Den$logDensity12 ~ FittedG, xlab="FittedG", ylab="TreesPerHectareAHC1_2", main = "xyplot")
abline(0, 1) 
hist(ResG, main="Histogram of residuals", xlab="Residuals") ## Normality
boxplot(ResG,ylab = "Residuals")

fig2cRes_gr <- plot_model(Fit_QMDInter, type = "pred",show.data=TRUE, dot.size=1.5,
                         terms = c("logQMD","Res_NPP[-0.2, 0, 0.2]"),title = "",
                         axis.title = c("Quadratic Mean Diameter (QMD)","Stand density (N)"),legend.title = "Res_NPP",
                         colors = c("#FC4E07", "#00AFBB", "#E7B800")) + 
  #geom_point(data = data_GR_p3Rest, aes(x = logQMD, y = logDensity12), alpha=0.2, size = 1,shape = 18, inherit.aes = FALSE) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
fig2cRes_gr

pred <- ggpredict(Fit_QMDInter, terms = c("logQMD", "Res_NPP[-0.2, 0, 0.2]"), full.data = TRUE)
plot(pred, add.data = F) 
preddata <- as.data.frame(pred)

fig2cRes_gr <- ggplot() + 
  geom_point(data = data_GR_p3Den, aes(x = logQMD, y = logDensity12), alpha=0.3, size = 1,col="grey", inherit.aes = FALSE) +
  geom_smooth(data= preddata, aes(x=x, y=predicted, linetype=group),col="#D55E00",
              method = "lm",fullrange = T) +
  labs(x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)",
       color  = "Res_NPP", linetype = "Res_NPP") + 
  scale_linetype_manual("Res_NPP", breaks = c("-0.2","0", "0.2"), 
                     values = c("dotted","dashed","solid")) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) + guides(color = "none") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
fig2cRes_gr

```

### j) Links model to data

#### DBH 
```{r, fig.width = 5, fig.height = 5}

# DBH p1
# Calculate the relative change as (Final value - initial value)/initial value
D30 <- ea3sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(D30=mean(Density12))
D15 <- ea2sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(D15=mean(Density12))
D0  <- ea1sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(D0=mean(Density12))
dD0_15 <- (D15$D15 - D0$D0)/D0$D0
dD0_30 <- (D30$D30 - D0$D0)/D0$D0

B30 <- ea3sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(B30=mean(plantC)) 
B15 <- ea2sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(B15=mean(plantC))
B0  <- ea1sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

G30 <- ea3sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(G30=mean(NPP)) 
G15 <- ea2sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(G15=mean(NPP))
G0  <- ea1sa1DBHp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(G0=mean(NPP))
dG0_15 <- (G15$G15 - G0$G0)/G0$G0
dG0_30 <- (G30$G30 - G0$G0)/G0$G0

DBHp1gl_LinkChange_0_15 <- data.frame(dD0_15,dB0_15,dG0_15)
DBHp1gl_LinkChange_0_30 <- data.frame(dD0_30,dB0_30,dG0_30)

# DBH p2
# Calculate the relative change as (Final value - initial value)/initial value
D30 <- ea3sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(D30=mean(Density12))
D15 <- ea2sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(D15=mean(Density12))
D0  <- ea1sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(D0=mean(Density12))
dD0_15 <- (D15$D15 - D0$D0)/D0$D0
dD0_30 <- (D30$D30 - D0$D0)/D0$D0

B30 <- ea3sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(B30=mean(plantC)) 
B15 <- ea2sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(B15=mean(plantC))
B0  <- ea1sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

G30 <- ea3sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(G30=mean(NPP)) 
G15 <- ea2sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(G15=mean(NPP))
G0  <- ea1sa1DBHp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(G0=mean(NPP))
dG0_15 <- (G15$G15 - G0$G0)/G0$G0
dG0_30 <- (G30$G30 - G0$G0)/G0$G0

DBHp2gl_LinkChange_0_15 <- data.frame(dD0_15,dB0_15,dG0_15)
DBHp2gl_LinkChange_0_30 <- data.frame(dD0_30,dB0_30,dG0_30)

# DBH p3
# Calculate the relative change as (Final value - initial value)/initial value
D30 <- ea3sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(D30=mean(Density12))
D15 <- ea2sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(D15=mean(Density12))
D0  <- ea1sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(D0=mean(Density12))
dD0_15 <- (D15$D15 - D0$D0)/D0$D0
dD0_30 <- (D30$D30 - D0$D0)/D0$D0

B30 <- ea3sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(B30=mean(plantC)) 
B15 <- ea2sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(B15=mean(plantC))
B0  <- ea1sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

G30 <- ea3sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(G30=mean(NPP)) 
G15 <- ea2sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(G15=mean(NPP))
G0  <- ea1sa1DBHp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(G0=mean(NPP))
dG0_15 <- (G15$G15 - G0$G0)/G0$G0
dG0_30 <- (G30$G30 - G0$G0)/G0$G0

DBHp3gl_LinkChange_0_15 <- data.frame(dD0_15,dB0_15,dG0_15)
DBHp3gl_LinkChange_0_30 <- data.frame(dD0_30,dB0_30,dG0_30)

```

#### GR 
```{r, fig.width = 5, fig.height = 5}
# GR p1
# Calculate the relative change as (Final value - initial value)/initial value
D30 <- ea3sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(D30=mean(Density12))
D15 <- ea2sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(D15=mean(Density12))
D0  <- ea1sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(D0=mean(Density12))
dD0_15 <- (D15$D15 - D0$D0)/D0$D0
dD0_30 <- (D30$D30 - D0$D0)/D0$D0

B30 <- ea3sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(B30=mean(plantC)) 
B15 <- ea2sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(B15=mean(plantC))
B0  <- ea1sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

G30 <- ea3sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(G30=mean(NPP)) 
G15 <- ea2sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(G15=mean(NPP))
G0  <- ea1sa1GRp1gl_out_annual_tile %>% filter(year>=700) %>% summarise(G0=mean(NPP))
dG0_15 <- (G15$G15 - G0$G0)/G0$G0
dG0_30 <- (G30$G30 - G0$G0)/G0$G0

GRp1gl_LinkChange_0_15 <- data.frame(dD0_15,dB0_15,dG0_15)
GRp1gl_LinkChange_0_30 <- data.frame(dD0_30,dB0_30,dG0_30)

# GR p2
# Calculate the relative change as (Final value - initial value)/initial value
D30 <- ea3sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(D30=mean(Density12))
D15 <- ea2sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(D15=mean(Density12))
D0  <- ea1sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(D0=mean(Density12))
dD0_15 <- (D15$D15 - D0$D0)/D0$D0
dD0_30 <- (D30$D30 - D0$D0)/D0$D0

B30 <- ea3sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(B30=mean(plantC)) 
B15 <- ea2sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(B15=mean(plantC))
B0  <- ea1sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

G30 <- ea3sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(G30=mean(NPP)) 
G15 <- ea2sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(G15=mean(NPP))
G0  <- ea1sa1GRp2gl_out_annual_tile %>% filter(year>=700) %>% summarise(G0=mean(NPP))
dG0_15 <- (G15$G15 - G0$G0)/G0$G0
dG0_30 <- (G30$G30 - G0$G0)/G0$G0

GRp2gl_LinkChange_0_15 <- data.frame(dD0_15,dB0_15,dG0_15)
GRp2gl_LinkChange_0_30 <- data.frame(dD0_30,dB0_30,dG0_30)

# GR p3
# Calculate the relative change as (Final value - initial value)/initial value
D30 <- ea3sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(D30=mean(Density12))
D15 <- ea2sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(D15=mean(Density12))
D0  <- ea1sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(D0=mean(Density12))
dD0_15 <- (D15$D15 - D0$D0)/D0$D0
dD0_30 <- (D30$D30 - D0$D0)/D0$D0

B30 <- ea3sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(B30=mean(plantC)) 
B15 <- ea2sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(B15=mean(plantC))
B0  <- ea1sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

G30 <- ea3sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(G30=mean(NPP)) 
G15 <- ea2sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(G15=mean(NPP))
G0  <- ea1sa1GRp3gl_out_annual_tile %>% filter(year>=700) %>% summarise(G0=mean(NPP))
dG0_15 <- (G15$G15 - G0$G0)/G0$G0
dG0_30 <- (G30$G30 - G0$G0)/G0$G0

GRp3gl_LinkChange_0_15 <- data.frame(dD0_15,dB0_15,dG0_15)
GRp3gl_LinkChange_0_30 <- data.frame(dD0_30,dB0_30,dG0_30)

```

#### Plot
```{r}

# add data from NFI
LinkChange_0_30 <- data.frame(dD0_30=-0.01140139,dB0_30=0.2811337,dG0_30=2.849336)

ggplot() + 
  geom_point(data=DBHp1gl_LinkChange_0_30, aes(x=dB0_30/dG0_30, y=dD0_30, color='x1', shape="DBH"),size=3) + 
  geom_point(data=DBHp2gl_LinkChange_0_30, aes(x=dB0_30/dG0_30, y=dD0_30, color='x2', shape="DBH"),size=3) + 
  geom_point(data=DBHp3gl_LinkChange_0_30, aes(x=dB0_30/dG0_30, y=dD0_30, color='x3', shape="DBH"),size=3) + 
  geom_point(data=GRp1gl_LinkChange_0_30, aes(x=dB0_30/dG0_30, y=dD0_30, color='x1', shape="GR"),size=3) + 
  geom_point(data=GRp2gl_LinkChange_0_30, aes(x=dB0_30/dG0_30, y=dD0_30, color='x2', shape="GR"),size=3) + 
  geom_point(data=GRp3gl_LinkChange_0_30, aes(x=dB0_30/dG0_30, y=dD0_30, color='x3', shape="GR"),size=3) + 
  #geom_point(data=LinkChange_0_30, aes(x=dB0_30/dG0_30, y=dD0_30),color="black", size=3) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_shape_manual("Level of LUE", breaks = c("DBH","GR"), 
                     values = c(16,17)) +  labs(x="dlnB/dlnG", y="dN/N") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  #scale_x_continuous(limits = c(0.0,0.5)) + 
  #scale_y_continuous(limits = c(0.0,0.5)) +
  geom_abline(slope=1, intercept = 0.0, linetype="dashed")
```

### Arrange plots

#### Figure 1
```{r, include=F, eval=T,fig.height=15,fig.width=12}

ff1a <- fig1a_dbh + fig1b_dbh + fig1c_dbh + fig1d_dbh + fig1e_dbh + fig1f_dbh + fig1g_dbh + fig1h_dbh + 
  plot_layout(ncol = 4) + 
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

ff1b <- fig1a_gr + fig1b_gr + fig1c_gr + fig1d_gr + fig1e_gr + fig1f_gr + fig1g_gr + fig1h_gr + 
  plot_layout(ncol = 4) + 
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

ff1 <- fig1a_dbh + fig1b_dbh + fig1c_dbh + fig1d_dbh + fig1e_dbh + fig1f_dbh + fig1g_dbh + fig1h_dbh + fig1a_gr + fig1b_gr + fig1c_gr + fig1d_gr + fig1e_gr + fig1f_gr + fig1g_gr + fig1h_gr + 
  plot_layout(ncol = 4) + 
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

ff1

ggsave("~/rsofun/vignettes_add/fig1.png", width = 12, height = 11, dpi=300)
```

#### Figure 2
```{r, include=F, eval=T,fig.height=12,fig.width=12}
ff2LUE <- fig2aLUE_dbh + fig2bLUE_dbh + fig2cLUE_dbh + 
  fig2aLUE_gr + fig2bLUE_gr + fig2cLUE_gr +
  plot_layout(ncol = 3) + 
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

ff2LUE
ggsave("~/rsofun/vignettes_add/fig2LUE.png", width = 12, height = 9, dpi=300)

ff2NPP <- fig2aNPP_dbh + fig2bNPP_dbh + fig2cNPP_dbh + 
  fig2aNPP_gr + fig2bNPP_gr + fig2cNPP_gr +
  plot_layout(ncol = 3) + 
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

ff2NPP
ggsave("~/rsofun/vignettes_add/fig2NPP.png", width = 12, height = 9, dpi=300)

ff2Res <- fig2aRes_dbh + fig2bRes_dbh + fig2cRes_dbh + 
  fig2aRes_gr + fig2bRes_gr + fig2cRes_gr +
  plot_layout(ncol = 3) + 
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

ff2Res
ggsave("~/rsofun/vignettes_add/fig2Res.png", width = 12, height = 9, dpi=300)

```

#### Figure S1
```{r, include=F, eval=T,fig.height=5,fig.width=5}

ffs1 <- figdistr_a_dbh + figdistr_b_dbh + figdistr_c_dbh + figdistr_a_gr + figdistr_b_gr + figdistr_c_gr +
  plot_layout(ncol = 3) + 
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

ffs1 <- figdistr_dbh + figdistr_gr +
  plot_layout(ncol = 2) + 
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

ffs1

ggsave("~/rsofun/vignettes_add/figS1.png", width = 9, height = 5, dpi=300)
```

#### Figure S2
```{r, include=F, eval=T,fig.height=5,fig.width=5}

ffs2 <- fig1gg_dbh + fig1gg_gr + 
  plot_layout(ncol = 2) + 
  plot_annotation(tag_levels = 'A') +
  plot_layout(guides = "collect") & theme(legend.position = 'bottom')

ffs2

ggsave("~/rsofun/vignettes_add/figS2.png", width = 9, height = 5, dpi=300)
```

### Distribution of tree sizes

From annual_cohort_output: dbh class 

```{r, fig.width = 6, fig.height = 9}

figdistr_a_dbh <- ggplot() + 
  geom_smooth(data= ea1sa1DBHp1gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='Control'),col="#009E73",se=F) + 
  geom_smooth(data= ea2sa1DBHp1gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='+15%'),col="#009E73",se=F) +
  geom_smooth(data= ea3sa1DBHp1gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='+30%'),col="#009E73",se=F) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  labs(x = "DBH (cm)", y = "Log(N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) 
figdistr_a_dbh

figdistr_b_dbh <- ggplot() + 
  geom_smooth(data= ea1sa1DBHp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='Control'),col="#0072B2",se=F) + 
  geom_smooth(data= ea2sa1DBHp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='+15%'),col="#0072B2",se=F) +
  geom_smooth(data= ea3sa1DBHp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='+30%'),col="#0072B2",se=F) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  labs(x = "DBH (cm)", y = "Log(N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) 
figdistr_b_dbh

figdistr_c_dbh <- ggplot() + 
  geom_smooth(data= ea1sa1DBHp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='Control'),col="#D55E00",se=F) + 
  geom_smooth(data= ea2sa1DBHp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='+15%'),col="#D55E00",se=F) +
  geom_smooth(data= ea3sa1DBHp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='+30%'),col="#D55E00",se=F) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  labs(x = "DBH (cm)", y = "Log(N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11))
figdistr_c_dbh

figdistr_dbh <- ggplot() +  
  geom_smooth(data=ea1sa1DBHp1gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x1', linetype='Control'),se=F) + 
  geom_smooth(data=ea1sa1DBHp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x2', linetype='Control'),se=F) +
  geom_smooth(data=ea1sa1DBHp3gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x3', linetype='Control'),se=F) +
  geom_smooth(data=ea2sa1DBHp1gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x1', linetype='+15%'),se=F) + 
  geom_smooth(data=ea2sa1DBHp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x2', linetype='+15%'),se=F) +
  geom_smooth(data=ea2sa1DBHp3gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x3', linetype='+15%'),se=F) +
  geom_smooth(data=ea3sa1DBHp1gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x1', linetype='+30%'),se=F) + 
  geom_smooth(data=ea3sa1DBHp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x2', linetype='+30%'),se=F) +
  geom_smooth(data=ea3sa1DBHp3gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x3', linetype='+30%'),se=F) +
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","longdash","solid")) +
  labs(x = "DBH (cm)", y = "Log(N)") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) #+ 
  #scale_y_continuous(limits = c(-4.5,11.2), breaks = seq(0,10,5))

```

```{r, fig.width = 6, fig.height = 9}

figdistr_a_gr <- ggplot() + 
  geom_smooth(data= ea1sa1GRp1gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='Control'),col="#009E73",se=F) + 
  geom_smooth(data= ea2sa1GRp1gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='+15%'),col="#009E73",se=F) +
  geom_smooth(data= ea3sa1GRp1gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='+30%'),col="#009E73",se=F) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  labs(x = "DBH (cm)", y = "Log(N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) 
figdistr_a_gr

figdistr_b_gr <- ggplot() + 
  geom_smooth(data= ea1sa1GRp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='Control'),col="#0072B2",se=F) + 
  geom_smooth(data= ea2sa1GRp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='+15%'),col="#0072B2",se=F) +
  geom_smooth(data= ea3sa1GRp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='+30%'),col="#0072B2",se=F) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  labs(x = "DBH (cm)", y = "Log(N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11)) 
figdistr_b_dbh

figdistr_c_gr <- ggplot() + 
  geom_smooth(data= ea1sa1GRp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='Control'),col="#D55E00",se=F) + 
  geom_smooth(data= ea2sa1GRp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='+15%'),col="#D55E00",se=F) +
  geom_smooth(data= ea3sa1GRp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), linetype='+30%'),col="#D55E00",se=F) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","dashed","solid")) +
  labs(x = "DBH (cm)", y = "Log(N)",
       color  = "Level of LUE", linetype = "Level of LUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        legend.key.size = unit(1, 'cm'),
        plot.title = element_text(size = 11))
figdistr_c_gr

figdistr_gr <- ggplot() +  
  geom_smooth(data=ea1sa1GRp1gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x1', linetype='Control'),se=F) + 
  geom_smooth(data=ea1sa1GRp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x2', linetype='Control'),se=F) +
  geom_smooth(data=ea1sa1GRp3gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x3', linetype='Control'),se=F) +
  geom_smooth(data=ea2sa1GRp1gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x1', linetype='+15%'),se=F) + 
  geom_smooth(data=ea2sa1GRp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x2', linetype='+15%'),se=F) +
  geom_smooth(data=ea2sa1GRp3gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x3', linetype='+15%'),se=F) +
  geom_smooth(data=ea3sa1GRp1gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x1', linetype='+30%'),se=F) + 
  geom_smooth(data=ea3sa1GRp2gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x2', linetype='+30%'),se=F) +
  geom_smooth(data=ea3sa1GRp3gl_out_annual_cohorts, aes(x=dbh, y=log(density), color='x3', linetype='+30%'),se=F) +
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","longdash","solid")) +
  labs(x = "DBH (cm)", y = "Log(N)") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 

```

### CUE vs dbh or height
```{r}
ggplot() + 
  geom_line(data=ea1sa1DBHp3gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x3'),alpha=.5) +
  geom_line(data=ea1sa1DBHp2gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x2'),alpha=.5) +
  geom_line(data=ea1sa1DBHp1gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x1'),alpha=.5) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  labs(x = "dbh", y = "CUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "DBH - LUE control")

ggplot() + 
  geom_line(data=ea1sa1DBHp3gl_out_annual_cohorts, aes(x=year, y=NPP_yr/GPP_yr, color='x3'),alpha=.5) +
  geom_line(data=ea1sa1DBHp2gl_out_annual_cohorts, aes(x=year, y=NPP_yr/GPP_yr, color='x2'),alpha=.5) +
  geom_line(data=ea1sa1DBHp1gl_out_annual_cohorts, aes(x=year, y=NPP_yr/GPP_yr, color='x1'),alpha=.5) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  labs(x = "dbh", y = "CUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "DBH - LUE control")

ggplot() + 
  geom_line(data=ea2sa1DBHp3gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x3'),alpha=.5) +
  geom_line(data=ea2sa1DBHp2gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x2'),alpha=.5) +
  geom_line(data=ea2sa1DBHp1gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x1'),alpha=.5) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  labs(x = "dbh", y = "CUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "DBH - LUE +15%")

ggplot() + 
  geom_line(data=ea3sa1DBHp3gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x3'),alpha=.5) +
  geom_line(data=ea3sa1DBHp2gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x2'),alpha=.5) +
  geom_line(data=ea3sa1DBHp1gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x1'),alpha=.5) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  labs(x = "dbh", y = "CUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "DBH - LUE +30%")

#NSC 
ggplot() + 
  geom_line(data=ea1sa1NSCp3gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x3'),alpha=.5) +
  geom_line(data=ea1sa1NSCp2gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x2'),alpha=.5) +
  geom_line(data=ea1sa1NSCp1gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x1'),alpha=.5) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  labs(x = "dbh", y = "CUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "NSC - LUE control")

ggplot() + 
  geom_line(data=ea2sa1NSCp3gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x3'),alpha=.5) +
  geom_line(data=ea2sa1NSCp2gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x2'),alpha=.5) +
  geom_line(data=ea2sa1NSCp1gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x1'),alpha=.5) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  labs(x = "dbh", y = "CUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "NSC - LUE +15%")

ggplot() + 
  geom_line(data=ea3sa1NSCp3gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x3'),alpha=.5) +
  geom_line(data=ea3sa1NSCp2gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x2'),alpha=.5) +
  geom_line(data=ea3sa1NSCp1gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x1'),alpha=.5) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  labs(x = "dbh", y = "CUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "NSC - LUE +30%")

#GR 
ggplot() + 
  geom_line(data=ea1sa1GRp3gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x3'),alpha=.5) +
  geom_line(data=ea1sa1GRp2gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x2'),alpha=.5) +
  geom_line(data=ea1sa1GRp1gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x1'),alpha=.5) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  labs(x = "dbh", y = "CUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "GR - LUE control")

ggplot() + 
  geom_line(data=ea2sa1GRp3gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x3'),alpha=.5) +
  geom_line(data=ea2sa1GRp2gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x2'),alpha=.5) +
  geom_line(data=ea2sa1GRp1gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x1'),alpha=.5) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  labs(x = "dbh", y = "CUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "GR - LUE +15%")

ggplot() + 
  geom_line(data=ea3sa1GRp3gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x3'),alpha=.5) +
  geom_line(data=ea3sa1GRp2gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x2'),alpha=.5) +
  geom_line(data=ea3sa1GRp1gl_out_annual_cohorts, aes(x=dbh, y=NPP_yr/GPP_yr, color='x1'),alpha=.5) + 
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  labs(x = "dbh", y = "CUE") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "GR - LUE +30%")

fig4 <- alldata %>%
  ggplot() + geom_line(aes(color=as.factor(LUE), x=dbh, y=NPP_yr/GPP_yr), alpha=.5) +
    labs(x = "DBH (m)", y = "CUE") +
    scale_color_discrete(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),name = "Levels of LUE", guide = "legend") + 
    theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom") +
  facet_grid(Mortality ~ Parameter) 

ggsave("~/rsofun/vignettes_add/figure4b.png", width = 11, height = 8, dpi=300)

```

```{r}
ggplot() + 
  geom_line(data=subset(ea1sa1DBHp1gl_out_annual_tile,year>700), aes(x=year, y=Density12, color='x1', linetype='Control'),alpha=.7) + 
  #geom_line(data=ea1sa1DBHp2gl_out_annual_tile, aes(x=year, y=Density12, color='x2', linetype='Control'),alpha=.7) +
  #geom_line(data=ea1sa1DBHp3gl_out_annual_tile, aes(x=year, y=Density12, color='x3', linetype='Control'),alpha=.7) +
  #geom_line(data=subset(ea2sa1DBHp1gl_out_annual_tile,year>700), aes(x=year, y=Density12, color='x1', linetype='+15%'),alpha=.7) + 
  #geom_line(data=ea2sa1DBHp2gl_out_annual_tile, aes(x=year, y=Density12, color='x2', linetype='+15%'),alpha=.7) +
  #geom_line(data=ea2sa1DBHp3gl_out_annual_tile, aes(x=year, y=Density12, color='x3', linetype='+15%'),alpha=.7) +
  geom_line(data=subset(ea3sa1DBHp1gl_out_annual_tile,year>700), aes(x=year, y=Density12, color='x1', linetype='+30%'),alpha=.7) + 
  geom_line(data=ea3sa1DBHp2gl_out_annual_tile, aes(x=year, y=Density12, color='x2', linetype='+30%'),alpha=.7) +
  geom_line(data=ea3sa1DBHp3gl_out_annual_tile, aes(x=year, y=Density12, color='x3', linetype='+30%'),alpha=.7) +
  scale_color_manual("Parameter value", breaks = c("x1", "x2", "x3"), 
                     values = c("#009E73", "#0072B2", "#D55E00")) +
  scale_linetype_manual("Level of LUE", breaks = c("Control","+15%", "+30%"), 
                     values = c("dotted","longdash","solid")) +
  labs(x = "Year", y = "B") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) 
```

## RHO_WOOD levels

### a) Mortality formulations
Check Plot_functions.R

### b) Stand develop: Stand biomass vs. time

From annual_tile_output: plantC (Biomass)
Level of rho_wood 

```{r, fig.width = 5, fig.height = 5}
# Mortality as a function of DBH
fig2b_dbh <- ggplot() + 
  geom_line(data=ea1sb1DBHgl_out_annual_tile, aes(x=year, y=plantC, color='300 kgC m-3')) +
  geom_line(data=ea1sb2DBHgl_out_annual_tile, aes(x=year, y=plantC, color='450 kgC m-3')) +
  geom_line(data=ea1sb3DBHgl_out_annual_tile, aes(x=year, y=plantC, color='600 kgC m-3')) +
  scale_color_manual("Levels of WD", breaks = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"), values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(x = "Year", y = expression(paste("Biomass (Kg C ", m^-2, " ", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  scale_y_continuous(limits = c(0,40),breaks = seq(0,40,10)) + 
  labs(title= "b)")

# Mortality as a function of C starvation
fig2b_nsc <- ggplot() + 
  geom_line(data=ea1sb1NSCgl_out_annual_tile, aes(x=year, y=plantC, color='300 kgC m-3')) +
  geom_line(data=ea1sb2NSCgl_out_annual_tile, aes(x=year, y=plantC, color='450 kgC m-3')) +
  geom_line(data=ea1sb3NSCgl_out_annual_tile, aes(x=year, y=plantC, color='600 kgC m-3')) +
  scale_color_manual("Levels of WD", breaks = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"), values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(x = "Year", y = expression(paste("Biomass (Kg C ", m^-2, " ", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  #scale_y_continuous(limits = c(0,35),breaks = seq(0,35,10)) +
  labs(title= "b)")

# Mortality as a function of Growth rate
fig2b_gr <- ggplot() + 
  geom_line(data=ea1sb1GRgl_out_annual_tile, aes(x=year, y=plantC, color='300 kgC m-3')) +
  geom_line(data=ea1sb2GRgl_out_annual_tile, aes(x=year, y=plantC, color='450 kgC m-3')) +
  geom_line(data=ea1sb3GRgl_out_annual_tile, aes(x=year, y=plantC, color='600 kgC m-3')) +
  scale_color_manual("Levels of WD", breaks = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"), values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(x = "Year", y = expression(paste("Biomass (Kg C ", m^-2, " ", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  #scale_y_continuous(limits = c(0,35),breaks = seq(0,35,10)) +
  labs(title= "b)")

```

### c) Growth and mortality 

From annual_tile_output: NPP (Growth) and 
Level of LUE (mol/s/m2)

```{r, fig.width = 5, fig.height = 5}

# Mortality as a function of DBH
fig2c_dbh <- ggplot() + 
  geom_line(data=ea1sb1DBHgl_out_annual_tile, aes(x=year, y=NPP, color='300 kgC m-3'),alpha=.7) + 
  geom_line(data=ea1sb2DBHgl_out_annual_tile, aes(x=year, y=NPP, color='450 kgC m-3'),alpha=.7) +
  geom_line(data=ea1sb3DBHgl_out_annual_tile, aes(x=year, y=NPP, color='600 kgC m-3'),alpha=.7) +
  geom_line(data=ea1sb1DBHgl_out_annual_tile, aes(x=year, y=c_deadtrees, color='300 kgC m-3'),alpha=.7) + 
  geom_line(data=ea1sb2DBHgl_out_annual_tile, aes(x=year, y=c_deadtrees, color='450 kgC m-3'),alpha=.7) +
  geom_line(data=ea1sb3DBHgl_out_annual_tile, aes(x=year, y=c_deadtrees, color='600 kgC m-3'),alpha=.7) +
  scale_color_manual("Levels of WD", breaks = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"), values = c("#00AFBB", "#E7B800", "#FC4E07")) +
  labs(x = "Year", y = expression(paste("Biomass (Kg C ", m^-2, " ", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  #scale_y_continuous(limits = c(0,63),breaks = seq(0,63,10)) + 
  labs(title= "c)")

# Mortality as a function of C starvation
fig2c_nsc <- ggplot() + 
  geom_line(data=ea1sb1NSCgl_out_annual_tile, aes(x=year, y=NPP, color='300 kgC m-3'),alpha=.7) + 
  geom_line(data=ea1sb2NSCgl_out_annual_tile, aes(x=year, y=NPP, color='450 kgC m-3'),alpha=.7) +
  geom_line(data=ea1sb3NSCgl_out_annual_tile, aes(x=year, y=NPP, color='600 kgC m-3'),alpha=.7) +
  geom_line(data=ea1sb1NSCgl_out_annual_tile, aes(x=year, y=c_deadtrees, color='300 kgC m-3'),alpha=.7) + 
  geom_line(data=ea1sb2NSCgl_out_annual_tile, aes(x=year, y=c_deadtrees, color='450 kgC m-3'),alpha=.7) +
  geom_line(data=ea1sb3NSCgl_out_annual_tile, aes(x=year, y=c_deadtrees, color='600 kgC m-3'),alpha=.7) +
  scale_color_manual("Levels of WD", breaks = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"), values = c("#00AFBB", "#E7B800", "#FC4E07")) +
  labs(x = "Year", y = expression(paste("Biomass (Kg C ", m^-2, " ", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  #scale_y_continuous(limits = c(0,63),breaks = seq(0,63,10)) + 
  labs(title= "c)")

# Mortality as a function of Growth rate
fig2c_gr <- ggplot() + 
  geom_line(data=ea1sb1GRgl_out_annual_tile, aes(x=year, y=NPP, color='300 kgC m-3'),alpha=.7) + 
  geom_line(data=ea1sb2GRgl_out_annual_tile, aes(x=year, y=NPP, color='450 kgC m-3'),alpha=.7) +
  geom_line(data=ea1sb3GRgl_out_annual_tile, aes(x=year, y=NPP, color='600 kgC m-3'),alpha=.7) +
  geom_line(data=ea1sb1GRgl_out_annual_tile, aes(x=year, y=c_deadtrees, color='300 kgC m-3'),alpha=.7) + 
  geom_line(data=ea1sb2GRgl_out_annual_tile, aes(x=year, y=c_deadtrees, color='450 kgC m-3'),alpha=.7) +
  geom_line(data=ea1sb3GRgl_out_annual_tile, aes(x=year, y=c_deadtrees, color='600 kgC m-3'),alpha=.7) +
  scale_color_manual("Levels of WD", breaks = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"), values = c("#00AFBB", "#E7B800", "#FC4E07")) +
  labs(x = "Year", y = expression(paste("Biomass (Kg C ", m^-2, " ", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  #scale_y_continuous(limits = c(0,63),breaks = seq(0,63,10)) + 
  labs(title= "c)")

```

### d) Relative change biomass (plantC) vs. NPP

Level of LUE

```{r, fig.width = 5, fig.height = 5}

# Mortality as a function of DBH

# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea1sb3DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  #NPP or A_NPP
NPP15 <- ea1sb2DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sb1DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

B30 <- ea1sb3DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B30=mean(plantC)) #plantC or A_Biomass
B15 <- ea1sb2DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B15=mean(plantC))
B0  <- ea1sb1DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB15_30 <- (B30$B30 - B15$B15)/B15$B15
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

DBHgl_RelChange_0_15 <- data.frame(dNPP0_15,dB0_15)
DBHgl_RelChange_15_30 <- data.frame(dNPP15_30,dB15_30)
DBHgl_RelChange_0_30 <- data.frame(dNPP0_30,dB0_30)

fig2d_dbh <- ggplot() + 
  geom_point(data=DBHgl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='300-450 kgC m-3')) + 
  geom_point(data=DBHgl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='300-600 kgC m-3')) + 
  scale_color_manual("Level of LUE", breaks = c("300-450 kgC m-3", "300-600 kgC m-3"), values = c("#E7B800" ,"#FC4E07"))+
  labs(x="dNPP/NPP", y="dB/B") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  #scale_x_continuous(limits = c(0,0.5)) + scale_y_continuous(limits = c(0,0.5)) +
  ggtitle("d)") #+ geom_abline(slope=1, intercept = 0.0, linetype="dashed")

# Mortality as a function of NSC

# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea1sb3NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))
NPP15 <- ea1sb2NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))
NPP0  <- ea1sb1NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

B30 <- ea1sb3NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B30=mean(plantC))
B15 <- ea1sb2NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B15=mean(plantC))
B0  <- ea1sb1NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB15_30 <- (B30$B30 - B15$B15)/B15$B15
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

NSCgl_RelChange_0_15 <- data.frame(dNPP0_15,dB0_15)
NSCgl_RelChange_15_30 <- data.frame(dNPP15_30,dB15_30)
NSCgl_RelChange_0_30 <- data.frame(dNPP0_30,dB0_30)

fig2d_nsc <- ggplot() + 
  geom_point(data=NSCgl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='300-450 kgC m-3')) + 
  geom_point(data=NSCgl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='300-600 kgC m-3')) + 
  scale_color_manual("Level of LUE", breaks = c("300-450 kgC m-3", "300-600 kgC m-3"), values = c("#E7B800" ,"#FC4E07"))+
  labs(x="dNPP/NPP", y="dB/B")+
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) +  
  #scale_x_continuous(limits = c(0,0.5)) + scale_y_continuous(limits = c(0,0.5)) +
  ggtitle("d)") #+ geom_abline(slope=1, intercept = 0.0, linetype="dashed")

# Mortality as a function of NSC

# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea1sb3GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))
NPP15 <- ea1sb2GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))
NPP0  <- ea1sb1GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

B30 <- ea1sb3GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B30=mean(plantC))
B15 <- ea1sb2GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B15=mean(plantC))
B0  <- ea1sb1GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(B0=mean(plantC))
dB0_15 <- (B15$B15 - B0$B0)/B0$B0
dB15_30 <- (B30$B30 - B15$B15)/B15$B15
dB0_30 <- (B30$B30 - B0$B0)/B0$B0

GRgl_RelChange_0_15 <- data.frame(dNPP0_15,dB0_15)
GRgl_RelChange_15_30 <- data.frame(dNPP15_30,dB15_30)
GRgl_RelChange_0_30 <- data.frame(dNPP0_30,dB0_30)

fig2d_gr <- ggplot() + 
  geom_point(data=GRgl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='300-450 kgC m-3')) + 
  geom_point(data=GRgl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='300-600 kgC m-3')) + 
  scale_color_manual("Level of LUE", breaks = c("300-450 kgC m-3", "300-600 kgC m-3"), values = c("#E7B800" ,"#FC4E07"))+
  labs(x="dNPP/NPP", y="dB/B")+
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) +   
  #scale_x_continuous(limits = c(0,0.5)) + scale_y_continuous(limits = c(0,0.5)) +
  ggtitle("d)") #+ geom_abline(slope=1, intercept = 0.0, linetype="dashed")

```

### e) Relative change mortality vs. NPP

Level of LUE

```{r, fig.width = 5, fig.height = 5}

# Mortality as a function of DBH

# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea1sb3DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  #NPP or A_NPP
NPP15 <- ea1sb2DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sb1DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

M30 <- ea1sb3DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M30=mean(c_deadtrees)) #plantC or A_Biomass
M15 <- ea1sb2DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M15=mean(c_deadtrees))
M0  <- ea1sb1DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M0=mean(c_deadtrees))
dM0_15 <- (M15$M15 - M0$M0)/M0$M0
dM15_30 <- (M30$M30 - M15$M15)/M15$M15
dM0_30 <- (M30$M30 - M0$M0)/M0$M0

DBHgl_RelChange_0_15 <- data.frame(dNPP0_15,dM0_15)
DBHgl_RelChange_15_30 <- data.frame(dNPP15_30,dM15_30)
DBHgl_RelChange_0_30 <- data.frame(dNPP0_30,dM0_30)

fig2e_dbh <- ggplot() + 
  geom_point(data=DBHgl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='300-450 kgC m-3')) + 
  geom_point(data=DBHgl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='300-600 kgC m-3')) + 
  scale_color_manual("Level of WD", breaks = c("300-450 kgC m-3", "300-600 kgC m-3"), values = c("#E7B800" ,"#FC4E07"))+
  labs(x="dNPP/NPP", y="dB/B") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  #scale_x_continuous(limits = c(0,0.5)) + scale_y_continuous(limits = c(0,0.5)) +
  ggtitle("e)") #+ geom_abline(slope=1, intercept = 0.0, linetype="dashed")

# Mortality as a function of NSC

# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea1sb3NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))
NPP15 <- ea1sb2NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))
NPP0  <- ea1sb1NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

M30 <- ea1sb3NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M30=mean(c_deadtrees)) #plantC or A_Biomass
M15 <- ea1sb2NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M15=mean(c_deadtrees))
M0  <- ea1sb1NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M0=mean(c_deadtrees))
dM0_15 <- (M15$M15 - M0$M0)/M0$M0
dM15_30 <- (M30$M30 - M15$M15)/M15$M15
dM0_30 <- (M30$M30 - M0$M0)/M0$M0

NSCgl_RelChange_0_15 <- data.frame(dNPP0_15,dM0_15)
NSCgl_RelChange_15_30 <- data.frame(dNPP15_30,dM15_30)
NSCgl_RelChange_0_30 <- data.frame(dNPP0_30,dM0_30)

fig2e_nsc <- ggplot() + 
  geom_point(data=NSCgl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='300-450 kgC m-3')) + 
  geom_point(data=NSCgl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='300-600 kgC m-3')) + 
  scale_color_manual("Level of WD", breaks = c("300-450 kgC m-3", "300-600 kgC m-3"), values = c("#E7B800" ,"#FC4E07"))+
  labs(x="dNPP/NPP", y="dB/B") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  #scale_x_continuous(limits = c(0,0.5)) + scale_y_continuous(limits = c(0,0.5)) +
  ggtitle("e)") #+ geom_abline(slope=1, intercept = 0.0, linetype="dashed")

# Mortality as a function of NSC

# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea1sb3GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))
NPP15 <- ea1sb2GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))
NPP0  <- ea1sb1GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

M30 <- ea1sb3GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M30=mean(c_deadtrees)) #plantC or A_Biomass
M15 <- ea1sb2GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M15=mean(c_deadtrees))
M0  <- ea1sb1GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(M0=mean(c_deadtrees))
dM0_15 <- (M15$M15 - M0$M0)/M0$M0
dM15_30 <- (M30$M30 - M15$M15)/M15$M15
dM0_30 <- (M30$M30 - M0$M0)/M0$M0

GRgl_RelChange_0_15 <- data.frame(dNPP0_15,dM0_15)
GRgl_RelChange_15_30 <- data.frame(dNPP15_30,dM15_30)
GRgl_RelChange_0_30 <- data.frame(dNPP0_30,dM0_30)

fig2e_gr <- ggplot() + 
  geom_point(data=GRgl_RelChange_0_15, aes(x=dNPP0_15, y=dB0_15, color='300-450 kgC m-3')) + 
  geom_point(data=GRgl_RelChange_0_30, aes(x=dNPP0_30, y=dB0_30, color='300-600 kgC m-3')) + 
  scale_color_manual("Level of WD", breaks = c("300-450 kgC m-3", "300-600 kgC m-3"), values = c("#E7B800" ,"#FC4E07"))+
  labs(x="dNPP/NPP", y="dB/B") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  #scale_x_continuous(limits = c(0,0.5)) + scale_y_continuous(limits = c(0,0.5)) +
  ggtitle("e)") #+ geom_abline(slope=1, intercept = 0.0, linetype="dashed")


```

### f) Relative change k vs. NPP

Level of LUE

```{r, fig.width = 5, fig.height = 5}

# Mortality as a function of DBH

# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea1sb3DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  #NPP or A_NPP
NPP15 <- ea1sb2DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sb1DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

k30 <- ea1sb3DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k30=mean(1/c_turnover_time)) 
k15 <- ea1sb2DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k15=mean(1/c_turnover_time))
k0  <- ea1sb1DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k0=mean(1/c_turnover_time))
dk0_15 <- (k15$k15 - k0$k0)/k0$k0
dk15_30 <- (k30$k30 - k15$k15)/k15$k15
dk0_30 <- (k30$k30 - k0$k0)/k0$k0

DBHgl_RelChange_0_15 <- data.frame(dNPP0_15,dk0_15)
DBHgl_RelChange_15_30 <- data.frame(dNPP15_30,dk15_30)
DBHgl_RelChange_0_30 <- data.frame(dNPP0_30,dk0_30)

fig2f_dbh <- ggplot() + 
  geom_point(data=DBHgl_RelChange_0_15, aes(x=dNPP0_15, y=dk0_15, color='300-450 kgC m-3')) + 
  geom_point(data=DBHgl_RelChange_0_30, aes(x=dNPP0_30, y=dk0_30, color='300-600 kgC m-3')) + 
  scale_color_manual("Level of WD", breaks = c("300-450 kgC m-3", "300-600 kgC m-3"), values = c("#E7B800" ,"#FC4E07"))+
  labs(x="dNPP/NPP", y="dk/k") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  #scale_x_continuous(limits = c(0,0.5)) + scale_y_continuous(limits = c(0,0.5)) +
  ggtitle("f)") #+ geom_abline(slope=1, intercept = 0.0, linetype="dashed")

# Mortality as a function of NSC

# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea1sb3NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))
NPP15 <- ea1sb2NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))
NPP0  <- ea1sb1NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

k30 <- ea1sb3NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k30=mean(1/c_turnover_time)) 
k15 <- ea1sb2NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k15=mean(1/c_turnover_time))
k0  <- ea1sb1NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k0=mean(1/c_turnover_time))
dk0_15 <- (k15$k15 - k0$k0)/k0$k0
dk15_30 <- (k30$k30 - k15$k15)/k15$k15
dk0_30 <- (k30$k30 - k0$k0)/k0$k0

NSCgl_RelChange_0_15 <- data.frame(dNPP0_15,dk0_15)
NSCgl_RelChange_15_30 <- data.frame(dNPP15_30,dk15_30)
NSCgl_RelChange_0_30 <- data.frame(dNPP0_30,dk0_30)

fig2f_nsc <- ggplot() + 
  geom_point(data=NSCgl_RelChange_0_15, aes(x=dNPP0_15, y=dk0_15, color='300-450 kgC m-3')) + 
  geom_point(data=NSCgl_RelChange_0_30, aes(x=dNPP0_30, y=dk0_30, color='300-600 kgC m-3')) + 
  scale_color_manual("Level of WD", breaks = c("300-450 kgC m-3", "300-600 kgC m-3"), values = c("#E7B800" ,"#FC4E07"))+
  labs(x="dNPP/NPP", y="dk/k") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  #scale_x_continuous(limits = c(0,0.5)) + scale_y_continuous(limits = c(0,0.5)) +
  ggtitle("f)") #+ geom_abline(slope=1, intercept = 0.0, linetype="dashed")

# Mortality as a function of NSC

# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea1sb3GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))
NPP15 <- ea1sb2GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))
NPP0  <- ea1sb1GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

k30 <- ea1sb3GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k30=mean(1/c_turnover_time)) 
k15 <- ea1sb2GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k15=mean(1/c_turnover_time))
k0  <- ea1sb1GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(k0=mean(1/c_turnover_time))
dk0_15 <- (k15$k15 - k0$k0)/k0$k0
dk15_30 <- (k30$k30 - k15$k15)/k15$k15
dk0_30 <- (k30$k30 - k0$k0)/k0$k0

GRgl_RelChange_0_15 <- data.frame(dNPP0_15,dk0_15)
GRgl_RelChange_15_30 <- data.frame(dNPP15_30,dk15_30)
GRgl_RelChange_0_30 <- data.frame(dNPP0_30,dk0_30)

fig2f_gr <- ggplot() + 
  geom_point(data=GRgl_RelChange_0_15, aes(x=dNPP0_15, y=dk0_15, color='300-450 kgC m-3')) + 
  geom_point(data=GRgl_RelChange_0_30, aes(x=dNPP0_30, y=dk0_30, color='300-600 kgC m-3')) + 
  scale_color_manual("Level of LUE", breaks = c("300-450 kgC m-3", "300-600 kgC m-3"), values = c("#E7B800" ,"#FC4E07"))+
  labs(x="dNPP/NPP", y="dk/k") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  #scale_x_continuous(limits = c(0,0.5)) + scale_y_continuous(limits = c(0,0.5)) +
  ggtitle("f)") #+ geom_abline(slope=1, intercept = 0.0, linetype="dashed")

```

### f*) Carbon Turnover time vs. time

From annual_tile_output: c_turnover_time 
Level of rho_wood

```{r, fig.width = 5, fig.height = 5}
# Mortality as a function of DBH
Tau_DBH_WD <- ggplot() + 
  geom_line(data=ea1sb1DBHgl_out_annual_tile, aes(x=year, y=c_turnover_time, color='300 kgC m-3')) +
  geom_line(data=ea1sb2DBHgl_out_annual_tile, aes(x=year, y=c_turnover_time, color='450 kgC m-3')) +
  geom_line(data=ea1sb3DBHgl_out_annual_tile, aes(x=year, y=c_turnover_time, color='600 kgC m-3')) +
  scale_color_manual("Levels of WD", breaks = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"), values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(x = "Year", y = expression(paste("Carbon turnover time ( ", tau, " , ", yr, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "a) Size-dependent mortality")

# Mortality as a function of C starvation
Tau_NSC_LUE <- ggplot() + 
  geom_line(data=ea1sb1NSCgl_out_annual_tile, aes(x=year, y=c_turnover_time, color='300 kgC m-3')) +
  geom_line(data=ea1sb2NSCgl_out_annual_tile, aes(x=year, y=c_turnover_time, color='450 kgC m-3')) +
  geom_line(data=ea1sb3NSCgl_out_annual_tile, aes(x=year, y=c_turnover_time, color='600 kgC m-3')) +
  scale_color_manual("Levels of WD", breaks = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"), values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(x = "Year", y = expression(paste("Carbon turnover time ( ", tau, " , ", yr, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "Tree mortality as a fc. of C starvation")
  
# Mortality as a function of Growth rate
Tau_GR_LUE <- ggplot() + 
  geom_line(data=ea1sb1GRgl_out_annual_tile, aes(x=year, y=c_turnover_time, color='300 kgC m-3')) +
  geom_line(data=ea1sb2GRgl_out_annual_tile, aes(x=year, y=c_turnover_time, color='450 kgC m-3')) +
  geom_line(data=ea1sb3GRgl_out_annual_tile, aes(x=year, y=c_turnover_time, color='600 kgC m-3')) +
  scale_color_manual("Levels of WD", breaks = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"), values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(x = "Year", y = expression(paste("Carbon turnover time ( ", tau, " , ", yr, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "Tree mortality as a fc. of growth rate")
  
# Mortality as a function of Self-thinning
#Tau_CST_LUE <- 
  
```

### g) Longevity vs. growth rates

Hypothesis: The negative relationship between longevity vs. growth rates arises from variations between (across) species, but disappears when looking at variations between sites (within sps).

Two plots:

- Different species at a given site: x = growth rate, y = longevity (or 1/mortality). Each point is one species (differing by wood density, root:shoot ratio). Add info either by using color ~site (given LUE, growing season length, PAR); or by combining data from multiple sites and normalizing growth rates and longevity by site-level mean.
- Same species at different sites (differing by LUE, growing season length, PAR): x = growth rate, y = longevity. Each point is one site (show mean and standard deviations with x and y errorbars)

- longevity is maximum age at tile-level, plot mean across multiple years after spinup
- plot change in DBH instead of NPP. Take the oldest cohort, and calculate DBH/age


```{r, fig.width = 5, fig.height = 5}

# Mortality as a function of DBH
ea1sb1DBHgl_out_annual_tileMaxAgg <- ea1sb1DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), maxAge_sd=sd(MaxAge,na.rm=T),
          MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), MaxDBH_MaxAge_sd=sd(MaxDBH_MaxAge,na.rm=T),
          NPP_mean=mean(NPP,na.rm=T), NPP_sd=sd(NPP,na.rm=T))

ea1sb2DBHgl_out_annual_tileMaxAgg <- ea1sb2DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), maxAge_sd=sd(MaxAge,na.rm=T),
          MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), MaxDBH_MaxAge_sd=sd(MaxDBH_MaxAge,na.rm=T),
          NPP_mean=mean(NPP,na.rm=T), NPP_sd=sd(NPP,na.rm=T))

ea1sb3DBHgl_out_annual_tileMaxAgg <- ea1sb3DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), maxAge_sd=sd(MaxAge,na.rm=T),
          MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), MaxDBH_MaxAge_sd=sd(MaxDBH_MaxAge,na.rm=T),
          NPP_mean=mean(NPP,na.rm=T), NPP_sd=sd(NPP,na.rm=T))

fig2g1_dbh <- ggplot() + 
  geom_point(data=ea1sb1DBHgl_out_annual_tileMaxAgg, aes(x=NPP_mean, y=maxAge_mean, color='300 kgC m-3')) + 
  geom_point(data=ea1sb2DBHgl_out_annual_tileMaxAgg, aes(x=NPP_mean, y=maxAge_mean, color='450 kgC m-3')) +
  geom_point(data=ea1sb3DBHgl_out_annual_tileMaxAgg, aes(x=NPP_mean, y=maxAge_mean, color='600 kgC m-3')) +
  scale_color_manual("Levels of WD", breaks = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"), values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(x = expression(paste("NPP (Kg C ",yr^-1,  ") ")), y = "Longevity (years)") +  
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "g1)")

# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea1sb3DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  #NPP or A_NPP
NPP15 <- ea1sb2DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sb1DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

L30 <- ea1sb3DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L30=mean(MaxAge)) 
L15 <- ea1sb2DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L15=mean(MaxAge))
L0  <- ea1sb1DBHgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L0=mean(MaxAge))
dL0_15 <- (L15$L15 - L0$L0)/L0$L0
dL15_30 <- (L30$L30 - L15$L15)/L15$L15
dL0_30 <- (L30$L30 - L0$L0)/L0$L0

DBHgl_RelChange_0_15 <- data.frame(dNPP0_15,dL0_15)
DBHgl_RelChange_15_30 <- data.frame(dNPP15_30,dL15_30)
DBHgl_RelChange_0_30 <- data.frame(dNPP0_30,dL0_30)

fig2g2_dbh <- ggplot() + 
  geom_point(data=DBHgl_RelChange_0_15, aes(x=dNPP0_15, y=dL0_15, color='300-450 kgC m-3')) + 
  geom_point(data=DBHgl_RelChange_0_30, aes(x=dNPP0_30, y=dL0_30, color='300-600 kgC m-3')) + 
  scale_color_manual("Level of LUE", breaks = c("300-450 kgC m-3", "300-600 kgC m-3"), values = c("#E7B800" ,"#FC4E07"))+
  labs(x="dNPP/NPP", y="dL/L") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  ggtitle("g2)") #+ geom_abline(slope=-1, intercept = 0.0, linetype="dashed")

# Mortality as a function of NSC
ea1sb1NSCgl_out_annual_tileMaxAgg <- ea1sb1NSCgl_out_annual_tile %>% dplyr::filter(year>=1500&year<=1801) %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), maxAge_sd=sd(MaxAge,na.rm=T),
          MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), MaxDBH_MaxAge_sd=sd(MaxDBH_MaxAge,na.rm=T))

ea1sb2NSCgl_out_annual_tileMaxAgg <- ea1sb2NSCgl_out_annual_tile %>% dplyr::filter(year>=1500&year<=1801) %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), maxAge_sd=sd(MaxAge,na.rm=T),DBH_mean=mean(DBH,na.rm=T), DBH_sd=sd(DBH,na.rm=T),MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), MaxDBH_MaxAge_sd=sd(MaxDBH_MaxAge,na.rm=T))

ea1sb3NSCgl_out_annual_tileMaxAgg <- ea1sb3NSCgl_out_annual_tile %>% dplyr::filter(year>=1500&year<=1801) %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), maxAge_sd=sd(MaxAge,na.rm=T),DBH_mean=mean(DBH,na.rm=T), DBH_sd=sd(DBH,na.rm=T),MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), MaxDBH_MaxAge_sd=sd(MaxDBH_MaxAge,na.rm=T))

fig2g1_nsc <- ggplot() + 
  geom_point(data=ea1sb1NSCgl_out_annual_tileMaxAgg, aes(x=MaxDBH_MaxAge_mean, y=maxAge_mean, color='300 kgC m-3')) + 
  geom_point(data=ea1sb2NSCgl_out_annual_tileMaxAgg, aes(x=MaxDBH_MaxAge_mean, y=maxAge_mean, color='450 kgC m-3')) +
  geom_point(data=ea1sb3NSCgl_out_annual_tileMaxAgg, aes(x=MaxDBH_MaxAge_mean, y=maxAge_mean, color='600 kgC m-3')) +
  scale_color_manual("Levels of WD", breaks = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"), values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(x = expression(paste("Growth rate (mm ",yr^-1,  ") ")), y = "Longevity") +  
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "Tree mortality as a fc. of C starvation")

# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea1sb3NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  #NPP or A_NPP
NPP15 <- ea1sb2NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sb1NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

L30 <- ea1sb3NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L30=mean(MaxAge)) 
L15 <- ea1sb2NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L15=mean(MaxAge))
L0  <- ea1sb1NSCgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L0=mean(MaxAge))
dL0_15 <- (L15$L15 - L0$L0)/L0$L0
dL15_30 <- (L30$L30 - L15$L15)/L15$L15
dL0_30 <- (L30$L30 - L0$L0)/L0$L0

NSCgl_RelChange_0_15 <- data.frame(dNPP0_15,dL0_15)
NSCgl_RelChange_15_30 <- data.frame(dNPP15_30,dL15_30)
NSCgl_RelChange_0_30 <- data.frame(dNPP0_30,dL0_30)

fig2g2_nsc <- ggplot() + 
  geom_point(data=NSCgl_RelChange_0_15, aes(x=dNPP0_15, y=dL0_15, color='300-450 kgC m-3')) + 
  geom_point(data=NSCgl_RelChange_0_30, aes(x=dNPP0_30, y=dL0_30, color='300-600 kgC m-3')) + 
  scale_color_manual("Level of LUE", breaks = c("300-450 kgC m-3", "300-600 kgC m-3"), values = c("#E7B800" ,"#FC4E07"))+
  labs(x="dNPP/NPP", y="dL/L") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  ggtitle("g2)") #+ geom_abline(slope=-1, intercept = 0.0, linetype="dashed")

# Mortality as a function of GR
ea1sb1GRgl_out_annual_tileMaxAgg <- ea1sb1GRgl_out_annual_tile %>% dplyr::filter(year>=1500&year<=1801) %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), maxAge_sd=sd(MaxAge,na.rm=T),
          MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), MaxDBH_MaxAge_sd=sd(MaxDBH_MaxAge,na.rm=T))

ea1sb2GRgl_out_annual_tileMaxAgg <- ea1sb2GRgl_out_annual_tile %>% dplyr::filter(year>=1500&year<=1801) %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), maxAge_sd=sd(MaxAge,na.rm=T),DBH_mean=mean(DBH,na.rm=T), DBH_sd=sd(DBH,na.rm=T),MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), MaxDBH_MaxAge_sd=sd(MaxDBH_MaxAge,na.rm=T))

ea1sb3GRgl_out_annual_tileMaxAgg <- ea1sb3GRgl_out_annual_tile %>% dplyr::filter(year>=1500&year<=1801) %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), maxAge_sd=sd(MaxAge,na.rm=T),DBH_mean=mean(DBH,na.rm=T), DBH_sd=sd(DBH,na.rm=T),MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), MaxDBH_MaxAge_sd=sd(MaxDBH_MaxAge,na.rm=T))

fig2g1_nsc <- ggplot() + 
  geom_point(data=ea1sb1GRgl_out_annual_tileMaxAgg, aes(x=MaxDBH_MaxAge_mean, y=maxAge_mean, color='300 kgC m-3')) + 
  geom_point(data=ea1sb2GRgl_out_annual_tileMaxAgg, aes(x=MaxDBH_MaxAge_mean, y=maxAge_mean, color='450 kgC m-3')) +
  geom_point(data=ea1sb3GRgl_out_annual_tileMaxAgg, aes(x=MaxDBH_MaxAge_mean, y=maxAge_mean, color='600 kgC m-3')) +
  scale_color_manual("Levels of WD", breaks = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"), values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(x = expression(paste("Growth rate (mm ",yr^-1,  ") ")), y = "Longevity") +  
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "g1)")

# Calculate the relative change as (Final value - initial value)/initial value
NPP30 <- ea1sb3GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP30=mean(NPP))  #NPP or A_NPP
NPP15 <- ea1sb2GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP15=mean(NPP))  
NPP0  <- ea1sb1GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(NPP0=mean(NPP))
dNPP0_15 <- (NPP15$NPP15 - NPP0$NPP0)/NPP0$NPP0
dNPP15_30 <- (NPP30$NPP30 - NPP15$NPP15)/NPP15$NPP15
dNPP0_30 <- (NPP30$NPP30 - NPP0$NPP0)/NPP0$NPP0

L30 <- ea1sb3GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L30=mean(MaxAge)) 
L15 <- ea1sb2GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L15=mean(MaxAge))
L0  <- ea1sb1GRgl_out_annual_tile %>% dplyr::filter(year>=700&year<=1500) %>% summarise(L0=mean(MaxAge))
dL0_15 <- (L15$L15 - L0$L0)/L0$L0
dL15_30 <- (L30$L30 - L15$L15)/L15$L15
dL0_30 <- (L30$L30 - L0$L0)/L0$L0

GRgl_RelChange_0_15 <- data.frame(dNPP0_15,dL0_15)
GRgl_RelChange_15_30 <- data.frame(dNPP15_30,dL15_30)
GRgl_RelChange_0_30 <- data.frame(dNPP0_30,dL0_30)

fig2g2_gr <- ggplot() + 
  geom_point(data=GRgl_RelChange_0_15, aes(x=dNPP0_15, y=dL0_15, color='300-450 kgC m-3')) + 
  geom_point(data=GRgl_RelChange_0_30, aes(x=dNPP0_30, y=dL0_30, color='300-600 kgC m-3')) + 
  scale_color_manual("Level of LUE", breaks = c("300-450 kgC m-3", "300-600 kgC m-3"), values = c("#E7B800" ,"#FC4E07"))+
  labs(x="dNPP/NPP", y="dL/L") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  ggtitle("g2)") #+ geom_abline(slope=-1, intercept = 0.0, linetype="dashed")

```

### h) Self-thinning relationship

From annual_tile_output: QMD and Density12
Level of rho_wood

```{r, fig.width = 5, fig.height = 5}

# Mortality as a function of DBH
data1 <- rbind(ea1sb1DBHgl_out_annual_tile, ea1sb2DBHgl_out_annual_tile, ea1sb3DBHgl_out_annual_tile)
fig2h_dbh <- ggplot() + 
  geom_point(data=subset(data1, year>=750), aes(x=log(QMD), y=log(Density12), color=as.factor(LevelWD)),alpha=1) + 
  geom_smooth(data=subset(data1, year>=750), aes(x=log(QMD), y=log(Density12), color=as.factor(LevelWD)),method = "lm",fullrange = T) +
  scale_color_manual(labels = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"),values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(col = "Species", x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  ggtitle("h)") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))

# Mortality as a function of NSC
data1 <- rbind(ea1sb1NSCgl_out_annual_tile, ea1sb2NSCgl_out_annual_tile, ea1sb3NSCgl_out_annual_tile)
fig2h_nsc <- ggplot() + 
  geom_point(data=subset(data1, year>=750), aes(x=log(QMD), y=log(Density12), color=as.factor(LevelWD)),alpha=1) + 
  geom_smooth(data=subset(data1, year>=750), aes(x=log(QMD), y=log(Density12), color=as.factor(LevelWD)),method = "lm",fullrange = T) +
  scale_color_manual(labels = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"),values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(col = "Species", x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  ggtitle("h)") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1))
  
# Mortality as a function of GR
data1 <- rbind(ea1sb1GRgl_out_annual_tile, ea1sb2GRgl_out_annual_tile, ea1sb3GRgl_out_annual_tile)
fig2h_gr <- ggplot() + 
  geom_point(data=subset(data1, year>=750), aes(x=log(QMD), y=log(Density12), color=as.factor(LevelWD)),alpha=1) + 
  geom_smooth(data=subset(data1, year>=750), aes(x=log(QMD), y=log(Density12), color=as.factor(LevelWD)),method = "lm",fullrange = T) +
  scale_color_manual(labels = c("300 kgC m-3", "450 kgC m-3", "600 kgC m-3"),values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(col = "Species", x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  ggtitle("h)") #+ 
  #scale_x_continuous(limits = c(3.4,4.1),breaks = seq(3.5,4,0.1)) + 
  #scale_y_continuous(limits = c(4.5,6.5),breaks = seq(4,7,1)) 
  
# Mortality as a function of CST

```

### Arrange plots

#### DBH
```{r, include=F, eval=T,fig.height=3,fig.width=16}
ggarrange(fig2a_dbh,fig2b_dbh,fig2c_dbh,fig2d_dbh,fig2e_dbh,fig2f_dbh,fig2g_dbh,fig2h_dbh, ncol = 8, nrow = 1, common.legend = T,legend="bottom")
ggarrange(fig2a_dbh,fig2b_dbh,fig2d_dbh,fig2f_dbh,fig2g1_dbh,fig2g2_dbh,fig2h_dbh, ncol = 7, nrow = 1, common.legend = T,legend="bottom")
ggsave("plots_dbh.tiff", width = 17, height = 2, device='tiff', dpi=300)
```

#### NSC
```{r, include=F, eval=T,fig.height=2,fig.width=17}
ggarrange(fig2a_nsc,fig2b_nsc,fig2c_nsc,fig2d_nsc,fig2e_nsc,fig2f_nsc,fig2g_nsc,fig2h_nsc, ncol = 8, nrow = 1, common.legend = T,legend="bottom")
ggsave("plots_nsc.tiff", width = 17, height = 2, device='tiff', dpi=300)
```

#### GR
```{r, include=F, eval=T,fig.height=2,fig.width=17}
ggarrange(fig2a_gr,fig2b_gr,fig2c_gr,fig2d_gr,fig2e_gr,fig2f_gr,fig2g_gr,fig2h_gr, ncol = 8, nrow = 1, common.legend = T,legend="bottom")
ggsave("plots_gr.tiff", width = 17, height = 2, device='tiff', dpi=300)
```

#### All
```{r, include=F, eval=T,fig.height=4,fig.width=12}

#ggarrange(fig2a_dbh,fig2a_nsc,fig2a_gr, ncol = 3, nrow = 1, common.legend = T,legend="bottom")
ggarrange(fig2b_dbh,fig2b_nsc,fig2b_gr, ncol = 3, nrow = 1, common.legend = T,legend="bottom")
ggarrange(fig2c_dbh,fig2c_nsc,fig2c_gr, ncol = 3, nrow = 1, common.legend = T,legend="bottom")
ggarrange(fig2d_dbh,fig2d_nsc,fig2d_gr, ncol = 3, nrow = 1, common.legend = T,legend="bottom")
ggarrange(fig2e_dbh,fig2e_nsc,fig2e_gr, ncol = 3, nrow = 1, common.legend = T,legend="bottom")
ggarrange(fig2f_dbh,fig2f_nsc,fig2f_gr, ncol = 3, nrow = 1, common.legend = T,legend="bottom")
ggarrange(fig2g1_dbh,fig2g1_nsc,fig2g1_gr, ncol = 3, nrow = 1, common.legend = T,legend="bottom")
ggarrange(fig2g2_dbh,fig2g2_nsc,fig2g2_gr, ncol = 3, nrow = 1, common.legend = T,legend="bottom")
ggarrange(fig2h_dbh,fig2h_nsc,fig2h_gr, ncol = 3, nrow = 1, common.legend = T,legend="bottom")

```

## Other plots
### Deathrate

From output_annual_cohorts: deathrate 

```{r}
# Mortality as a function of DBH
# Biomass changes in LUE with WD level 1
mortDBH1 <- ggplot() + 
  geom_line(data=subset(ec1sa1DBHgl_out_annual_cohorts,dbh>0.1), aes(x=dbh, y=deathrate, color='Control')) + 
  geom_line(data=subset(ec2sa1DBHgl_out_annual_cohorts,dbh>0.1), aes(x=dbh, y=deathrate, color='+15%')) +
  geom_line(data=subset(ec3sa1DBHgl_out_annual_cohorts,dbh>0.1), aes(x=dbh, y=deathrate, color='+30%')) +
  scale_color_manual("Levels of CO2", breaks = c("Control", "+15%", "+30%"), values = c("#F8766D" ,"#619CFF", "#00BA38"))+
  labs(x = "dbh", y = expression(paste("Canopy mortality (", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "Tree mortality as a function of size")

mortDBH2 <- ggplot() + 
  geom_line(data=subset(ec1sa1DBHgl_out_annual_cohorts,dbh<0.05), aes(x=dbh, y=deathrate, color='Control')) + 
  geom_line(data=subset(ec2sa1DBHgl_out_annual_cohorts,dbh<0.05), aes(x=dbh, y=deathrate, color='+15%')) +
  geom_line(data=subset(ec3sa1DBHgl_out_annual_cohorts,dbh<0.05), aes(x=dbh, y=deathrate, color='+30%')) +
  scale_color_manual("Levels of CO2", breaks = c("Control", "+15%", "+30%"), values = c("#F8766D" ,"#619CFF", "#00BA38"))+
  labs(x = "dbh", y = expression(paste("Understory mortality (", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "Tree mortality as a function of size")

library(ggpubr) # ggarrange

ggarrange(mortDBH2,mortDBH1,ncol = 2, nrow = 1, common.legend = T,legend="bottom")

# Mortality as a function of DBH
# Biomass changes in LUE with WD level 1
mortNSC <- ggplot() + 
  geom_line(data=ec1sa1NSCgl_out_annual_cohorts, aes(x=dbh, y=deathrate, color='Control')) + 
  geom_line(data=ec2sa1NSCgl_out_annual_cohorts, aes(x=dbh, y=deathrate, color='+15%')) +
  geom_line(data=ec3sa1NSCgl_out_annual_cohorts, aes(x=dbh, y=deathrate, color='+30%')) +
  scale_color_manual("Levels of CO2", breaks = c("Control", "+15%", "+30%"), values = c("#F8766D" ,"#619CFF", "#00BA38"))+
  labs(x = "Year", y = expression(paste("Mortality (", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
        axis.text = element_text(size = 10),axis.title = element_text(size = 11),
        legend.text = element_text(size = 10),legend.title = element_text(size = 11),
        plot.title = element_text(size = 11)) + 
  labs(title= "Tree mortality as a function of C starvation")

```

### B* vs. initial slope of (B vs. t) 
From annual_tile_output: PlantC (Biomass)

```{r, fig.width = 8, fig.height = 6}

# Mortality DBH
ggplot() + 
  geom_line(data=ea1sa1DBHgl_out_annual_tile[1:150,], aes(x=year, y=plantC, color='Control')) + 
  geom_line(data=ea2sa1DBHgl_out_annual_tile[1:150,], aes(x=year, y=plantC, color='+15%')) +
  geom_line(data=ea3sa1DBHgl_out_annual_tile[1:150,], aes(x=year, y=plantC, color='+30%')) +
  scale_color_manual("Levels of LUE", breaks = c("Control", "+15%", "+30%"), values = c("#F8766D" ,"#00BA38", "#619CFF"))+
  labs(x = "Year", y = expression(paste("Biomass (Kg C ", m^-2, " ", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")

ggplot() + 
  geom_line(data=ea1sa1DBHgl_out_annual_tile[1300:1804,], aes(x=year, y=plantC, color='Control')) + 
  geom_line(data=ea2sa1DBHgl_out_annual_tile[1300:1804,], aes(x=year, y=plantC, color='+15%')) +
  geom_line(data=ea3sa1DBHgl_out_annual_tile[1300:1804,], aes(x=year, y=plantC, color='+30%')) +
  scale_color_manual("Levels of LUE", breaks = c("Control", "+15%", "+30%"), values = c("#F8766D" ,"#00BA38", "#619CFF"))+
  labs(x = "Year", y = expression(paste("Biomass (Kg C ", m^-2, " ", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")

slope1 <- summary(lm(plantC ~ year, ea1sa1DBHgl_out_annual_tile[1:150,]))$coefficients[2,1]
sd1 <- summary(lm(plantC ~ year, ea1sa1DBHgl_out_annual_tile[1:150,]))$coefficients[2,2]
slope2 <- summary(lm(plantC ~ year, ea2sa1DBHgl_out_annual_tile[1:150,]))$coefficients[2,1]
sd2 <- summary(lm(plantC ~ year, ea2sa1DBHgl_out_annual_tile[1:150,]))$coefficients[2,2]
slope3 <- summary(lm(plantC ~ year, ea3sa1DBHgl_out_annual_tile[1:150,]))$coefficients[2,1]
sd3 <- summary(lm(plantC ~ year, ea3sa1DBHgl_out_annual_tile[1:150,]))$coefficients[2,2]

mean1 <- ea1sa1DBHgl_out_annual_tile[1300:1804,] %>% summarise(mean1=mean(plantC,na.rm=T), sd1=sd(plantC,na.rm=T))
mean2 <- ea2sa1DBHgl_out_annual_tile[1300:1804,] %>% summarise(mean2=mean(plantC,na.rm=T), sd2=sd(plantC,na.rm=T))
mean3 <- ea3sa1DBHgl_out_annual_tile[1300:1804,] %>% summarise(mean3=mean(plantC,na.rm=T), sd3=sd(plantC,na.rm=T))

slopes <- c(slope1,slope2,slope3)
sdSlopes <- c(sd1,sd2,sd3)
meanBstar <- c(mean1$mean1,mean2$mean2, mean3$mean3)
sdBstar <- c(mean1$sd1,mean2$sd2, mean3$sd3)
level <- as.factor(c("Control","+15%","+30%"))
mortality <- as.factor(c("DBH","DBH","DBH"))
dataSlopeA <- data.frame(mortality,level,slopes,sdSlopes,meanBstar,sdBstar)

ggplot(data=dataSlopeA) +
  geom_point(aes(x=slopes, y=meanBstar,color=level)) +
  geom_errorbar(aes(x = slopes, ymin=meanBstar-sdBstar, ymax=meanBstar+sdBstar, color=level),width=0) + 
  scale_color_manual("Levels of LUE", breaks = c("Control", "+15%", "+30%"), values = c("#F8766D" ,"#00BA38", "#619CFF"))+
  labs(x = "Slope of B ~ t", y = expression(paste("Mean biomass at maturity (Kg C ", m^-2, " ", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  ggtitle("Mortality formulation DBH")

# Mortality Ratio NSC and Leaf Mass
slope1 <- summary(lm(plantC ~ year, ea1sa1mb_out_annual_tile[1:150,]))$coefficients[2,1]
sd1 <- summary(lm(plantC ~ year, ea1sa1mb_out_annual_tile[1:150,]))$coefficients[2,2]
slope2 <- summary(lm(plantC ~ year, ea2sa1mb_out_annual_tile[1:150,]))$coefficients[2,1]
sd2 <- summary(lm(plantC ~ year, ea2sa1mb_out_annual_tile[1:150,]))$coefficients[2,2]
slope3 <- summary(lm(plantC ~ year, ea3sa1mb_out_annual_tile[1:150,]))$coefficients[2,1]
sd3 <- summary(lm(plantC ~ year, ea3sa1mb_out_annual_tile[1:150,]))$coefficients[2,2]

mean1 <- ea1sa1mb_out_annual_tile[1300:1804,] %>% summarise(mean1=mean(plantC,na.rm=T), sd1=sd(plantC,na.rm=T))
mean2 <- ea2sa1mb_out_annual_tile[1300:1804,] %>% summarise(mean2=mean(plantC,na.rm=T), sd2=sd(plantC,na.rm=T))
mean3 <- ea3sa1mb_out_annual_tile[1300:1804,] %>% summarise(mean3=mean(plantC,na.rm=T), sd3=sd(plantC,na.rm=T))

slopes <- c(slope1,slope2,slope3)
sdSlopes <- c(sd1,sd2,sd3)
meanBstar <- c(mean1$mean1,mean2$mean2, mean3$mean3)
sdBstar <- c(mean1$sd1,mean2$sd2, mean3$sd3)
level <- as.factor(c("Control","+15%","+30%"))
mortality <- as.factor(c("NSC/Leaf mass","NSC/Leaf mass","NSC/Leaf mass"))
dataSlopeB <- data.frame(mortality,level,slopes,sdSlopes,meanBstar,sdBstar)

ggplot(data=dataSlopeB) +
  geom_point(aes(x=slopes, y=meanBstar,color=level)) +
  geom_errorbar(aes(x = slopes, ymin=meanBstar-sdBstar, ymax=meanBstar+sdBstar, color=level),width=0) + 
  scale_color_manual("Levels of LUE", breaks = c("Control", "+15%", "+30%"), values = c("#F8766D" ,"#00BA38", "#619CFF"))+
  labs(x = "Slope of B ~ t", y = expression(paste("Mean biomass at maturity (Kg C ", m^-2, " ", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  ggtitle("Mortality formulation Ratio NSC - Leaf mass")

# Mortality Growth rate
slope1 <- summary(lm(plantC ~ year, ea1sa1mc_out_annual_tile[1:150,]))$coefficients[2,1]
sd1 <- summary(lm(plantC ~ year, ea1sa1mc_out_annual_tile[1:150,]))$coefficients[2,2]
slope2 <- summary(lm(plantC ~ year, ea2sa1mc_out_annual_tile[1:150,]))$coefficients[2,1]
sd2 <- summary(lm(plantC ~ year, ea2sa1mc_out_annual_tile[1:150,]))$coefficients[2,2]
slope3 <- summary(lm(plantC ~ year, ea3sa1mc_out_annual_tile[1:150,]))$coefficients[2,1]
sd3 <- summary(lm(plantC ~ year, ea3sa1mc_out_annual_tile[1:150,]))$coefficients[2,2]

mean1 <- ea1sa1mc_out_annual_tile[1300:1804,] %>% summarise(mean1=mean(plantC,na.rm=T), sd1=sd(plantC,na.rm=T))
mean2 <- ea2sa1mc_out_annual_tile[1300:1804,] %>% summarise(mean2=mean(plantC,na.rm=T), sd2=sd(plantC,na.rm=T))
mean3 <- ea3sa1mc_out_annual_tile[1300:1804,] %>% summarise(mean3=mean(plantC,na.rm=T), sd3=sd(plantC,na.rm=T))

slopes <- c(slope1,slope2,slope3)
sdSlopes <- c(sd1,sd2,sd3)
meanBstar <- c(mean1$mean1,mean2$mean2, mean3$mean3)
sdBstar <- c(mean1$sd1,mean2$sd2, mean3$sd3)
level <- as.factor(c("Control","+15%","+30%"))
mortality <- as.factor(c("Growth ratio","Growth ratio","Growth ratio"))
dataSlopeC <- data.frame(mortality,level,slopes,sdSlopes,meanBstar,sdBstar)

ggplot(data=dataSlopeC) +
  geom_point(aes(x=slopes, y=meanBstar,color=level)) +
  geom_errorbar(aes(x = slopes, ymin=meanBstar-sdBstar, ymax=meanBstar+sdBstar, color=level),width=0) + 
  scale_color_manual("Levels of LUE", breaks = c("Control", "+15%", "+30%"), values = c("#F8766D" ,"#00BA38", "#619CFF"))+
  labs(x = "Slope of B ~ t", y = expression(paste("Mean biomass at maturity (Kg C ", m^-2, " ", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  ggtitle("Mortality formulation Growth rate")

# Mortality Constrant self-thinning
slope1 <- summary(lm(plantC ~ year, ea1sa1md_out_annual_tile[1:150,]))$coefficients[2,1]
sd1 <- summary(lm(plantC ~ year, ea1sa1md_out_annual_tile[1:150,]))$coefficients[2,2]
slope2 <- summary(lm(plantC ~ year, ea2sa1md_out_annual_tile[1:150,]))$coefficients[2,1]
sd2 <- summary(lm(plantC ~ year, ea2sa1md_out_annual_tile[1:150,]))$coefficients[2,2]
slope3 <- summary(lm(plantC ~ year, ea3sa1md_out_annual_tile[1:150,]))$coefficients[2,1]
sd3 <- summary(lm(plantC ~ year, ea3sa1md_out_annual_tile[1:150,]))$coefficients[2,2]

mean1 <- ea1sa1md_out_annual_tile[1300:1804,] %>% summarise(mean1=mean(plantC,na.rm=T), sd1=sd(plantC,na.rm=T))
mean2 <- ea2sa1md_out_annual_tile[1300:1804,] %>% summarise(mean2=mean(plantC,na.rm=T), sd2=sd(plantC,na.rm=T))
mean3 <- ea3sa1md_out_annual_tile[1300:1804,] %>% summarise(mean3=mean(plantC,na.rm=T), sd3=sd(plantC,na.rm=T))

slopes <- c(slope1,slope2,slope3)
sdSlopes <- c(sd1,sd2,sd3)
meanBstar <- c(mean1$mean1,mean2$mean2, mean3$mean3)
sdBstar <- c(mean1$sd1,mean2$sd2, mean3$sd3)
level <- as.factor(c("Control","+15%","+30%"))
mortality <- as.factor(c("Constant self-thinning","Constant self-thinning","Constant self-thinning"))
dataSlopeD <- data.frame(mortality,level,slopes,sdSlopes,meanBstar,sdBstar)

ggplot(data=dataSlopeD) +
  geom_point(aes(x=slopes, y=meanBstar,color=level)) +
  geom_errorbar(aes(x = slopes, ymin=meanBstar-sdBstar, ymax=meanBstar+sdBstar, color=level),width=0) + 
  scale_color_manual("Levels of LUE", breaks = c("Control", "+15%", "+30%"), values = c("#F8766D" ,"#00BA38", "#619CFF"))+
  labs(x = "Slope of B ~ t", y = expression(paste("Mean biomass at maturity (Kg C ", m^-2, " ", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  ggtitle("Mortality formulation Growth rate")

# facet_wrap
dataSlope <- rbind(dataSlopeA, dataSlopeB, dataSlopeC,dataSlopeD)

ggplot(data=dataSlope) +
  geom_point(aes(x=slopes, y=meanBstar,color=level)) + facet_wrap(~ mortality, ncol=4)+
  geom_errorbar(aes(x = slopes, ymin=meanBstar-sdBstar, ymax=meanBstar+sdBstar, color=level),width=0) + 
  scale_color_manual(labels = c("Control", "+15%", "+30%"), values = c("#F8766D" ,"#00BA38", "#619CFF"))+
  labs(col = "Levels of LUE",x = "Slope of B ~ t", y = expression(paste("Mean biomass at maturity (Kg C ", m^-2, " ", yr^-1, ") "))) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")

```

### B* at maturity

From new annual_tile_output

```{r}

# Changes in LUE with WD level 1
ggplot() + 
  geom_point(data=ea1sa1DBHgl_out_annual_tile[50:1804,], aes(x=log(QMD), y=log(Density12), color='Control')) + 
  geom_point(data=ea2sa1DBHgl_out_annual_tile[50:1804,], aes(x=log(QMD), y=log(Density12), color='+15%')) +
  geom_point(data=ea3sa1DBHgl_out_annual_tile[50:1804,], aes(x=log(QMD), y=log(Density12), color='+30%')) +
  scale_color_manual("Levels of LUE at WD 1", breaks = c("Control", "+15%", "+30%"), values = c("#F8766D" ,"#00BA38", "#619CFF"))+
  scale_y_continuous(limits = c(3.5,8)) +
  labs(x = "Ln(QMD)", y = "Ln(N)") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  geom_abline(intercept = coef(lm(log(Density12) ~ log(QMD), data = ea1sa1DBHgl_out_annual_tile[50:1804,]))[1], 
              slope = coef(lm(log(Density12) ~ log(QMD), data = ea1sa1DBHgl_out_annual_tile[50:1804,]))[2], color="#F8766D") +
  geom_abline(intercept = coef(lm(log(Density12) ~ log(QMD), data = ea2sa1DBHgl_out_annual_tile[50:1804,]))[1], 
              slope = coef(lm(log(Density12) ~ log(QMD), data = ea2sa1DBHgl_out_annual_tile[50:1804,]))[2], color="#00BA38") +
  geom_abline(intercept = coef(lm(log(Density12) ~ log(QMD), data = ea3sa1DBHgl_out_annual_tile[50:1804,]))[1], 
              slope = coef(lm(log(Density12) ~ log(QMD), data = ea3sa1DBHgl_out_annual_tile[50:1804,]))[2], color="#619CFF")

lm1 <- lm(log(Density12) ~ log(QMD), data = ea1sa1DBHgl_out_annual_tile[50:1804,])
summary(lm1)
new1 <- data.frame(QMD = seq(0.1, 1, 0.1))
predictedDensity1 <- predict(lm1, new1)
new1 <- data.frame(QMD = seq(0.1, 1, 0.1),predictedDensity1)

lm2 <- lm(log(Density12) ~ log(QMD), data = ea2sa1DBHgl_out_annual_tile[50:1804,])
summary(lm2)
new2 <- data.frame(QMD = seq(0.1, 1, 0.1))
predictedDensity2 <- predict(lm2, new2)
new2 <- data.frame(QMD = seq(0.1, 1, 0.1),predictedDensity2)

lm3 <- lm(log(Density12) ~ log(QMD), data = ea3sa1DBHgl_out_annual_tile[50:1804,])
summary(lm3)
new3 <- data.frame(QMD = seq(0.1, 1, 0.1))
predictedDensity3 <- predict(lm3, new3)
new3 <- data.frame(QMD = seq(0.1, 1, 0.1),predictedDensity3)

BiomassMaturityLUE1WD1 <- ea1sa1DBHgl_out_annual_tile[1300:1804,] %>% summarise(B_star = mean(plantC,na.rm=T)) %>% mutate(N_QMD = new1[5,2])
BiomassMaturityLUE2WD1 <- ea2sa1DBHgl_out_annual_tile[1300:1804,] %>% summarise(B_star = mean(plantC,na.rm=T)) %>% mutate(N_QMD = new2[5,2])
BiomassMaturityLUE3WD1 <- ea3sa1DBHgl_out_annual_tile[1300:1804,] %>% summarise(B_star = mean(plantC,na.rm=T)) %>% mutate(N_QMD = new3[5,2])

ggplot() + 
  geom_point(data=BiomassMaturityLUE1WD1, aes(x=N_QMD, y=B_star, color='Control')) + 
  geom_point(data=BiomassMaturityLUE2WD1, aes(x=N_QMD, y=B_star, color='+15%')) +
  geom_point(data=BiomassMaturityLUE3WD1, aes(x=N_QMD, y=B_star, color='+30%')) +
  scale_color_manual("Levels of LUE at WD 1", breaks = c("Control", "+15%", "+30%"), values = c("#F8766D" ,"#00BA38", "#619CFF"))+
  labs(x = "N at QMD=0.5", y = "B*") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")

```

# Annual_cohort_output
#### Distribution of tree sizes

From annual_cohort_output: dbh class 

##### LUE
```{r, fig.width = 6, fig.height = 9}
dataforplot <- rbind(ea1sa1magl_out_annual_cohorts,ea2sa1magl_out_annual_cohorts,ea3sa1magl_out_annual_cohorts)

ggplot(subset(dataforplot,dbhclass!="[0,0.12]")) + geom_bar(aes(fill=as.factor(LevelLUE), x=dbhclass, y=density), position="dodge", stat="identity")+
    labs(x = "DBH class (m)", y = expression(paste("Density (indiv", " " ,ha^-1, ") "))) +
    scale_fill_discrete(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),name = "Levels of LUE at WD 1", guide = "legend") + 
    theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")

ggplot(subset(dataforplot,ageclass!="[0,10]"&ageclass!="(10,20]")) + geom_bar(aes(fill=as.factor(LevelLUE), x=ageclass, y=density), position="dodge", stat="identity")+
    labs(x = "Age class (yrs)", y = expression(paste("Density (indiv", " " ,ha^-1, ") "))) +
    scale_fill_discrete(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),name = "Levels of LUE at WD 1", guide = "legend") + 
    theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")

data1 <- rbind(ea1sa1ma_out_annual_cohorts, ea2sa1ma_out_annual_cohorts, ea3sa1ma_out_annual_cohorts,
               ea1sa1mb_out_annual_cohorts, ea2sa1mb_out_annual_cohorts, ea3sa1mb_out_annual_cohorts,
               ea1sa1mc_out_annual_cohorts, ea2sa1mc_out_annual_cohorts, ea3sa1mc_out_annual_cohorts)

data1$Mortality <- factor(data1$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

ggplot(data1) + geom_bar(aes(fill=as.factor(LevelLUE), x=dbhclass, y=density), position="dodge", stat="identity")+
    labs(x = "DBH class (m)", y = expression(paste("Density (indiv", " " ,ha^-1, ") "))) +
    scale_fill_discrete(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),name = "Levels of LUE", guide = "legend") + 
    theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=3)

ggplot(data1) + geom_bar(aes(fill=as.factor(LevelLUE), x=ageclass, y=density), position="dodge", stat="identity")+
    labs(x = "Age class (yrs)", y = expression(paste("Density (indiv", " " ,ha^-1, ") "))) +
    scale_fill_discrete(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),name = "Levels of LUE", guide = "legend") + 
    theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
    facet_wrap(~ Mortality, ncol=3)

ggplot(subset(data1,dbhclass!="[0,0.12]")) + geom_bar(aes(fill=as.factor(LevelLUE), x=dbhclass, y=density), position="dodge", stat="identity")+
    labs(x = "DBH class (m)", y = expression(paste("Density (indiv", " " ,ha^-1, ") "))) +
    scale_fill_discrete(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),name = "Levels of LUE", guide = "legend") + 
    theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=1)

ggplot(subset(data1,ageclass!="[0,10]"&ageclass!="(10,20]"&ageclass!="(20,30]"&ageclass!="(30,40]")) + geom_bar(aes(fill=as.factor(LevelLUE), x=ageclass, y=density), position="dodge", stat="identity")+
    labs(x = "Age class (yrs)", y = expression(paste("Density (indiv", " " ,ha^-1, ") "))) +
    scale_fill_discrete(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),name = "Levels of LUE", guide = "legend") + 
    theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
    facet_wrap(~ Mortality, ncol=1)
```



#### Size bin (x, biomass, volume) vs. Growth (y, volume or mass increment per year); data = individual-level

From annual_cohort_output: dbh class NPP_yr

##### LUE
```{r, fig.width = 6, fig.height = 9}
library(dplyr)
library(forcats)
library(ggridges)

# Plot geom_density_ridges

dataBinLUE <- rbind(ea1sa1mc_out_annual_cohorts[,c(28,23,32,33,34,35)], ea2sa1mc_out_annual_cohorts[,c(28,23,32,33,34,35)], ea3sa1mc_out_annual_cohorts[,c(28,23,32,33,34,35)])

ggplot(dataBinLUE) +  geom_density_ridges(aes(NPP_yr,dbhclass,fill = paste(LevelLUE)),alpha = .6, color = "white")+
  labs(x = expression(paste("NPP (Kg C ", m^-2, " " ,yr^-1, ") ")), y = " DBH class (m)") +
  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") +
  scale_fill_cyclical(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),values = c("#F8766D", "#00BA38", "#619CFF"),
  name = "Levels of LUE", guide = "legend") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")

data1 <- rbind(ea1sa1ma_out_annual_cohorts, ea2sa1ma_out_annual_cohorts, ea3sa1ma_out_annual_cohorts,
               ea1sa1mb_out_annual_cohorts, ea2sa1mb_out_annual_cohorts, ea3sa1mb_out_annual_cohorts,
               ea1sa1mc_out_annual_cohorts, ea2sa1mc_out_annual_cohorts, ea3sa1mc_out_annual_cohorts)

data1$Mortality <- factor(data1$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

data1DBHClass <- data1 %>% group_by(dbhclass,Mortality,LevelLUE) %>% summarize(NPP_yr_aggr = mean(NPP_yr),NPP_yr_sd = sd(NPP_yr)) 

ggplot(data1) +  geom_density_ridges(aes(NPP_yr,dbhclass,fill = paste(LevelLUE)),alpha = .6, color = "white")+
  labs(x = expression(paste("NPP (Kg C ", m^-2, " " ,yr^-1, ") ")), y = " DBH class (m)") +
  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") +
  scale_fill_cyclical(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),values = c("#F8766D", "#00BA38", "#619CFF"),
  name = "Levels of LUE", guide = "legend") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=1)

ggplot() + 
  geom_point(data=data1DBHClass, aes(x=dbhclass, y=NPP_yr_aggr, color=as.factor(LevelLUE))) +
  geom_errorbar(data=data1DBHClass, aes(x=dbhclass, ymin=NPP_yr_aggr-NPP_yr_sd,ymax=NPP_yr_aggr+NPP_yr_sd,color=as.factor(LevelLUE)),width=0) +
  scale_color_manual(labels = c("Control","+15%", "+30%"),values = c("#F8766D", "#00BA38", "#619CFF"))+
  labs(col = "Level of LUE",y = expression(paste("NPP (Kg C ", m^-2, " " ,yr^-1, ") ")), x = "DBH class (m)") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=3)

# Plot relative enhancement: NPP(level 2) / NPP(level 1) [and NPP(level 3) / NPP(level 1)] per size bin

#ggplot(dataBinLUE_cohortsDBHClassJoin_2_1_ma) +  geom_density_ridges(aes(RelEnan2_1,dbhclass),alpha = .6, color = "white", fill="#00BA38")+
#  labs(x = expression(paste(NPP[LUE_2], " / " ,NPP[LUE_1])), y = " DBH class (m)") +
#  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") 

#ggplot(dataBinLUE_cohortsDBHClassJoin_3_1_ma) +  geom_density_ridges(aes(RelEnan3_1,dbhclass),alpha = .6, color = "white", fill="#619CFF")+
#  labs(x = expression(paste(NPP[LUE_3], " / " ,NPP[LUE_1])), y = " DBH class (m)") +
#  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") 

data2 <- rbind(dataBinLUE_cohortsDBHClassJoin_2_1_ma, dataBinLUE_cohortsDBHClassJoin_2_1_mb, dataBinLUE_cohortsDBHClassJoin_2_1_mc)
data2$Mortality <- factor(data2$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

#ggplot(data2) + geom_density_ridges(aes(RelEnan2_1,dbhclass),alpha = .6, color = "white", fill="#00BA38")+
#  labs(x = expression(paste(NPP[LUE_2], " / " ,NPP[LUE_1])), y = " DBH class (m)") +
#  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") + facet_wrap(~ Mortality, ncol=3)

ggplot(data2) + geom_point(aes(dbhclass,RelEnan2_1),color="#00BA38")+
 labs(y = expression(paste(NPP[LUE_2], " / " ,NPP[LUE_1])), x = " DBH class (m)") + 
 theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
 facet_wrap(~ Mortality, ncol=3) + geom_hline(yintercept=1, linetype="dashed", color = "grey")

data3 <- rbind(dataBinLUE_cohortsDBHClassJoin_3_1_ma, dataBinLUE_cohortsDBHClassJoin_3_1_mb, dataBinLUE_cohortsDBHClassJoin_3_1_mc)
data3$Mortality <- factor(data3$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

#ggplot(data3) + geom_density_ridges(aes(RelEnan3_1,dbhclass),alpha = .6, color = "white", fill="#619CFF")+
#  labs(x = expression(paste(NPP[LUE_3], " / " ,NPP[LUE_1])), y = " DBH class (m)") +
#  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") + facet_wrap(~ Mortality, ncol=3)

ggplot(data3) + geom_point(aes(dbhclass,RelEnan3_1),color="#619CFF")+
  labs(y = expression(paste(NPP[LUE_3], " / " ,NPP[LUE_1])), x = " DBH class (m)") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=3) + geom_hline(yintercept=1, linetype="dashed", color = "grey")

```

##### PAR
```{r, fig.width = 6, fig.height = 9}

# Plot geom_density_ridges

dataBinPAR <- rbind(eb1sa1mb_out_annual_cohorts[,c(28,23,32,33,34,35)], eb2sa1mb_out_annual_cohorts[,c(28,23,32,33,34,35)], eb3sa1mb_out_annual_cohorts[,c(28,23,32,33,34,35)])

ggplot(dataBinPAR) +  geom_density_ridges(aes(NPP_yr,dbhclass,fill = paste(LevelPAR)),alpha = .6, color = "white")+
  labs(x = expression(paste("NPP (Kg C ", m^-2, " " ,yr^-1, ") ")), y = " DBH class (m)") +
  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") +
  scale_fill_cyclical(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),values = c("#F8766D", "#00BA38", "#619CFF"),
  name = "Levels of PAR", guide = "legend") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")

data1 <- rbind(eb1sa1ma_out_annual_cohorts, eb2sa1ma_out_annual_cohorts, eb3sa1ma_out_annual_cohorts,
               eb1sa1mb_out_annual_cohorts, eb2sa1mb_out_annual_cohorts, eb3sa1mb_out_annual_cohorts,
               eb1sa1mc_out_annual_cohorts, eb2sa1mc_out_annual_cohorts, eb3sa1mc_out_annual_cohorts)

data1$Mortality <- factor(data1$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

data1DBHClass <- data1 %>% group_by(dbhclass,Mortality,LevelPAR) %>% summarize(NPP_yr_aggr = mean(NPP_yr),NPP_yr_sd = sd(NPP_yr)) 

ggplot(data1) +  geom_density_ridges(aes(NPP_yr,dbhclass,fill = paste(LevelPAR)),alpha = .6, color = "white")+
  labs(x = expression(paste("NPP (Kg C ", m^-2, " " ,yr^-1, ") ")), y = " DBH class (m)") +
  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") +
  scale_fill_cyclical(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),values = c("#F8766D", "#00BA38", "#619CFF"),
  name = "Levels of PAR", guide = "legend") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=1)

ggplot() + 
  geom_point(data=data1DBHClass, aes(x=dbhclass, y=NPP_yr_aggr, color=as.factor(LevelPAR))) +
  geom_errorbar(data=data1DBHClass, aes(x=dbhclass, ymin=NPP_yr_aggr-NPP_yr_sd,ymax=NPP_yr_aggr+NPP_yr_sd,color=as.factor(LevelPAR)),width=0) +
  scale_color_manual(labels = c("Control","+15%", "+30%"),values = c("#F8766D", "#00BA38", "#619CFF"))+
  labs(col = "Level of PAR",y = expression(paste("NPP (Kg C ", m^-2, " " ,yr^-1, ") ")), x = "DBH class (m)") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=1)

# Plot relative enhancement: NPP(level 2) / NPP(level 1) [and NPP(level 3) / NPP(level 1)] per size bin

ggplot(dataBinPAR_cohortsDBHClassJoin_2_1_ma) +  geom_density_ridges(aes(RelEnan2_1,dbhclass),alpha = .6, color = "white", fill="#00BA38")+
  labs(x = expression(paste(NPP[PAR_2], " / " ,NPP[PAR_1])), y = " DBH class (m)") +
  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") 

ggplot(dataBinPAR_cohortsDBHClassJoin_3_1_ma) +  geom_density_ridges(aes(RelEnan3_1,dbhclass),alpha = .6, color = "white", fill="#619CFF")+
  labs(x = expression(paste(NPP[PAR_3], " / " ,NPP[PAR_1])), y = " DBH class (m)") +
  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") 

data2 <- rbind(dataBinPAR_cohortsDBHClassJoin_2_1_ma, dataBinPAR_cohortsDBHClassJoin_2_1_mb, dataBinPAR_cohortsDBHClassJoin_2_1_mc)
data2$Mortality <- factor(data2$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

#ggplot(data2) + geom_density_ridges(aes(RelEnan2_1,dbhclass),alpha = .6, color = "white", fill="#00BA38")+
#  labs(x = expression(paste(NPP[PAR_2], " / " ,NPP[PAR_1])), y = " DBH class (m)") +
#  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") + facet_wrap(~ Mortality, ncol=3)

ggplot(data2) + geom_point(aes(dbhclass,RelEnan2_1),color="#00BA38")+
  labs(y = expression(paste(NPP[PAR_2], " / " ,NPP[PAR_1])), x = " DBH class (m)") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=1) + geom_hline(yintercept=1, linetype="dashed", color = "grey")

data3 <- rbind(dataBinPAR_cohortsDBHClassJoin_3_1_ma, dataBinPAR_cohortsDBHClassJoin_3_1_mb, dataBinPAR_cohortsDBHClassJoin_3_1_mc)
data3$Mortality <- factor(data3$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

#ggplot(data3) + geom_density_ridges(aes(RelEnan3_1,dbhclass),alpha = .6, color = "white", fill="#619CFF")+
#  labs(x = expression(paste(NPP[PAR_3], " / " ,NPP[PAR_1])), y = " DBH class (m)") +
#  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") + facet_wrap(~ Mortality, ncol=3)

ggplot(data3) + geom_point(aes(dbhclass,RelEnan3_1),color="#619CFF")+
  labs(y = expression(paste(NPP[PAR_3], " / " ,NPP[PAR_1])), x = " DBH class (m)") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=1) + geom_hline(yintercept=1, linetype="dashed", color = "grey")

```

#### Light bin (x, sum of basal area of trees with higher basal area than current one) vs. Growth (y, volume or mass increment per year); data = individual-level

From annual_cohort_output: dbh and NPP_yr

##### LUE
```{r, fig.width = 6, fig.height = 9}

# Plot geom_density_ridges

dataBinLUE <- rbind(ea1sa1ma_out_annual_cohorts[,c(28,23,32,33,34,35)], ea2sa1ma_out_annual_cohorts[,c(28,23,32,33,34,35)], ea3sa1ma_out_annual_cohorts[,c(28,23,32,33,34,35)])

ggplot(dataBinLUE) +  geom_density_ridges(aes(NPP_yr,highBAclass,fill = paste(LevelLUE)),alpha = .6, color = "white")+
  labs(x = expression(paste("NPP (Kg C ", m^-2, " " ,yr^-1, ") ")), y = expression(paste("Sum BA of higher trees (", m^2, " " ,ha^-1, ") "))) +
  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") +
  scale_fill_cyclical(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),values = c("#F8766D", "#00BA38", "#619CFF"),
  name = "Levels of LUE", guide = "legend") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")

data1 <- rbind(ea1sa1ma_out_annual_cohorts, ea2sa1ma_out_annual_cohorts, ea3sa1ma_out_annual_cohorts,
               ea1sa1mb_out_annual_cohorts, ea2sa1mb_out_annual_cohorts, ea3sa1mb_out_annual_cohorts,
               ea1sa1mc_out_annual_cohorts, ea2sa1mc_out_annual_cohorts, ea3sa1mc_out_annual_cohorts)

data1$Mortality <- factor(data1$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

ggplot(data1) +  geom_density_ridges(aes(NPP_yr,highBAclass,fill = paste(LevelLUE)),alpha = .6, color = "white")+
  labs(x = expression(paste("NPP (Kg C ", m^-2, " " ,yr^-1, ") ")), y = expression(paste("Sum BA of higher trees (", m^2, " " ,ha^-1, ") "))) +
  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") +
  scale_fill_cyclical(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),values = c("#F8766D", "#00BA38", "#619CFF"),
  name = "Levels of LUE", guide = "legend") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=1)

data1highBAClass <- data1 %>% group_by(highBAclass,Mortality,LevelLUE) %>% summarize(NPP_yr_aggr = mean(NPP_yr),NPP_yr_sd = sd(NPP_yr)) 
data1highBAClass$Mortality <- factor(data1highBAClass$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

ggplot() + 
  geom_point(data=data1highBAClass, aes(x=highBAclass, y=NPP_yr_aggr, color=as.factor(LevelLUE))) +
  geom_errorbar(data=data1highBAClass, aes(x=highBAclass, ymin=NPP_yr_aggr-NPP_yr_sd,ymax=NPP_yr_aggr+NPP_yr_sd,color=as.factor(LevelLUE)),width=0) +
  scale_color_manual(labels = c("Control","+15%", "+30%"),values = c("#F8766D", "#00BA38", "#619CFF"))+
  labs(col = "Level of LUE",y = expression(paste("NPP (Kg C ", m^-2, " " ,yr^-1, ") ")), x = expression(paste("Sum BA of higher trees (", m^2, " " ,ha^-1, ") "))) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=1)

# Plot relative enhancement: NPP(level 2) / NPP(level 1) [and NPP(level 3) / NPP(level 1)] per size bin

data2 <- rbind(dataBinLUE_cohortsHighBAClassJoin_2_1_ma, dataBinLUE_cohortsHighBAClassJoin_2_1_mb, dataBinLUE_cohortsHighBAClassJoin_2_1_mc)
data2$Mortality <- factor(data2$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

#ggplot(data2) + geom_density_ridges(aes(RelEnan2_1,highBAclass),alpha = .6, color = "white", fill="#00BA38")+
#  labs(x = expression(paste(NPP[LUE_2], " / " ,NPP[LUE_1])), y = expression(paste("Sum BA of higher trees (", m^2, " " ,ha^-1, ") "))) +
#  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") + facet_wrap(~ Mortality, ncol=1)

ggplot(data2) + geom_point(aes(highBAclass,RelEnan2_1),color="#00BA38")+
  labs(y = expression(paste(NPP[LUE_2], " / " ,NPP[LUE_1])), x = expression(paste("Sum BA of higher trees (", m^2, " " ,ha^-1, ") "))) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=1) + geom_hline(yintercept=1, linetype="dashed", color = "grey")

data3 <- rbind(dataBinLUE_cohortsHighBAClassJoin_3_1_ma, dataBinLUE_cohortsHighBAClassJoin_3_1_mb, dataBinLUE_cohortsHighBAClassJoin_3_1_mc)
data3$Mortality <- factor(data3$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

#ggplot(data3) + geom_density_ridges(aes(RelEnan3_1,highBAclass),alpha = .6, color = "white", fill="#619CFF")+
#  labs(x = expression(paste(NPP[LUE_3], " / " ,NPP[LUE_1])), y = expression(paste("Sum BA of higher trees (", m^2, " " ,ha^-1, ") "))) +
#  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") + facet_wrap(~ Mortality, ncol=1)

ggplot(data3) + geom_point(aes(highBAclass,RelEnan3_1),color="#619CFF")+
  labs(y = expression(paste(NPP[LUE_3], " / " ,NPP[LUE_1])), x = expression(paste("Sum BA of higher trees (", m^2, " " ,ha^-1, ") "))) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=1) + geom_hline(yintercept=1, linetype="dashed", color = "grey")

```

##### PAR
```{r, fig.width = 6, fig.height = 9}

# Plot geom_density_ridges

dataBinPAR <- rbind(eb1sa1ma_out_annual_cohorts[,c(28,23,32,33,34,35)], eb2sa1ma_out_annual_cohorts[,c(28,23,32,33,34,35)], eb3sa1ma_out_annual_cohorts[,c(28,23,32,33,34,35)])

ggplot(dataBinPAR) +  geom_density_ridges(aes(NPP_yr,highBAclass,fill = paste(LevelPAR)),alpha = .6, color = "white")+
  labs(x = expression(paste("NPP (Kg C ", m^-2, " " ,yr^-1, ") ")), y = expression(paste("Sum BA of higher trees (", m^2, " " ,ha^-1, ") "))) +
  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") +
  scale_fill_cyclical(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),values = c("#F8766D", "#00BA38", "#619CFF"),
  name = "Levels of PAR", guide = "legend") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")

data1 <- rbind(eb1sa1ma_out_annual_cohorts, eb2sa1ma_out_annual_cohorts, eb3sa1ma_out_annual_cohorts,
               eb1sa1mb_out_annual_cohorts, eb2sa1mb_out_annual_cohorts, eb3sa1mb_out_annual_cohorts,
               eb1sa1mc_out_annual_cohorts, eb2sa1mc_out_annual_cohorts, eb3sa1mc_out_annual_cohorts)

data1$Mortality <- factor(data1$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

ggplot(data1) +  geom_density_ridges(aes(NPP_yr,highBAclass,fill = paste(LevelPAR)),alpha = .6, color = "white")+
  labs(x = expression(paste("NPP (Kg C ", m^-2, " " ,yr^-1, ") ")), y = expression(paste("Sum BA of higher trees (", m^2, " " ,ha^-1, ") "))) +
  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") +
  scale_fill_cyclical(labels = c(`1` = "Control", `2` = "+15%", `3` = "+30%"),values = c("#F8766D", "#00BA38", "#619CFF"),
  name = "Levels of PAR", guide = "legend") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=3)

data1highBAClass <- data1 %>% group_by(highBAclass,Mortality,LevelPAR) %>% summarize(NPP_yr_aggr = mean(NPP_yr),NPP_yr_sd = sd(NPP_yr)) 
data1highBAClass$Mortality <- factor(data1highBAClass$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

ggplot() + 
  geom_point(data=data1highBAClass, aes(x=highBAclass, y=NPP_yr_aggr, color=as.factor(LevelPAR))) +
  geom_errorbar(data=data1highBAClass, aes(x=highBAclass, ymin=NPP_yr_aggr-NPP_yr_sd,ymax=NPP_yr_aggr+NPP_yr_sd,color=as.factor(LevelPAR)),width=0) +
  scale_color_manual(labels = c("Control","+15%", "+30%"),values = c("#F8766D", "#00BA38", "#619CFF"))+
  labs(col = "Level of PAR",y = expression(paste("NPP (Kg C ", m^-2, " " ,yr^-1, ") ")), x = expression(paste("Sum BA of higher trees (", m^2, " " ,ha^-1, ") "))) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=1)

# Plot relative enhancement: NPP(level 2) / NPP(level 1) [and NPP(level 3) / NPP(level 1)] per size bin

data2 <- rbind(dataBinPAR_cohortsHighBAClassJoin_2_1_ma, dataBinPAR_cohortsHighBAClassJoin_2_1_mb, dataBinPAR_cohortsHighBAClassJoin_2_1_mc)
data2$Mortality <- factor(data2$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

#ggplot(data2) + geom_density_ridges(aes(RelEnan2_1,highBAclass),alpha = .6, color = "white", fill="#00BA38")+
#  labs(x = expression(paste(NPP[PAR_2], " / " ,NPP[PAR_1])), y = expression(paste("Sum BA of higher trees (", m^2, " " ,ha^-1, ") "))) +
#  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") + facet_wrap(~ Mortality, ncol=3)

ggplot(data2) + geom_point(aes(highBAclass,RelEnan2_1),color="#00BA38")+
  labs(y = expression(paste(NPP[PAR_2], " / " ,NPP[PAR_1])), x = expression(paste("Sum BA of higher trees (", m^2, " " ,ha^-1, ") "))) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=1) + geom_hline(yintercept=1, linetype="dashed", color = "grey")

data3 <- rbind(dataBinPAR_cohortsHighBAClassJoin_3_1_ma, dataBinPAR_cohortsHighBAClassJoin_3_1_mb, dataBinPAR_cohortsHighBAClassJoin_3_1_mc)
data3$Mortality <- factor(data3$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

#ggplot(data3) + geom_density_ridges(aes(RelEnan3_1,highBAclass),alpha = .6, color = "white", fill="#619CFF")+
#  labs(x = expression(paste(NPP[PAR_1], " / " ,NPP[PAR_1])), y = expression(paste("Sum BA of higher trees (", m^2, " " ,ha^-1, ") "))) +
#  scale_y_discrete(expand = c(0, 0)) +  scale_x_continuous(expand = c(0, 0)) + coord_cartesian(clip = "off") + facet_wrap(~ Mortality, ncol=3)

ggplot(data3) + geom_point(aes(highBAclass,RelEnan3_1),color="#619CFF")+
  labs(y = expression(paste(NPP[PAR_3], " / " ,NPP[PAR_1])), x = expression(paste("Sum BA of higher trees (", m^2, " " ,ha^-1, ") "))) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=1) + geom_hline(yintercept=1, linetype="dashed", color = "grey")

```



##### Radiation with Age max
##### Same species at different sites (differing by LUE, growing season length, PAR)

```{r, fig.width = 8, fig.height = 4}

eb1sa1ma_out_annual_tileMaxAgg <- eb1sa1ma_out_annual_tile[500:1500,] %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), sdmaxAge=sd(MaxAge,na.rm=T),
                                  MaxVolume_MaxAge_mean=mean(MaxVolume_MaxAge,na.rm=T), sdMaxVolume_MaxAge=sd(MaxVolume_MaxAge,na.rm=T),
                                  MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), sdMaxDBH_MaxAge=sd(MaxDBH_MaxAge,na.rm=T))
eb2sa1ma_out_annual_tileMaxAgg <- eb2sa1ma_out_annual_tile[500:1500,] %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), sdmaxAge=sd(MaxAge,na.rm=T),
                                  MaxVolume_MaxAge_mean=mean(MaxVolume_MaxAge,na.rm=T), sdMaxVolume_MaxAge=sd(MaxVolume_MaxAge,na.rm=T),
                                  MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), sdMaxDBH_MaxAge=sd(MaxDBH_MaxAge,na.rm=T))
eb3sa1ma_out_annual_tileMaxAgg <- eb3sa1ma_out_annual_tile[500:1500,] %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), sdmaxAge=sd(MaxAge,na.rm=T),
                                  MaxVolume_MaxAge_mean=mean(MaxVolume_MaxAge,na.rm=T), sdMaxVolume_MaxAge=sd(MaxVolume_MaxAge,na.rm=T),
                                  MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), sdMaxDBH_MaxAge=sd(MaxDBH_MaxAge,na.rm=T))
# Volume/Age
ggplot() + 
  geom_point(data=eb1sa1ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, y=maxAge_mean, color='Control')) + geom_errorbar(data=eb1sa1ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax= maxAge_mean+sdmaxAge,color='Control'),width=0)+ 
  geom_errorbar(data=eb1sa1ma_out_annual_tileMaxAgg, aes(xmin=MaxVolume_MaxAge_mean-sdMaxVolume_MaxAge,xmax= MaxVolume_MaxAge_mean+sdMaxVolume_MaxAge , y=maxAge_mean,color='Control'),width=0)+
  geom_point(data=eb2sa1ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, y=maxAge_mean, color='+15%')) + 
  geom_errorbar(data=eb2sa1ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax= maxAge_mean+sdmaxAge,color='+15%'),width=0)+ geom_errorbar(data=eb2sa1ma_out_annual_tileMaxAgg, aes(xmin=MaxVolume_MaxAge_mean-sdMaxVolume_MaxAge,xmax= MaxVolume_MaxAge_mean+sdMaxVolume_MaxAge , y=maxAge_mean,color='+15%'),width=0)+
geom_point(data=eb3sa1ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, y=maxAge_mean, color='+30%')) + 
  geom_errorbar(data=eb3sa1ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax=maxAge_mean+sdmaxAge,color='+30%'),width=0) +
  geom_errorbar(data=eb3sa1ma_out_annual_tileMaxAgg, aes(xmin=MaxVolume_MaxAge_mean-sdMaxVolume_MaxAge,xmax= MaxVolume_MaxAge_mean+sdMaxVolume_MaxAge , y=maxAge_mean,color='+30%'),width=0)+
  scale_color_manual("Levels of PAR at WD 1", breaks = c("Control", "+15%", "+30%"), values = c("#F8766D" ,"#00BA38", "#619CFF"))+
  labs(x = expression(paste("Growth rate (Volume ",age^-1,  ") ")), y = "Longevity") +  
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  scale_x_continuous(limits = c(0,1.75),breaks = seq(0,1.75,0.25)) + scale_y_continuous(limits = c(275, 450),breaks = seq(275, 450, 25))

# Facet wrap
data1 <- rbind(eb1sa1ma_out_annual_tile, eb2sa1ma_out_annual_tile, eb3sa1ma_out_annual_tile,
               eb1sa1mb_out_annual_tile, eb2sa1mb_out_annual_tile, eb3sa1mb_out_annual_tile,
               eb1sa1mc_out_annual_tile, eb2sa1mc_out_annual_tile, eb3sa1mc_out_annual_tile)

data1$Mortality <- factor(data1$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

data1MAxAgg <- data1 %>% filter(year>=1300) %>% group_by(Mortality,LevelPAR) %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), sdmaxAge=sd(MaxAge,na.rm=T),
                                  MaxVolume_MaxAge_mean=mean(MaxVolume_MaxAge,na.rm=T), sdMaxVolume_MaxAge=sd(MaxVolume_MaxAge,na.rm=T),
                                  MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), sdMaxDBH_MaxAge=sd(MaxDBH_MaxAge,na.rm=T))
 
ggplot() + 
  geom_point(data=data1MAxAgg, aes(x=MaxVolume_MaxAge_mean, y=maxAge_mean, color=as.factor(LevelPAR))) +
  geom_errorbar(data=data1MAxAgg, aes(x=MaxVolume_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax=maxAge_mean+sdmaxAge,color=as.factor(LevelPAR)),width=0) +
  geom_errorbar(data=data1MAxAgg, aes(xmin=MaxVolume_MaxAge_mean-sdMaxVolume_MaxAge,xmax= MaxVolume_MaxAge_mean+sdMaxVolume_MaxAge , y=maxAge_mean,color=as.factor(LevelPAR)),width=0) +
  scale_color_manual(labels = c("Control","+15%", "+30%"),values = c("#F8766D", "#00BA38", "#619CFF"))+
  labs(col="Levels of PAR",x = expression(paste("Growth rate (Volume ",age^-1,  ") ")), y = "Longevity") +  
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=3)

ggplot() + 
  geom_point(data=data1MAxAgg, aes(x=MaxDBH_MaxAge_mean, y=maxAge_mean, color=as.factor(LevelPAR))) +
  geom_errorbar(data=data1MAxAgg, aes(x=MaxDBH_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax=maxAge_mean+sdmaxAge,color=as.factor(LevelPAR)),width=0) +
  geom_errorbar(data=data1MAxAgg, aes(xmin=MaxDBH_MaxAge_mean-sdMaxDBH_MaxAge,xmax= MaxDBH_MaxAge_mean+sdMaxDBH_MaxAge , y=maxAge_mean,color=as.factor(LevelPAR)),width=0) +
  scale_color_manual(labels = c("Control","+15%", "+30%"),values = c("#F8766D", "#00BA38", "#619CFF"))+
  labs(col="Levels of PAR",x = expression(paste("Growth rate (DBH ",age^-1,  ") ")), y = "Longevity") +  
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=3)
```

##### Wood density with Age max 
##### Different species at a given site: Each point is one species (differing by wood density, root:shoot ratio). Add info either by using color ~site (given LUE, growing season length, PAR).

```{r, fig.width = 8, fig.height = 4}

ea1sa1ma_out_annual_tileMaxAgg <- ea1sa1ma_out_annual_tile[500:1500,] %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), sdmaxAge=sd(MaxAge,na.rm=T),
                                  MaxVolume_MaxAge_mean=mean(MaxVolume_MaxAge,na.rm=T), sdMaxVolume_MaxAge=sd(MaxVolume_MaxAge,na.rm=T),
                                  MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), sdMaxDBH_MaxAge=sd(MaxDBH_MaxAge,na.rm=T))
ea1sa2ma_out_annual_tileMaxAgg <- ea1sa2ma_out_annual_tile[500:1500,] %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), sdmaxAge=sd(MaxAge,na.rm=T),
                                  MaxVolume_MaxAge_mean=mean(MaxVolume_MaxAge,na.rm=T), sdMaxVolume_MaxAge=sd(MaxVolume_MaxAge,na.rm=T),
                                  MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), sdMaxDBH_MaxAge=sd(MaxDBH_MaxAge,na.rm=T))
ea1sa3ma_out_annual_tileMaxAgg <- ea1sa3ma_out_annual_tile[500:1500,] %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), sdmaxAge=sd(MaxAge,na.rm=T),
                                  MaxVolume_MaxAge_mean=mean(MaxVolume_MaxAge,na.rm=T), sdMaxVolume_MaxAge=sd(MaxVolume_MaxAge,na.rm=T),
                                  MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), sdMaxDBH_MaxAge=sd(MaxDBH_MaxAge,na.rm=T))
# Volume/Age
ggplot() + 
  geom_point(data=ea1sa1ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, y=maxAge_mean, color='300 kgC m-3')) + geom_errorbar(data=ea1sa1ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax= maxAge_mean+sdmaxAge,color='300 kgC m-3'),width=0)+ 
  geom_errorbar(data=ea1sa1ma_out_annual_tileMaxAgg, aes(xmin=MaxVolume_MaxAge_mean-sdMaxVolume_MaxAge,xmax= MaxVolume_MaxAge_mean+sdMaxVolume_MaxAge , y=maxAge_mean,color='300 kgC m-3'),width=0)+
  geom_point(data=ea1sa2ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, y=maxAge_mean, color='600 kgC m-3')) + 
  geom_errorbar(data=ea1sa2ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax= maxAge_mean+sdmaxAge,color='600 kgC m-3'),width=0)+ geom_errorbar(data=ea1sa2ma_out_annual_tileMaxAgg, aes(xmin=MaxVolume_MaxAge_mean-sdMaxVolume_MaxAge,xmax= MaxVolume_MaxAge_mean+sdMaxVolume_MaxAge , y=maxAge_mean,color='600 kgC m-3'),width=0)+
geom_point(data=ea1sa3ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, y=maxAge_mean, color='800 kgC m-3')) + 
  geom_errorbar(data=ea1sa3ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax=maxAge_mean+sdmaxAge,color='800 kgC m-3'),width=0) +
  geom_errorbar(data=ea1sa3ma_out_annual_tileMaxAgg, aes(xmin=MaxVolume_MaxAge_mean-sdMaxVolume_MaxAge,xmax= MaxVolume_MaxAge_mean+sdMaxVolume_MaxAge , y=maxAge_mean,color='800 kgC m-3'),width=0)+
  scale_color_manual("Levels of WD at LUE 1", breaks = c("300 kgC m-3", "600 kgC m-3", "800 kgC m-3"), values = c("#00AFBB" ,"#E7B800", "#FC4E07"))+
  labs(x = expression(paste("Growth rate (Volume ",age^-1,  ") ")), y = "Longevity") +  
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  scale_x_continuous(limits = c(0,1.75),breaks = seq(0,1.75,0.25)) + scale_y_continuous(limits = c(275, 450),breaks = seq(275, 450, 25))

# Facet wrap
data1 <- rbind(ea1sa1ma_out_annual_tile, ea1sa2ma_out_annual_tile, ea1sa3ma_out_annual_tile,
               ea1sa1mb_out_annual_tile, ea1sa2mb_out_annual_tile, ea1sa3mb_out_annual_tile,
               ea1sa1mc_out_annual_tile, ea1sa2mc_out_annual_tile, ea1sa3mc_out_annual_tile)

data1$Mortality <- factor(data1$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

data1MAxAgg <- data1 %>% filter(year>=1300) %>% group_by(Mortality,LevelWD) %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), sdmaxAge=sd(MaxAge,na.rm=T),
                                  MaxVolume_MaxAge_mean=mean(MaxVolume_MaxAge,na.rm=T), sdMaxVolume_MaxAge=sd(MaxVolume_MaxAge,na.rm=T),
                                  MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), sdMaxDBH_MaxAge=sd(MaxDBH_MaxAge,na.rm=T))
 
ggplot() + 
  geom_point(data=data1MAxAgg, aes(x=MaxVolume_MaxAge_mean, y=maxAge_mean, color=as.factor(LevelWD))) +
  geom_errorbar(data=data1MAxAgg, aes(x=MaxVolume_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax=maxAge_mean+sdmaxAge,color=as.factor(LevelWD)),width=0) +
  geom_errorbar(data=data1MAxAgg, aes(xmin=MaxVolume_MaxAge_mean-sdMaxVolume_MaxAge,xmax= MaxVolume_MaxAge_mean+sdMaxVolume_MaxAge , y=maxAge_mean,color=as.factor(LevelWD)),width=0) +
  scale_color_manual(labels = c("300 kgC m-3","600 kgC m-3", "800 kgC m-3"),values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(col="Levels of WD",x = expression(paste("Growth rate (Volume ",age^-1,  ") ")), y = "Longevity") +  
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=3)

ggplot() + 
  geom_point(data=data1MAxAgg, aes(x=MaxDBH_MaxAge_mean, y=maxAge_mean, color=as.factor(LevelWD))) +
  geom_errorbar(data=data1MAxAgg, aes(x=MaxDBH_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax=maxAge_mean+sdmaxAge,color=as.factor(LevelWD)),width=0) +
  geom_errorbar(data=data1MAxAgg, aes(xmin=MaxDBH_MaxAge_mean-sdMaxDBH_MaxAge,xmax= MaxDBH_MaxAge_mean+sdMaxDBH_MaxAge , y=maxAge_mean,color=as.factor(LevelWD)),width=0) +
  scale_color_manual(labels = c("300 kgC m-3","600 kgC m-3", "800 kgC m-3"),values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(col="Levels of WD",x = expression(paste("Growth rate (DBH ",age^-1,  ") ")), y = "Longevity") +  
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=3)

```

##### Rhoot:Shoot ratio with Age max 
##### Different species at a given site: Each point is one species (differing by wood density, root:shoot ratio). Add info either by using color ~site (given LUE, growing season length, PAR).

```{r, fig.width = 8, fig.height = 4}

ea1sb1ma_out_annual_tileMaxAgg <- ea1sb1ma_out_annual_tile[500:1500,] %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), sdmaxAge=sd(MaxAge,na.rm=T),
                                  MaxVolume_MaxAge_mean=mean(MaxVolume_MaxAge,na.rm=T), sdMaxVolume_MaxAge=sd(MaxVolume_MaxAge,na.rm=T),
                                  MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), sdMaxDBH_MaxAge=sd(MaxDBH_MaxAge,na.rm=T))
ea1sb2ma_out_annual_tileMaxAgg <- ea1sb2ma_out_annual_tile[500:1500,] %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), sdmaxAge=sd(MaxAge,na.rm=T),
                                  MaxVolume_MaxAge_mean=mean(MaxVolume_MaxAge,na.rm=T), sdMaxVolume_MaxAge=sd(MaxVolume_MaxAge,na.rm=T),
                                  MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), sdMaxDBH_MaxAge=sd(MaxDBH_MaxAge,na.rm=T))
ea1sb3ma_out_annual_tileMaxAgg <- ea1sb3ma_out_annual_tile[500:1500,] %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), sdmaxAge=sd(MaxAge,na.rm=T),
                                  MaxVolume_MaxAge_mean=mean(MaxVolume_MaxAge,na.rm=T), sdMaxVolume_MaxAge=sd(MaxVolume_MaxAge,na.rm=T),
                                  MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), sdMaxDBH_MaxAge=sd(MaxDBH_MaxAge,na.rm=T))
# Volume/Age
ggplot() + 
  geom_point(data=ea1sb1ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, y=maxAge_mean, color='phiRL = 4')) + geom_errorbar(data=ea1sb1ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax= maxAge_mean+sdmaxAge,color='phiRL = 4'),width=0)+ 
  geom_errorbar(data=ea1sb1ma_out_annual_tileMaxAgg, aes(xmin=MaxVolume_MaxAge_mean-sdMaxVolume_MaxAge,xmax= MaxVolume_MaxAge_mean+sdMaxVolume_MaxAge , y=maxAge_mean,color='phiRL = 4'),width=0)+
  geom_point(data=ea1sb2ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, y=maxAge_mean, color='phiRL = 6')) + 
  geom_errorbar(data=ea1sb2ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax= maxAge_mean+sdmaxAge,color='phiRL = 6'),width=0)+ geom_errorbar(data=ea1sb2ma_out_annual_tileMaxAgg, aes(xmin=MaxVolume_MaxAge_mean-sdMaxVolume_MaxAge,xmax= MaxVolume_MaxAge_mean+sdMaxVolume_MaxAge , y=maxAge_mean,color='phiRL = 6'),width=0)+
geom_point(data=ea1sb3ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, y=maxAge_mean, color='phiRL = 8')) + 
  geom_errorbar(data=ea1sb3ma_out_annual_tileMaxAgg, aes(x=MaxVolume_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax=maxAge_mean+sdmaxAge,color='phiRL = 8'),width=0) +
  geom_errorbar(data=ea1sb3ma_out_annual_tileMaxAgg, aes(xmin=MaxVolume_MaxAge_mean-sdMaxVolume_MaxAge,xmax= MaxVolume_MaxAge_mean+sdMaxVolume_MaxAge , y=maxAge_mean,color='phiRL = 8'),width=0)+
  scale_color_manual("Levels of R:S at LUE 1", breaks = c("phiRL = 4", "phiRL = 6", "phiRL = 8"), values = c("#00AFBB" ,"#E7B800", "#FC4E07"))+
  labs(x = expression(paste("Growth rate (Volume ",age^-1,  ") ")), y = "Longevity") +  
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  scale_x_continuous(limits = c(0,1.75),breaks = seq(0,1.75,0.25)) + scale_y_continuous(limits = c(275, 450),breaks = seq(275, 450, 25))

# Facet wrap
data1 <- rbind(ea1sb1ma_out_annual_tile, ea1sb2ma_out_annual_tile, ea1sb3ma_out_annual_tile,
               ea1sb1mb_out_annual_tile, ea1sb2mb_out_annual_tile, ea1sb3mb_out_annual_tile,
               ea1sb1mc_out_annual_tile, ea1sb2mc_out_annual_tile, ea1sb3mc_out_annual_tile)

data1$Mortality <- factor(data1$Mortality, levels = c("DBH", "NSC/Leaf mass", "Growth rate"))

data1MAxAgg <- data1 %>% filter(year>=1300) %>% group_by(Mortality,LevelRS) %>% summarise(maxAge_mean=mean(MaxAge,na.rm=T), sdmaxAge=sd(MaxAge,na.rm=T),
                                  MaxVolume_MaxAge_mean=mean(MaxVolume_MaxAge,na.rm=T), sdMaxVolume_MaxAge=sd(MaxVolume_MaxAge,na.rm=T),
                                  MaxDBH_MaxAge_mean=mean(MaxDBH_MaxAge,na.rm=T), sdMaxDBH_MaxAge=sd(MaxDBH_MaxAge,na.rm=T))
 
ggplot() + 
  geom_point(data=data1MAxAgg, aes(x=MaxVolume_MaxAge_mean, y=maxAge_mean, color=as.factor(LevelRS))) +
  geom_errorbar(data=data1MAxAgg, aes(x=MaxVolume_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax=maxAge_mean+sdmaxAge,color=as.factor(LevelRS)),width=0) +
  geom_errorbar(data=data1MAxAgg, aes(xmin=MaxVolume_MaxAge_mean-sdMaxVolume_MaxAge,xmax= MaxVolume_MaxAge_mean+sdMaxVolume_MaxAge , y=maxAge_mean,color=as.factor(LevelRS)),width=0) +
  scale_color_manual(labels = c("phiRL = 4", "phiRL = 6", "phiRL = 8"),values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(col="Levels of RS",x = expression(paste("Growth rate (Volume ",age^-1,  ") ")), y = "Longevity") +  
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=3)

ggplot() + 
  geom_point(data=data1MAxAgg, aes(x=MaxDBH_MaxAge_mean, y=maxAge_mean, color=as.factor(LevelRS))) +
  geom_errorbar(data=data1MAxAgg, aes(x=MaxDBH_MaxAge_mean, ymin=maxAge_mean-sdmaxAge,ymax=maxAge_mean+sdmaxAge,color=as.factor(LevelRS)),width=0) +
  geom_errorbar(data=data1MAxAgg, aes(xmin=MaxDBH_MaxAge_mean-sdMaxDBH_MaxAge,xmax= MaxDBH_MaxAge_mean+sdMaxDBH_MaxAge , y=maxAge_mean,color=as.factor(LevelRS)),width=0) +
  scale_color_manual(labels = c("phiRL = 4", "phiRL = 6", "phiRL = 8"),values = c("#00AFBB", "#E7B800", "#FC4E07"))+
  labs(col="Levels of RS",x = expression(paste("Growth rate (DBH ",age^-1,  ") ")), y = "Longevity") +  
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  facet_wrap(~ Mortality, ncol=3)

```

## Self-thinning relationship

From annual_tile_output: QMD and Density12
LUE (mol/s/m2)

```{r, include=T, eval=T,fig.height=6,fig.width=8}

# Mortality as a function of DBH
# Biomass changes in LUE with WD level 1

## Figure opt 1
ggplot() + 
  geom_point(data=subset(ea1sb1DBHgl_out_annual_tile,year>=500), aes(x=log(QMD), y=log(Density12), color='Control')) + 
  geom_point(data=subset(ea1sb2DBHgl_out_annual_tile,year>=500), aes(x=log(QMD), y=log(Density12), color='+15%')) +
  geom_point(data=subset(ea1sb3DBHgl_out_annual_tile,year>=500), aes(x=log(QMD), y=log(Density12), color='+30%')) +
  scale_color_manual("Levels of LUE", breaks = c("Control", "+15%", "+30%"), values = c("#F8766D" ,"#619CFF","#00BA38"))+
  labs(col = "Level of LUE", x = "Ln(QMD)", y = "Ln(N)") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom") +
  ggtitle("Function of DBH") + 
  scale_x_continuous(limits = c(3.5,4.25)) + 
  scale_y_continuous(limits = c(4.8,6))

## Figure opt 2 With geom_smooth
data1 <- rbind(ea1sa1DBHgl_out_annual_tile, ea2sa1DBHgl_out_annual_tile, ea3sa1DBHgl_out_annual_tile)
figure1 <- ggplot() + 
  geom_point(data=subset(data1, year>=500), aes(x=log(QMD), y=log(Density12), color=as.factor(LevelLUE))) +
  geom_smooth(data=subset(data1, year>=500), aes(x=log(QMD), y=log(Density12), color=as.factor(LevelLUE)),method = "lm",fullrange = T) +
  scale_color_manual(labels = c("Control","+15%", "+30%"),values = c("#F8766D" ,"#619CFF","#00BA38"))+
  labs(col = "Levels of Light Use Efficiency", x = "Quadratic Mean Diameter (QMD)", y = "Stand density (N)") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom",
                     legend.text = element_text(size=10),legend.title = element_text(size=10)) + 
  #ggtitle("Mortality as a function of DBH") + 
  scale_x_continuous(limits = c(3.5,4),breaks = seq(3.5,4,0.1)) + 
  scale_y_continuous(limits = c(4.9,6.2),breaks = seq(5,6,0.2))
ggsave("figure1.1.tiff", width = 5, height = 4, device='tiff', dpi=300)

## Figure opt 3 With geom_abline
ggplot() + 
  geom_point(data=ea1sa1DBHgl_out_annual_tile[100:1804,], aes(x=log(QMD), y=log(Density12), color='Control')) + 
  geom_point(data=ea2sa1DBHgl_out_annual_tile[100:1804,], aes(x=log(QMD), y=log(Density12), color='+15%')) +
  geom_point(data=ea3sa1DBHgl_out_annual_tile[100:1804,], aes(x=log(QMD), y=log(Density12), color='+30%')) +
  scale_color_manual("Levels of LUE at WD 1", breaks = c("Control", "+15%", "+30%"), values = c("#F8766D"  ,"#619CFF","#00BA38"))+
  scale_x_continuous(limits = c(3.5,4.25)) + 
  scale_y_continuous(limits = c(4.8,6),breaks = seq(5,6,0.25)) +
  labs(x = "Ln(QMD)", y = "Ln(N)") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),legend.position = "bottom")+
  geom_abline(intercept = coef(lm(log(Density12) ~ log(QMD), data = ea1sa1DBHgl_out_annual_tile[100:1804,]))[1], 
              slope = coef(lm(log(Density12) ~ log(QMD), data = ea1sa1DBHgl_out_annual_tile[100:1804,]))[2], color="#F8766D") +
  geom_abline(intercept = coef(lm(log(Density12) ~ log(QMD), data = ea2sa1DBHgl_out_annual_tile[100:1804,]))[1], 
              slope = coef(lm(log(Density12) ~ log(QMD), data = ea2sa1DBHgl_out_annual_tile[100:1804,]))[2], color="#619CFF") +
  geom_abline(intercept = coef(lm(log(Density12) ~ log(QMD), data = ea3sa1DBHgl_out_annual_tile[100:1804,]))[1], 
              slope = coef(lm(log(Density12) ~ log(QMD), data = ea3sa1DBHgl_out_annual_tile[100:1804,]))[2], color="#00BA38")

```
