---
title: "Calibration gs-Leuning"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(tibble)
library(rsofun)
library(ggplot2)
#if(!require(devtools)){install.packages(devtools)}
#devtools::install_github("stineb/rbeni")
#library(ingestr)
#devtools::install_github("tidyverse/multidplyr")
library(multidplyr)
```

## Example

### Simulation settings

Manually select some sites from which we're going to use the data for evaluation and calibration.
```{r,include=FALSE, eval=TRUE}
sitename <- "CH-Lae"
```

Create a site meta info table that contains all the site-specific information that is used to force site-simulations (e.g. starting year, number of simulations years, elevation, etc.). For FLUXNET2015 data, required meta info is provided by the `rsofun` package (data frame `rsofun::metainfo_Tier1_sites_kgclimate_fluxnet2015`).
```{r,include=FALSE, eval=TRUE}
# Take only year 2004 to 2014, corresponding to subset of data for site CH-Lae
siteinfo <- data.frame(sitename="CH-Lae", lon = 8.365, lat = 47.47808, elv = 700, year_start = 2004, year_end = 2014, classid = NA, c4 = FALSE, whc = NA, koeppen_code = NA, igbp_land_use = "Mixed Forests", plant_functional_type = "Broadleaf trees")

siteinfo <- as_tibble(siteinfo)
siteinfo <- siteinfo %>% 
  dplyr::mutate(date_start = lubridate::ymd(paste0(year_start, "-01-01"))) %>%
  dplyr::mutate(date_end = lubridate::ymd(paste0(year_end, "-12-31")))
```

Now specify the simulation parameters that are identical for all site-scale simulations.
```{r,include=FALSE, eval=TRUE}
params_siml <- tibble( #list
      spinup                = TRUE,
      spinupyears           = 700, 
      recycle               = 800,    # 9 or 11 changed to 1 when aggregating forcing into 1 year
      firstyeartrend        = 2009, 
      nyeartrend            = 800,    # 9 or 11 (longer transient years)
      outputhourly          = TRUE,
      outputdaily           = TRUE,
      do_U_shaped_mortality = TRUE,
      update_annualLAImax   = TRUE,
      do_closedN_run        = TRUE,
      method_photosynth     = "gs_leuning", # gs_leuning or pmodel
      method_mortality      = "cstarvation" # dbh or cstarvation or growthrate or const_selfthin
      )
```

#### Photosynthesis method
The model includes two methods for estimating NPP:
(a) "gs_leuning" the original method described for the LM3-PPA (Weng et al. 2015).
(b) "pmodel" the implementation of the P-model (Stocker et al. 2020) within the LM3-PPA.
The P-model which simulates acclimated photosynthetic parameters and light use efficiency for daily time steps. 
For the implementation of the P-model in LM3-PPA, GPP is calculated at the cohort-level (not canopy-level), using light absorbed per cohort, and expressed in kg C per day and per tree (or cohort).
PAR is the amount of light reaching the respective layer (mol m-2 s-1).
fAPAR is attenuated based on the leaf area index within-crown of all layers above and on a fixed exponential light extinction (with k=0.75).
LUE is simulated as gpp per unit absorbed light (g C mol−1) and depends on a fix quantum yield efficiency parameter. (kphio Long et al., 1993). 

#### Mortality method
The model allows for four different mortality functional forms: 
(a) "dbh" as a function of size: high mortality rate for large trees (following Weng et al. 2015).
(b) "cstarvation" as a function of tree's C balance: carbon starvation as a decreasing in the cohort’s NSC level.
(c) "growthrate" as a function of growth rate: high mortality rate for faster growing trees.
(d) "const_selfthin" as a constant self-thinning relationship.

### Define model parameters

#### Tile-level parameters

```{r,include=FALSE, eval=TRUE}
params_tile <- tibble( #list

  soiltype     = 3,     # Sand = 1, LoamySand = 2, SandyLoam = 3, SiltLoam = 4, FrittedClay = 5, Loam = 6, Clay = 7
  FLDCAP       = 0.4,   # soil property: field capacity 
  WILTPT       = 0.05,  # soil property: wilting point
  K1           = 2.0,   # turnover rate of fast SOM per year
  K2           = 0.05,  # turnover rate of slow SOM per year
  K_nitrogen   = 8.0,   # mineral Nitrogen turnover rate
  MLmixRatio   = 0.8,   # the ratio of C and N returned to litters from microbes
  etaN         = 0.025, # loss rate with runoff
  LMAmin       = 0.02,  # minimum LMA, boundary condition
  fsc_fine     = 1.0,   # fraction of fast turnover carbon in fine biomass
  fsc_wood     = 0.0,   # fraction of fast turnover carbon in wood biomass
  GR_factor    = 0.33,  # growth respiration factor
  l_fract      = 0.0,   # fraction of the carbon retained after leaf drop
  retransN     = 0.0,   # retranslocation coefficient of Nitrogen
  f_initialBSW = 0.2,
  f_N_add      = 0.02,   # re-fill of N for sapwood
  
  # add calibratable params
  tf_base        = 1,
  par_mort       = 1,    # param_dbh=1 param_csv=1 param_gr=1 CAI_MAX=2
  par_mort_under = 1
  )
```

#### Species-level parameters

```{r,include=FALSE, eval=TRUE}
params_species <- tibble(
  
  lifeform      = rep(1,16),                      # 0 for grasses; 1 for trees
  phenotype     = c(0,1,1,rep(1,13)),             # 0 for Deciduous; 1 for Evergreen
  pt            = rep(0,16),                      # 0 for C3; 1 for C4
  # Root parameters
  alpha_FR      = rep(1.2,16),                    # Fine root turnover rate yr-1
  rho_FR        = rep(200,16),                    # material density of fine roots (kgC m-3)
  root_r        = rep(2.9E-4,16), 
  root_zeta     = rep(0.29,16), 
  Kw_root       = rep(3.5e-09,16),               # mol /(s m2 Mpa)
  leaf_size     = rep(0.04,16), 
  
  # Photosynthesis parameters
  Vmax          = rep(35.0E-6,16),               # mol m-2 s-1
  Vannual       = rep(1.2,16),                   # kgC m-2 yr-1
  wet_leaf_dreg = rep(0.3,16),                   # wet leaf photosynthesis down-regulation: wet leaf is 30% less than dry leaf
  m_cond        = rep(7.0,16), 
  alpha_phot    = rep(0.06,16), 
  gamma_L       = rep(0.02,16), 
  gamma_LN      = rep(70.5 ,16),  # kgC kgN-1 yr-1
  gamma_SW      = rep(0.08,16),   # kgC m-2 Acambium yr-1
  gamma_FR      = rep(12.0,16),   # kgC kgN-1 yr-1
  tc_crit       = rep(283.16,16),   # OFF
  tc_crit_on    = rep(280.16,16),   # ON
  gdd_crit      = rep(280.0,16),   # Simulations 280, 240, 200
  # Allometry parameters
  #alphaHT      = rep(36.0,16),   
  #thetaHT      = rep(0.5,16),   
  #alphaCA      = rep(150.0,16),   
  #thetaCA      = rep(1.5,16),   
  
  seedlingsize  = rep(0.05,16),                   # initial size of seedlings #In Ensheng BiomeE: 0.05
  LNbase        = rep(0.8E-3,16),                 # kgN m-2 leaf, Vmax = 0.03125*LNbase
  lAImax        = rep(3.5,16),                    # maximum crown LAI
  Nfixrate0     = rep(0,16),                      # 0.03 kgN kgRootC-1 yr-1
  NfixCost0     = rep(12,16),                     # 12, 24 gC/gN
  phiCSA        = rep(0.25E-4,16),                # ratio of sapwood area to leaf area
  mortrate_d_c  = rep(0.01,16),                   # canopy tree mortality rate, year-1
  mortrate_d_u  = rep(0.075,16),                  # understory tree mortality rate, year-1
  maturalage    = rep(5,16),                      # the age that can reproduce
  fNSNmax       = rep(5,16),                      # multiplier for NSNmax as sum of potential bl and br
  LMA           = c(0.05,0.17,0.11,rep(0.1,13)),  # Leaf mass per unit area. For sps: Beech-Spruce-Fir # In Ensheng rep(0.035,16)
  rho_wood      = c(590,370,350,rep(300,13)),     # In Ensheng rep(300,16),   # c(590,370,350,rep(300,13)),
  alphaBM       = rep(5200,16),                   #c(0.19,0.15,0.09,rep(0.15,13)), # In Ensheng BiomeE: 5200.0 
  thetaBM       = c(2.36,2.30,2.54,rep(2.30,13)), # In Ensheng BiomeE: 2.5 rep(2.5,16),
  
  # add calibratable params
  kphio         = rep(0.05,16),
  phiRL         = rep(3.5,16),
  LAI_light     = rep(3.5,16)               # Light-limited crown LAI
  
  ) 
```

#### Soil parameters

By layers.
```{r,include=FALSE, eval=TRUE}
# adopted from datatypes.mod.f90 l.538
params_soil <- tibble(
  type              = c("Coarse","Medium","Fine","CM","CF","MF","CMF","Peat","MCM"),
  GMD               = c(0.7, 0.4, 0.3, 0.1, 0.1, 0.07, 0.007, 0.3, 0.3),
  GSD               = c(5.0, 5.3, 7.4, 6.1, 6.1, 14.0, 15.0, 7.4, 7.4),
  vwc_sat           = c(0.380, 0.445, 0.448, 0.412, 0.414, 0.446, 0.424, 0.445, 0.445),
  chb               = c(3.5,6.4,11.0,4.8,6.3,8.4,6.3,6.4,6.4),
  psi_sat_ref       = c(-600, -790, -910, -1580, -1680, -1880, -5980, -790, -790), # Pa
  k_sat_ref         = c(130.8, 75.1, 53.2, 12.1, 11.1, 12.7, 1.69, 53.2, 53.2), # mol/(s MPa m)
  alphaSoil         = rep(1, 9),
  heat_capacity_dry = c(1.2e6, 1.1e6, 1.1e6, 1.1e6, 1.1e6, 1.1e6, 1.1e6, 1.4e6, 1.0)
  )

```

#### Initial cohort specification

Select the species identity of the initial cohorts and initial biomass. With `init_cohort_species = rep(2, 10)` we're selecting ten cohorts of the same species (number 2 or number 1).
```{r,include=FALSE, eval=TRUE}
init_cohort <- tibble(
 init_cohort_species = rep(1, 10),   # indicates sps # 1 - Fagus sylvatica
 init_cohort_nindivs = rep(0.05,10),  # initial individual density, individual/m2 ! 1 indiv/m2 = 10.000 indiv/ha
 init_cohort_bsw     = rep(0.05,10), # initial biomass of sapwood, kg C/individual
 init_cohort_bHW     = rep(0.0, 10), # initial biomass of heartwood, kg C/tree
 init_cohort_nsc     = rep(0.05,10)  # initial non-structural biomass
)
```

#### Initial soil pools

```{r,include=FALSE, eval=TRUE}
# high N input --> Deciduous
# low  N input --> Evergreen
init_soil <- tibble( #list
 init_fast_soil_C    = 0.0,    # initial fast soil C, kg C/m2
 init_slow_soil_C    = 0.0,    # initial slow soil C, kg C/m2
 init_Nmineral       = 0.015,  # Mineral nitrogen pool, (kg N/m2)
 N_input             = 0.0008  # annual N input to soil N pool, kgN m-2 yr-1
)
```

### Define soil parameters

For now, this is implemented as an illustration. Should be made site-specific.
```{r,include=FALSE, eval=TRUE}
df_soiltexture <- bind_rows(
  top    = tibble(layer = "top",    fsand = 0.4, fclay = 0.3, forg = 0.1, fgravel = 0.1),
  bottom = tibble(layer = "bottom", fsand = 0.4, fclay = 0.3, forg = 0.1, fgravel = 0.1)
)
```

### Get input

The file has the following variables (units):

```{r,include=FALSE, eval=TRUE}
load("~/rsofun_local/input_data/forcingLAE.RData") #forcingLAE See script prepare_drivers.Rmd

if (params_siml$method_photosynth == "gs_leuning"){
  forcingLAE <- forcingLAE %>% 
    dplyr::group_by(lubridate::month(datehour),lubridate::day(datehour),lubridate::hour(datehour)) %>% 
    summarise_at(vars(1:13), list(~mean(., na.rm = TRUE)))
  forcing <- forcingLAE[,-c(1:3)]
  forcing <- bind_rows(replicate(800, forcing, simplify = FALSE)) # Duplicate for the # of transient years
}

if (params_siml$method_photosynth == "pmodel"){ #&& dt_secs != (60*60*24)){
  forcingLAE <- forcingLAE %>% 
    dplyr::group_by(lubridate::month(datehour),lubridate::day(datehour)) %>% 
    summarise_at(vars(1:13), list(~mean(., na.rm = TRUE)))
  forcing <- forcingLAE[,-c(1:2)]
  forcing <- bind_rows(replicate(800, forcing, simplify = FALSE)) # Duplicate for the # of transient years
}
```

Changing values of radiation for running simulations

```{r,include=FALSE, eval=TRUE}
if (params_siml$method_photosynth == "gs_leuning"){
forcing <- forcing %>% mutate(Swdown = Swdown*1) # levels = *1, *1.15 and *1.30
#forcing <- forcing %>% mutate(aCO2_AW = aCO2_AW*1.30) # levels = *1, *1.15 and *1.30
}

if (params_siml$method_photosynth == "pmodel"){ 
forcing <- forcing %>% mutate(PAR = PAR*1) # levels = *1, *1.15 and *1.30
}

```

Collect all drivers
```{r,include=FALSE, eval=TRUE}
df_drivers <- tibble(sitename,
                    siteinfo = list(tibble(siteinfo)),
                    params_siml = list(tibble(params_siml)),
                    params_tile = list(tibble(params_tile)),
                    params_species=list(tibble(params_species)),
                    params_soil=list(tibble(params_soil)),
                    init_cohort=list(tibble(init_cohort)),
                    init_soil=list(tibble(init_soil)),
                    forcing=list(tibble(forcing)),
                    .name_repair = "unique")

```

```{r,include=FALSE, eval=TRUE}
#save(df_drivers, file = "~/rsofun/input_data/df_drivers_DBH_gs.RData")
#save(df_drivers, file = "~/rsofun/input_data/df_drivers_NSC_gs.RData")
#save(df_drivers, file = "~/rsofun/input_data/df_drivers_GR_gs.RData")
#save(df_drivers, file = "~/rsofun/input_data/df_drivers_CST_gs.RData")

#save(df_drivers, file = "~/rsofun/input_data/df_drivers_DBH_pm.RData")
#save(df_drivers, file = "~/rsofun/input_data/df_drivers_NSC_pm.RData")
#save(df_drivers, file = "~/rsofun/input_data/df_drivers_GR_pm.RData")
save(df_drivers, file = "~/rsofun/input_data/df_drivers_CST_pm.RData")

```

### Run the model

Run for the full set of sites
```{r,echo=FALSE,eval=TRUE}

load("~/rsofun_local/input_data/df_drivers_DBH_gs.RData")
simul <- df_drivers$params_siml[[1]]

start <- Sys.time()
df_output <- runread_lm3ppa_f(
     df_drivers,
     makecheck = TRUE,
     parallel = FALSE
     )
print(Sys.time() - start)

start <- Sys.time()
out <- run_lm3ppa_f_bysite( df_drivers$sitename[1], 
                            df_drivers$params_siml[[1]],
                            df_drivers$siteinfo[[1]], 
                            df_drivers$forcing[[1]], 
                            df_drivers$params_tile[[1]], 
                            df_drivers$params_species[[1]], 
                            df_drivers$params_soil[[1]], 
                            df_drivers$init_cohort[[1]], 
                            df_drivers$init_soil[[1]],
                            makecheck = TRUE)
print(Sys.time() - start)

write.csv(df_output$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/preDBHp1gs_output_annual_tile.csv")
write.csv(df_output$data[[1]]$output_annual_cohorts,   "~/rsofun/outputs_lm3ppa/preDBHp1gs_output_annual_cohorts.csv")

annual_tile_vegan <- df_output$data[[1]]$output_annual_tile
annual_tile_cohorts <- df_output$data[[1]]$output_annual_cohorts

df_output$data[[1]]$output_annual_tile %>% 
  ggplot() +
  geom_line(aes(x = year, y = plantC)) +
  theme_classic()+labs(x = "Year", y = "plantC")

df_output$data[[1]]$output_annual_tile %>%
  #dplyr::filter(year>500|year>1800) %>%  
  tail(500) %>% 
  ggplot() +
  geom_point(aes(x = log(QMD), y = log(Density12), color=plantC)) +
  theme_classic()+labs(x = "log(QMD)", y = "log(Density12)")

df_output$data[[1]]$output_annual_tile %>%
ggplot() + 
  geom_line(aes(x = year, y = NPP)) + 
  geom_line(aes(x = year, y = m_turnover)) 

df_output$data[[1]]$output_annual_tile %>%
ggplot() + 
  geom_line(aes(x = year, y = NPP)) + 
  geom_line(aes(x = year, y = c_deadtrees)) 

df_output$data[[1]]$output_annual_tile %>%
ggplot() + 
  geom_line(aes(x = year, y = NPP)) + 
  geom_line(aes(x = year, y = c_deadtrees + m_turnover)) 

```

### Get ddf_obs

#### GPP
TARGET 1. GPP data from FluxNet (see Euler)
FLX_CH-Lae_FLUXNET2015_FULLSET_YY_2004-2014_1-3.csv
Variable: GPP_NT_VUT_REF

```{r,include=FALSE, eval=TRUE}
Fluxnet <- read_csv("~/data/FLUXNET-2015_Tier1/20191024/YY/FLX_CH-Lae_FLUXNET2015_FULLSET_YY_2004-2014_1-3.csv")
GPP <- Fluxnet[,c("TIMESTAMP","GPP_NT_VUT_REF")] # g C/m2/yr
# Convert in Kg C/m2/yr as in the LM3-PPA model
GPP <- GPP %>% mutate(GPP_KgC = GPP_NT_VUT_REF/1000)
mean_annual_gpp <- mean(GPP$GPP_KgC) #Kg C/m2/yr
```

#### LAI

TARGET 2. LAI or fAPAr from MODIS
LAI is the one-sided green leaf area per unit ground area in broadleaf canopies and as half the total needle surface area per unit ground area in coniferous canopies. 
FPAR is the fraction of photosynthetically active radiation (400-700 nm) absorbed by green vegetation. 
Both variables are used for calculating surface photosynthesis, evapotranspiration, and net primary production.

Data from Euler or downloaded here using ingestr

```{r,include=FALSE, eval=TRUE}
# LAI
# Reading files
# Use max/q95 and mean LAI across june july august
lai_LAE <- read_csv("~/data/modis_subsets/MODIS_LAI_MCD15A3H_daily_CH-Lae.csv")
lai_LAE <- lai_LAE %>% mutate(month=str_sub(date, 6, 7))
lai_LAE_summer <- lai_LAE %>% dplyr::filter(month=="06"|month=="07"|month=="08")
mean_annual_lai <- mean(lai_LAE_summer$linear, na.rm=T)
max_annual_lai <- quantile(lai_LAE_summer$linear, probs = 0.95, na.rm=T)
```

#### Biomass

TARGET 3. Total Stand Biomass 
Use values of wood density from Forrester et al 2017. 
ln(Biomass) = ln(b0) + b1 ln(DBH)
Biomass = b0*DBH^b1

```{r,include=FALSE, eval=TRUE}
LAE_data <- read_csv("~/data/LWF/Laegeren/20201216_Laegeren_data.csv") # Data from Vova
# Calculate DBH from UMFANG is the circumference (mm) C=2*pi*r. See there are many NA in the variable recorded BHD (dbh).
LAE_data <- LAE_data %>% mutate(DBH_cm = UMFANG/pi)
sort(unique(LAE_data$SPECIES))
load("~/data/biomass/d_param.rda")
d_param_lnb0_AG <- d_param %>% dplyr::filter(equation_n==3,parameter_id==1,component_n=="Aboveground",parameter=="lnb0") %>% rename(SPECIES=species, lnb0_AG=value)
d_param_b1_AG <- d_param %>% dplyr::filter(equation_n==3,parameter_id==1,component_n=="Aboveground",parameter=="b1") %>% rename(SPECIES=species, b1_AG=value)
d_param_lnb0_BG <- d_param %>% dplyr::filter(equation_n==3,parameter_id==1,component_n=="Root mass",parameter=="lnb0") %>% rename(SPECIES=species, lnb0_BG=value)
d_param_b1_BG <- d_param %>% dplyr::filter(equation_n==3,parameter_id==1,component_n=="Root mass",parameter=="b1") %>% rename(SPECIES=species, b1_BG=value)
LAE_data_bio <- LAE_data %>% left_join(d_param_lnb0_AG[,c(1,8)]) %>% left_join(d_param_b1_AG[,c(1,8)]) %>% left_join(d_param_lnb0_BG[,c(1,8)])  %>% left_join(d_param_b1_BG[,c(1,8)]) %>% mutate(lnb0_AG=ifelse(is.na(lnb0_AG),mean(d_param_lnb0_AG$lnb0_AG,na.rm=T),lnb0_AG)) %>% mutate(b1_AG=ifelse(is.na(b1_AG),mean(d_param_b1_AG$b1_AG,na.rm=T),b1_AG)) %>% mutate(lnb0_BG=ifelse(is.na(lnb0_BG),mean(d_param_lnb0_BG$lnb0_BG,na.rm=T),lnb0_BG)) %>% mutate(b1_BG=ifelse(is.na(b1_BG),mean(d_param_b1_BG$b1_BG,na.rm=T),b1_BG)) 
# Filter trees with DBH >= 12 cm
LAE_data_bio <- LAE_data_bio %>% dplyr::filter(DBH_cm >= 12)
# Calcualte Biomass
LAE_data_bio <- LAE_data_bio %>% mutate(AGB_Kg=exp(lnb0_AG)*DBH_cm^b1_AG) %>% mutate(BGB_Kg=exp(lnb0_BG)*DBH_cm^b1_BG) %>% 
  mutate(TreeBiomass_Kg=AGB_Kg+BGB_Kg)
# Summarize by INVYEAR
LAE_data_bio_allsps <- LAE_data_bio %>% group_by(INVYEAR) %>% summarise(TotalBiomass_Kg=sum(TreeBiomass_Kg))
# Area of Laegeren plot in m2
LAE_m2 <- 13400
BiomassLAE <- mean(LAE_data_bio_allsps$TotalBiomass_Kg)/LAE_m2
```

#### Density and size distribution

TARGET 4. Number of trees higher than 12 cm 

```{r,include=FALSE, eval=TRUE}
LAE_data <- read_csv("~/data/LWF/Laegeren/20201216_Laegeren_data.csv") # Data from Vova
LAE_data <- LAE_data %>% mutate(DBH_cm = UMFANG/pi)
LAE_data %>% group_by(INVYEAR) %>% summarise(nTrees=n())
LAE_nTrees <- LAE_data %>% dplyr::filter(DBH_cm >= 12.0)

# For all tree species
LAE_allsps <- LAE_nTrees %>% group_by(INVYEAR) %>% summarise(nTrees=n())
# Area of Laegeren plot in ha
LAE_ha <- 1.34
densityLAE <- mean(LAE_allsps$nTrees)/LAE_ha

# Size distribution
#LAE_nTrees <- LAE_nTrees %>% mutate(size_bins = cut(DBH_cm, breaks = 5)) 
#LAE_nTrees <- LAE_nTrees %>% mutate(size_bins = cut(DBH_cm, breaks = c(12,32,52,72,92,112)))
LAE_nTrees <- LAE_nTrees %>% mutate(size_bins = cut(DBH_cm, breaks = quantile(DBH_cm, probs = seq(0, 1, 0.2)),include.lowest=TRUE))

#library(Hmisc)
#LAE_nTrees$size_bins <- cut2(LAE_nTrees$DBH_cm, g = 5)
v1 <- sort(unique(LAE_nTrees$size_bins))
sizedist <- as.numeric(c(substr(v1, 2, 5),substr(v1[5], 7, 9))) + c(0,0,0,0,0,10) # increase top trees for simulations

LAE_size_dist <- LAE_nTrees %>% group_by(size_bins,INVYEAR) %>% summarise(nTrees=n()) %>% ungroup() %>% group_by(size_bins) %>% summarise(nTrees=mean(nTrees)/LAE_ha)
ggplot(LAE_size_dist, aes(size_bins, nTrees)) + geom_col()

```

#### Prepare the observed target variables: ddf_obs

```{r,include=FALSE, eval=TRUE}
#ddf_obs <- tibble(GPP = mean_annual_gpp, LAI = max_annual_lai, Density= densityLAE, Biomass=BiomassLAE) %>%
#  pivot_longer(everything(), names_to = "variables", values_to = "targets_obs")

# Mean absolute difference for the size distribution
ddf_obs <- data.frame(
    variables = c("GPP","LAI","Biomass","dbh_c1","dbh_c2","dbh_c3","dbh_c4","dbh_c5"),
    targets_obs = c(mean_annual_gpp, max_annual_lai, BiomassLAE,LAE_size_dist$nTrees[1],LAE_size_dist$nTrees[2],LAE_size_dist$nTrees[3],LAE_size_dist$nTrees[4],LAE_size_dist$nTrees[5])
    ) 

save(ddf_obs, file = "~/rsofun/input_data/ddf_obs.RData")
load("~/rsofun_local/input_data/ddf_obs.RData")

```

#### Observed vs. simulated targets - DBH

```{r,include=TRUE, eval=TRUE,fig.width = 5, fig.height = 5}

preDBHp1gl_out_annual_tile <- read.csv("~/rsofun/outputs_lm3ppa/preDBHp1gs_output_annual_tile.csv")
preDBHp1gl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/preDBHp1gs_output_annual_cohorts.csv")

df_mod <- preDBHp1gl_out_annual_tile %>% 
    tail(df_drivers$params_siml[[1]]$nyeartrend) %>% 
    dplyr::summarise(GPP = mean(GPP), LAI= quantile(LAI, probs = 0.95, na.rm=T), Biomass=mean(plantC))

df_mod_sizedist <- preDBHp1gl_out_annual_cohorts %>%
    dplyr::filter(year>df_drivers$params_siml[[1]]$spinupyears) %>% 
    dplyr::filter(dbh>12.1) %>% mutate(size_bins = cut(dbh, breaks = sizedist)) %>%
    group_by(size_bins,year) %>% summarise(nTrees=sum(density)) %>% ungroup() %>% 
    group_by(size_bins) %>% summarise(nTrees=mean(nTrees))

dff <- data.frame(
    variables = c("GPP","LAI","Biomass","dbh_c1","dbh_c2","dbh_c3","dbh_c4","dbh_c5"),
    targets_mod = c(df_mod$GPP, df_mod$LAI, df_mod$Biomass,df_mod_sizedist$nTrees[1],df_mod_sizedist$nTrees[2],df_mod_sizedist$nTrees[3],df_mod_sizedist$nTrees[4],df_mod_sizedist$nTrees[5])
    ) %>% dplyr::left_join(ddf_obs, by = "variables")
  
precalibDBH <- dff %>% 
  ggplot() +
  geom_point(aes(x = targets_mod, y = targets_obs, col=variables)) +
  theme_classic()+labs(x = "Predicted", y = "Observed") +
  geom_abline(col="grey") + ggtitle("Before calibration - DBH gs-Leuning") +
  facet_wrap(~variables,nrow = 4) + theme(legend.position = "none")

```

#### Observed vs. simulated targets - NSC

```{r,include=TRUE, eval=TRUE,fig.width = 5, fig.height = 5}

preNSCgl_out_annual_tile <- read.csv("~/rsofun/outputs_lm3ppa/preNSCgs_output_annual_tile.csv")
preNSCgl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/preNSCgs_output_annual_cohorts.csv")

df_mod <- preNSCgl_out_annual_tile %>% 
    tail(df_drivers$params_siml[[1]]$nyeartrend) %>% 
    dplyr::summarise(GPP = mean(GPP), LAI= quantile(LAI, probs = 0.95, na.rm=T), Biomass=mean(plantC))

df_mod_sizedist <- preNSCgl_out_annual_cohorts %>%
    dplyr::filter(year>df_drivers$params_siml[[1]]$spinupyears) %>% 
    dplyr::filter(dbh>12.1) %>% mutate(size_bins = cut(dbh, breaks = sizedist)) %>%
    group_by(size_bins,year) %>% summarise(nTrees=sum(density)) %>% ungroup() %>% 
    group_by(size_bins) %>% summarise(nTrees=mean(nTrees))

dff <- data.frame(
    variables = c("GPP","LAI","Biomass","dbh_c1","dbh_c2","dbh_c3","dbh_c4","dbh_c5"),
    targets_mod = c(df_mod$GPP, df_mod$LAI, df_mod$Biomass,df_mod_sizedist$nTrees[1],df_mod_sizedist$nTrees[2],df_mod_sizedist$nTrees[3],df_mod_sizedist$nTrees[4],df_mod_sizedist$nTrees[5])
    ) %>% dplyr::left_join(ddf_obs, by = "variables")
  
precalibNSC <- dff %>% 
  ggplot() +
  geom_point(aes(x = targets_mod, y = targets_obs, col=variables)) +
  theme_classic()+labs(x = "Predicted", y = "Observed")+
  geom_abline(col="grey") + ggtitle("Before calibration - NSC gs-Leuning") +
  facet_wrap(~variables,nrow = 4) + theme(legend.position = "none")

```

#### Observed vs. simulated targets - GR

```{r,include=TRUE, eval=TRUE,fig.width = 5, fig.height = 5}

preGRgl_out_annual_tile <- read.csv("~/rsofun/outputs_lm3ppa/preGRgs_output_annual_tile.csv")
preGRgl_out_annual_cohorts <- read.csv("~/rsofun/outputs_lm3ppa/preGRgs_output_annual_cohorts.csv")

df_mod <- preGRgl_out_annual_tile %>% 
    tail(df_drivers$params_siml[[1]]$nyeartrend) %>% 
    dplyr::summarise(GPP = mean(GPP), LAI= quantile(LAI, probs = 0.95, na.rm=T), Biomass=mean(plantC))

df_mod_sizedist <- preGRgl_out_annual_cohorts %>%
    dplyr::filter(year>df_drivers$params_siml[[1]]$spinupyears) %>% 
    dplyr::filter(dbh>12.1) %>% mutate(size_bins = cut(dbh, breaks = sizedist)) %>%
    group_by(size_bins,year) %>% summarise(nTrees=sum(density)) %>% ungroup() %>% 
    group_by(size_bins) %>% summarise(nTrees=mean(nTrees))

dff <- data.frame(
    variables = c("GPP","LAI","Biomass","dbh_c1","dbh_c2","dbh_c3","dbh_c4","dbh_c5"),
    targets_mod = c(df_mod$GPP, df_mod$LAI, df_mod$Biomass,df_mod_sizedist$nTrees[1],df_mod_sizedist$nTrees[2],df_mod_sizedist$nTrees[3],df_mod_sizedist$nTrees[4],df_mod_sizedist$nTrees[5])
    ) %>% dplyr::left_join(ddf_obs, by = "variables")
  
precalibGR <- dff %>% 
  ggplot() +
  geom_point(aes(x = targets_mod, y = targets_obs, col=variables)) +
  theme_classic()+labs(x = "Predicted", y = "Observed")+
  geom_abline(col="grey") + ggtitle("Before calibration - GR gs-Leuning") +
  facet_wrap(~variables,nrow = 4) + theme(legend.position = "none")

```

### Define calibration settings
Targets: GPP, LAI, Stand Biomass (Stem, Foliage, root), # trees
Calibration parameters: Quantum Yield Efficiency (kphio), Root:Shoot ratio (phiRL), Plant respiration (tf), mortality parameter specific of each formulation.

#### DBH mortality

```{r,include=FALSE, eval=TRUE}

settings_calib_DBH_gs <- list(
  method              = "gensa",
  targetvars          = c("targets_obs"),
  timescale           = list(targets_obs = "y"),
  maxit               = 1000, # (5 for gensa) (30 for optimr)
  sitenames           = "CH-Lae",
  metric              = "rmse",
  dir_results         = "./",
  name                = "ORG",
  par                 = list(phiRL = list(lower=0.5, upper=5, init=3.5),
                             LAI_light = list(lower=2, upper=5, init=3.5),
                             tf_base = list(lower=0.5, upper=1.5, init=1),
                             par_mort = list(lower=0.1, upper=2, init=1),
                             par_mort_under = list(lower=0.1, upper=2, init=1))
 )

```

#### NSC mortality

```{r,include=FALSE, eval=TRUE}

settings_calib_NSC_gs <- list(
  method              = "gensa", # gensa, optimr, BayesianTools, linscale
  targetvars          = c("targets_obs"),
  timescale           = list(targets_obs = "y"),
  maxit               = 5, # (5 for gensa) (30 for optimr)
  sitenames           = "CH-Lae",
  metric              = "rmse",
  dir_results         = "./",
  name                = "ORG",
  par                 = list(phiRL = list(lower=0.5, upper=5, init=3.5),
                             LAI_light = list(lower=0.5, upper=5, init=3.5),
                             tf_base = list(lower=0.6, upper=1.5, init=1),
                             par_mort = list(lower=0.1, upper=2, init=1),
                             par_mort_under = list(lower=0.1, upper=2, init=1))
 )

save(settings_calib_NSC_gs, file = "~/rsofun/input_data/settings_calib_NSC_gs.RData")

```

#### GR mortality

```{r,include=FALSE, eval=TRUE}

settings_calib_GR_gs <- list(
  method              = "gensa", # gensa, optimr, BayesianTools, linscale
  targetvars          = c("targets_obs"),
  timescale           = list(targets_obs = "y"),
  maxit               = 5, # (5 for gensa) (30 for optimr)
  sitenames           = "CH-Lae",
  metric              = "rmse",
  dir_results         = "./",
  name                = "ORG",
  par                 = list(phiRL = list(lower=0.5, upper=5, init=3.5),
                             LAI_light = list(lower=2, upper=5, init=3.5),
                             tf_base = list(lower=0.5, upper=1.5, init=1),
                             par_mort = list(lower=0.1, upper=2, init=1),
                             par_mort_under = list(lower=0.1, upper=2, init=1))
 )

```

#### CST mortality

```{r,include=FALSE, eval=TRUE}

settings_calib_CST_gs <- list(
  method              = "gensa", # gensa, optimr, BayesianTools, linscale
  targetvars          = c("targets_obs"),
  timescale           = list(targets_obs = "y"),
  maxit               = 5, # (5 for gensa) (30 for optimr)
  sitenames           = "CH-Lae",
  metric              = "rmse",
  dir_results         = "./",
  name                = "ORG",
  par                 = list(phiRL = list(lower=0.5, upper=5, init=3.5),
                             LAI_light = list(lower=2, upper=5, init=3.5),
                             tf_base = list(lower=0.5, upper=1.5, init=1),
                             par_mort = list(lower=0.5, upper=4, init=2),
                             par_mort_under = list(lower=0.1, upper=2, init=1))
 )

```

### Calibrate the model

#### DBH mortality

```{r,include=FALSE, eval=FALSE}
load("~/rsofun/input_data/df_drivers_DBH_gs.RData")
set.seed(1152)
#settings <- settings_calib_DBH_gs
settings_calib_DBH_gs <- calib_sofun(
  df_drivers = df_drivers,  
  ddf_obs = ddf_obs,
  settings = settings_calib_DBH_gs
  )

print(settings_calib_DBH_gs$par_opt)
save(settings_calib_DBH_gs, file = "~/rsofun/input_data/settings_calib_DBH_gs.RData")

```

#### NSC mortality

```{r,include=FALSE, eval=FALSE}
load("~/rsofun_local/input_data/df_drivers_NSC_gs.RData")
set.seed(1152)
settings_calib_NSC_gs <- calib_sofun(
  df_drivers = df_drivers,  
  ddf_obs = ddf_obs,
  settings = settings_calib_NSC_gs
  )

print(settings_calib_NSC_gs$par_opt)
save(settings_calib_NSC_gs, file = "~/rsofun/input_data/settings_calib_NSC_gs2nd.RData")

```

#### GR mortality

```{r,include=FALSE, eval=FALSE}
load("~/rsofun/input_data/df_drivers_GR_gs.RData")
set.seed(1050)
settings_calib_GR_gs <- calib_sofun(
  df_drivers = df_drivers,  
  ddf_obs = ddf_obs,
  settings = settings_calib_GR_gs
  )

print(settings_calib_GR_gs$par_opt)
save(settings_calib_GR_gs, file = "~/rsofun/input_data/settings_calib_GR_gs2.RData")

```

#### CST mortality

```{r,include=FALSE, eval=FALSE}

set.seed(1152)
settings_calib_CST_gs <- calib_sofun(
  df_drivers = df_drivers,  
  ddf_obs = ddf_obs,
  settings = settings_calib_CST_gs
  )

print(settings_calib_CST_gs$par_opt)
save(settings_calib_CST_gs, file = "~/rsofun/input_data/settings_calib_CST_gs.RData")

```

### Evaluate the model

#### DBH mortality
DBH param 1,2,3 - Calibration for param 2

```{r,fig.width = 5, fig.height = 5}
load("~/rsofun/input_data/df_drivers_DBH_gs.RData")
load("~/rsofun/input_data/settings_calib_DBH_gs_1_euler.RData")
load("~/rsofun/input_data/settings_calib_DBH_gs_2_euler.RData")
load("~/rsofun/input_data/settings_calib_DBH_gs_3_euler.RData")
load("~/rsofun/data/inputs/settings_calib_DBH_gs_uniq_euler.RData")
load("~/rsofun/data/inputs/settings_calib_DBH_gs_rev0_euler.RData")
load("~/rsofun/data/inputs/settings_calib_DBH_gs_rev1_euler.RData")
load("~/rsofun/data/inputs/settings_calib_DBH_gs_rev2_euler.RData")

#calib_param_dbh_gs <- read.csv("~/rsofun/params_calib_dbh_gs.csv")
#settings_calib_DBH_gs$par_opt <- calib_param_dbh_gs[1,]

df_drivers$params_species[[1]]$phiRL      <-  settings_calib_DBH_gs$par_opt["phiRL"] #$phiRL  
df_drivers$params_species[[1]]$LAI_light  <-  settings_calib_DBH_gs$par_opt["LAI_light"]
df_drivers$params_tile[[1]]$tf_base       <-  settings_calib_DBH_gs$par_opt["tf_base"]
df_drivers$params_tile[[1]]$par_mort      <-  settings_calib_DBH_gs$par_opt["par_mort"]
df_drivers$params_tile[[1]]$par_mort_under<-  settings_calib_DBH_gs$par_opt["par_mort_under"]

settings_calib_DBH_gs$par_opt["LAI_light"] <- 4.1263076
settings_calib_DBH_gs$par_opt["tf_base"] <- 0.5339663
settings_calib_DBH_gs$par_opt["par_mort_under"] <- 0.4934812
save(settings_calib_DBH_gs, file = "~/rsofun/data/inputs/settings_calib_DBH_gs_rev_euler.RData")

#df_drivers$params_species[[1]]$rho_wood  <- 600 # 300, 450, 600

df_calib_DBH_gs <- runread_lm3ppa_f(
     df_drivers,
     makecheck = TRUE,
     parallel = FALSE
     )

df_calib_DBH_gs$data[[1]]$output_annual_tile %>% 
  ggplot() +
  geom_line(aes(x = year, y = plantC)) +
  theme_classic()+labs(x = "Year", y = "plantC")

df_calib_DBH_gs$data[[1]]$output_annual_tile %>% 
  filter(year>=1400) %>% 
  ggplot() +
  geom_point(aes(x = log(QMD), y = log(Density12))) +
  theme_classic()+labs(x = "QMD", y = "Density12")

df_mod <- df_calib_DBH_gs$data[[1]]$output_annual_tile %>% 
    tail(df_drivers$params_siml[[1]]$nyeartrend) %>% 
    dplyr::summarise(GPP = mean(GPP), LAI= quantile(LAI, probs = 0.95, na.rm=T), Biomass=mean(plantC))

df_mod_sizedist <- df_calib_DBH_gs$data[[1]]$output_annual_cohorts %>%
    dplyr::filter(year>df_drivers$params_siml[[1]]$spinupyears) %>% 
    dplyr::filter(dbh>12.1) %>% mutate(size_bins = cut(dbh, breaks = sizedist)) %>%
    group_by(size_bins,year) %>% summarise(nTrees=sum(density)) %>% ungroup() %>% 
    group_by(size_bins) %>% summarise(nTrees=mean(nTrees))

dff <- data.frame(
    variables = c("GPP","LAI","Biomass","dbh_c1","dbh_c2","dbh_c3","dbh_c4","dbh_c5"),
    targets_mod = c(df_mod$GPP, df_mod$LAI, df_mod$Biomass,df_mod_sizedist$nTrees[1],df_mod_sizedist$nTrees[2],df_mod_sizedist$nTrees[3],df_mod_sizedist$nTrees[4],df_mod_sizedist$nTrees[5])
    ) %>% dplyr::left_join(ddf_obs, by = "variables")
  
postcalibDBH <- dff %>% 
  ggplot() +
  geom_point(aes(x = targets_mod, y = targets_obs, col=variables)) +
  theme_classic()+labs(x = "Predicted", y = "Observed")+
  geom_abline(col="grey") + ggtitle("After calibration - DBH gs-Leuning") +
  facet_wrap(~variables,nrow = 4) + theme(legend.position = "none")
```

```{r,fig.width = 8, fig.height = 5}
# Join plots
library(ggpubr)
ggarrange(precalibDBH,postcalibDBH,ncol = 2, nrow = 1,align = "v")
```

#### NSC mortality
NSC param 1,2,3 - Calibration for param 2

```{r,fig.width = 5, fig.height = 5}
load("~/rsofun/input_data/df_drivers_NSC_gs.RData")
load("~/rsofun/input_data/settings_calib_NSC_gs_2_euler.RData")
#calib_param_nsc_gs <- read.csv("~/rsofun/params_calib_nsc_gs.csv")
#settings_calib_NSC_gs$par_opt <- calib_param_nsc_gs[1,]

df_drivers$params_species[[1]]$phiRL      <-  settings_calib_NSC_gs$par_opt["phiRL"] #$phiRL 
df_drivers$params_species[[1]]$LAI_light  <-  settings_calib_NSC_gs$par_opt["LAI_light"]
df_drivers$params_tile[[1]]$tf_base       <-  settings_calib_NSC_gs$par_opt["tf_base"]
df_drivers$params_tile[[1]]$par_mort      <-  settings_calib_NSC_gs$par_opt["par_mort"]
df_drivers$params_tile[[1]]$par_mort_under<-  settings_calib_NSC_gs$par_opt["par_mort_under"]

#df_drivers$params_species[[1]]$rho_wood  <- 600 # 300, 450, 600

df_calib_NSC_gs <- runread_lm3ppa_f(
     df_drivers,
     makecheck = TRUE,
     parallel = FALSE
     )

df_calib_NSC_gs$data[[1]]$output_annual_tile %>% 
  ggplot() +
  geom_line(aes(x = year, y = plantC)) +
  theme_classic()+labs(x = "Year", y = "plantC")

df_calib_NSC_gs$data[[1]]$output_annual_tile %>%
  tail(700) %>% 
  ggplot() +
  geom_line(aes(x = DBH12, y = Density12)) +
  theme_classic()+labs(x = "DBH12", y = "Density12")

df_calib_NSC_gs$data[[1]]$output_annual_cohorts %>%
  filter(dbh > 12) %>% 
  ggplot() +
  geom_line(aes(x = dbh, y = density)) +
  theme_classic()+labs(x = "dbh", y = "density")

df_calib_NSC_gs$data[[1]]$output_annual_cohorts %>%
  filter(dbh > 12) %>% 
  ggplot() +
  geom_line(aes(x = dbh, y = NPP_yr/GPP_yr)) +
  theme_classic()+labs(x = "dbh", y = "CUE")

zzz <- df_calib_NSC_gs$data[[1]]$output_annual_cohorts

df_mod <- df_calib_NSC_gs$data[[1]]$output_annual_tile %>% 
    tail(df_drivers$params_siml[[1]]$nyeartrend) %>% 
    dplyr::summarise(GPP = mean(GPP), LAI= quantile(LAI, probs = 0.95, na.rm=T), Biomass=mean(plantC))

df_mod_sizedist <- df_calib_NSC_gs$data[[1]]$output_annual_cohorts %>%
    dplyr::filter(year>df_drivers$params_siml[[1]]$spinupyears) %>% 
    dplyr::filter(dbh>12.1) %>% mutate(size_bins = cut(dbh, breaks = sizedist)) %>%
    group_by(size_bins,year) %>% summarise(nTrees=sum(density)) %>% ungroup() %>% 
    group_by(size_bins) %>% summarise(nTrees=mean(nTrees))

dff <- data.frame(
    variables = c("GPP","LAI","Biomass","dbh_c1","dbh_c2","dbh_c3","dbh_c4","dbh_c5"),
    targets_mod = c(df_mod$GPP, df_mod$LAI, df_mod$Biomass,df_mod_sizedist$nTrees[1],df_mod_sizedist$nTrees[2],df_mod_sizedist$nTrees[3],df_mod_sizedist$nTrees[4],df_mod_sizedist$nTrees[5])
    ) %>% dplyr::left_join(ddf_obs, by = "variables")
  
postcalibNSC <- dff %>% 
  ggplot() +
  geom_point(aes(x = targets_mod, y = targets_obs, col=variables)) +
  theme_classic()+labs(x = "Predicted", y = "Observed")+
  geom_abline(col="grey") + ggtitle("After calibration - NSC gs-Leuning") +
  facet_wrap(~variables,nrow = 4) + theme(legend.position = "none")
```

```{r,fig.width = 8, fig.height = 5}
# Join plots
library(ggpubr)
ggarrange(precalibNSC,postcalibNSC,ncol = 2, nrow = 1,align = "v")

```

#### GR mortality
GR param 1,2,3 - Calibration for param 2

```{r,fig.width = 5, fig.height = 5}
load("~/rsofun/input_data/df_drivers_GR_gs.RData")
load("~/rsofun/input_data/settings_calib_GR_gs_2_euler.RData")
load("~/rsofun/input_data/settings_calib_GR_gs_uniq_euler.RData")

#calib_param_gr_gs <- read.csv("~/rsofun/params_calib_gr_gs.csv")
#settings_calib_GR_gs$par_opt <- calib_param_gr_gs[1,]

df_drivers$params_species[[1]]$phiRL      <-  settings_calib_GR_gs$par_opt["phiRL"]
df_drivers$params_species[[1]]$LAI_light  <-  settings_calib_GR_gs$par_opt["LAI_light"]
df_drivers$params_tile[[1]]$tf_base       <-  settings_calib_GR_gs$par_opt["tf_base"]
df_drivers$params_tile[[1]]$par_mort      <-  settings_calib_GR_gs$par_opt["par_mort"]
df_drivers$params_tile[[1]]$par_mort_under<-  settings_calib_GR_gs$par_opt["par_mort_under"]

#df_drivers$params_species[[1]]$rho_wood  <- 600 # 300, 450, 600

df_calib_GR_gs <- runread_lm3ppa_f(
     df_drivers,
     makecheck = TRUE,
     parallel = FALSE
     )

df_calib_GR_gs$data[[1]]$output_annual_tile %>% 
  ggplot() +
  geom_line(aes(x = year, y = plantC)) +
  theme_classic()+labs(x = "Year", y = "plantC")

df_calib_GR_gs$data[[1]]$output_annual_tile %>% 
  ggplot() +
  geom_line(aes(x = year, y = c_deadtrees)) +
  theme_classic()+labs(x = "Year", y = "c_deadtrees")

df_mod <- df_calib_GR_gs$data[[1]]$output_annual_tile %>% 
    tail(df_drivers$params_siml[[1]]$nyeartrend) %>% 
    dplyr::summarise(GPP = mean(GPP), LAI= quantile(LAI, probs = 0.95, na.rm=T), Biomass=mean(plantC))

df_mod_sizedist <- df_calib_GR_gs$data[[1]]$output_annual_cohorts %>%
    dplyr::filter(year>df_drivers$params_siml[[1]]$spinupyears) %>% 
    dplyr::filter(dbh>12.1) %>% mutate(size_bins = cut(dbh, breaks = sizedist)) %>%
    group_by(size_bins,year) %>% summarise(nTrees=sum(density)) %>% ungroup() %>% 
    group_by(size_bins) %>% summarise(nTrees=mean(nTrees))

dff <- data.frame(
    variables = c("GPP","LAI","Biomass","dbh_c1","dbh_c2","dbh_c3","dbh_c4","dbh_c5"),
    targets_mod = c(df_mod$GPP, df_mod$LAI, df_mod$Biomass,df_mod_sizedist$nTrees[1],df_mod_sizedist$nTrees[2],df_mod_sizedist$nTrees[3],df_mod_sizedist$nTrees[4],df_mod_sizedist$nTrees[5])
    ) %>% dplyr::left_join(ddf_obs, by = "variables")
  
postcalibGR <- dff %>% 
  ggplot() +
  geom_point(aes(x = targets_mod, y = targets_obs, col=variables)) +
  theme_classic()+labs(x = "Predicted", y = "Observed")+
  geom_abline(col="grey") + ggtitle("After calibration - GR gs-Leuning") +
  facet_wrap(~variables,nrow = 4) + theme(legend.position = "none")
```

```{r,fig.width = 10, fig.height = 7}
# Join plots
library(ggpubr)
ggarrange(precalibGR,postcalibGR,ncol = 2, nrow = 1,align = "v")
```

#### CST mortality

```{r}
load("~/rsofun/input_data/df_drivers_CST_gs.RData")
load("~/rsofun/input_data/settings_calib_CST_gs.RData")

df_drivers$params_species[[1]]$phiRL  <-     settings_calib_CST_gs$par_opt["phiRL"]
df_drivers$params_species[[1]]$LAI_light  <- settings_calib_CST_gs$par_opt["LAI_light"]
df_drivers$params_tile[[1]]$tf_base  <-      settings_calib_CST_gs$par_opt["tf_base"]
df_drivers$params_tile[[1]]$par_mort <-      settings_calib_CST_gs$par_opt["par_mort"]

df_calib_CST_gs <- runread_lm3ppa_f(
     df_drivers,
     makecheck = TRUE,
     parallel = FALSE
     )

df_calib_CST_gs$data[[1]]$output_annual_tile %>% 
  ggplot() +
  geom_line(aes(x = year, y = GPP)) +
  theme_classic()+labs(x = "Year", y = "GPP")

df_calib_CST_gs$data[[1]]$output_annual_tile %>% 
  ggplot() +
  geom_line(aes(x = year, y = plantC)) +
  theme_classic()+labs(x = "Year", y = "plantC")

df_calib_CST_gs$data[[1]]$output_annual_tile %>% 
  ggplot() +
  geom_line(aes(x = year, y = Density12)) +
  theme_classic()+labs(x = "Year", y = "Density12")

df_calib_CST_gs$data[[1]]$output_annual_tile %>% 
  ggplot() +
  geom_line(aes(x = log(QMD), y = log(Density12), color=plantC)) +
  theme_classic()+labs(x = "log(QMD)", y = "log(Density12)")

df_calib_CST_gs$data[[1]]$output_annual_tile %>%
  #tail(500) %>%
  summarise(GPP = mean(GPP), LAI= max(LAI), Density=mean(Density12), Biomass=mean(plantC)) %>%  
  pivot_longer(everything(), names_to = "variables", values_to = "targets_mod") %>%  
  left_join(ddf_obs)

df_calib_CST_gs$data[[1]]$output_annual_tile %>%
  tail(500) %>%
  summarise(GPP = mean(GPP), LAI= max(LAI), Density=mean(Density12), Biomass=mean(plantC)) %>%  
  pivot_longer(everything(), names_to = "variables", values_to = "targets_mod") %>%  
  left_join(ddf_obs) %>% 
  ggplot() +
  geom_point(aes(x = targets_mod, y = targets_obs, col=variables)) +
  theme_classic()+labs(x = "Predicted", y = "Observed")+
  geom_abline(col="grey") + ggtitle("DBH mortality model gs-Leuning")

```

### Write model outputs

#### DBH mortality

```{r}
# LUE
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sa1DBHgl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sa1DBHgl_out_annual_cohorts.csv")

write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea2sa1DBHgl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea2sa1DBHgl_out_annual_cohorts.csv")

write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea3sa1DBHgl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea3sa1DBHgl_out_annual_cohorts.csv")

# rho_wood
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sb1DBHgl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sb1DBHgl_out_annual_cohorts.csv")

write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sb2DBHgl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sb2DBHgl_out_annual_cohorts.csv")

write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sb3DBHgl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sb3DBHgl_out_annual_cohorts.csv")
```

##### DBH p1
```{r}
# LUE
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sa1DBHp1gl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sa1DBHp1gl_out_annual_cohorts.csv")

write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea2sa1DBHp1gl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea2sa1DBHp1gl_out_annual_cohorts.csv")

write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea3sa1DBHp1gl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea3sa1DBHp1gl_out_annual_cohorts.csv")

# rho_wood
```

##### DBH p2
```{r}
# LUE
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sa1DBHp2gl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sa1DBHp2gl_out_annual_cohorts.csv")

write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea2sa1DBHp2gl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea2sa1DBHp2gl_out_annual_cohorts.csv")

write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea3sa1DBHp2gl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea3sa1DBHp2gl_out_annual_cohorts.csv")

# rho_wood
```

##### DBH p3
```{r}
# LUE
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sa1DBHp3gl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sa1DBHp3gl_out_annual_cohorts.csv")

write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea2sa1DBHp3gl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea2sa1DBHp3gl_out_annual_cohorts.csv")

write.csv(df_calib_DBH_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea3sa1DBHp3gl_out_annual_tile.csv")
write.csv(df_calib_DBH_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea3sa1DBHp3gl_out_annual_cohorts.csv")

# rho_wood
```

#### NSC mortality

```{r}
# LUE
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sa1NSCgl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sa1NSCgl_out_annual_cohorts.csv")

write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea2sa1NSCgl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea2sa1NSCgl_out_annual_cohorts.csv")

write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea3sa1NSCgl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea3sa1NSCgl_out_annual_cohorts.csv")

# rho_wood
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sb1NSCgl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sb1NSCgl_out_annual_cohorts.csv")

write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sb2NSCgl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sb2NSCgl_out_annual_cohorts.csv")

write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sb3NSCgl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sb3NSCgl_out_annual_cohorts.csv")
```

##### NSC p1

```{r}
# LUE
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sa1NSCp1gl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sa1NSCp1gl_out_annual_cohorts.csv")

write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea2sa1NSCp1gl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea2sa1NSCp1gl_out_annual_cohorts.csv")

write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea3sa1NSCp1gl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea3sa1NSCp1gl_out_annual_cohorts.csv")

```

##### NSC p2

```{r}
# LUE
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sa1NSCp2gl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sa1NSCp2gl_out_annual_cohorts.csv")

write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea2sa1NSCp2gl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea2sa1NSCp2gl_out_annual_cohorts.csv")

write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea3sa1NSCp2gl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea3sa1NSCp2gl_out_annual_cohorts.csv")

```

##### NSC p3

```{r}
# LUE
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sa1NSCp3gl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sa1NSCp3gl_out_annual_cohorts.csv")

write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea2sa1NSCp3gl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea2sa1NSCp3gl_out_annual_cohorts.csv")

write.csv(df_calib_NSC_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea3sa1NSCp3gl_out_annual_tile.csv")
write.csv(df_calib_NSC_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea3sa1NSCp3gl_out_annual_cohorts.csv")

```

#### GR mortality

```{r}
# LUE
write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sa1GRgl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sa1GRgl_out_annual_cohorts.csv")

write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea2sa1GRgl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea2sa1GRgl_out_annual_cohorts.csv")

write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea3sa1GRgl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea3sa1GRgl_out_annual_cohorts.csv")

# rho_wood
write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sb1GRgl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sb1GRgl_out_annual_cohorts.csv")

write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sb2GRgl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sb2GRgl_out_annual_cohorts.csv")

write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sb3GRgl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sb3GRgl_out_annual_cohorts.csv")
```

##### GR p1

```{r}
# LUE
write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sa1GRp1gl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sa1GRp1gl_out_annual_cohorts.csv")

write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea2sa1GRp1gl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea2sa1GRp1gl_out_annual_cohorts.csv")

write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea3sa1GRp1gl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea3sa1GRp1gl_out_annual_cohorts.csv")
```

##### GR p2

```{r}
# LUE
write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sa1GRp2gl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sa1GRp2gl_out_annual_cohorts.csv")

write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea2sa1GRp2gl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea2sa1GRp2gl_out_annual_cohorts.csv")

write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea3sa1GRp2gl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea3sa1GRp2gl_out_annual_cohorts.csv")
```

##### GR p3

```{r}
# LUE
write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea1sa1GRp3gl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea1sa1GRp3gl_out_annual_cohorts.csv")

write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea2sa1GRp3gl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea2sa1GRp3gl_out_annual_cohorts.csv")

write.csv(df_calib_GR_gs$data[[1]]$output_annual_tile,   "~/rsofun/outputs_lm3ppa/ea3sa1GRp3gl_out_annual_tile.csv")
write.csv(df_calib_GR_gs$data[[1]]$output_annual_cohorts,"~/rsofun/outputs_lm3ppa/ea3sa1GRp3gl_out_annual_cohorts.csv")
```

#### CST mortality
