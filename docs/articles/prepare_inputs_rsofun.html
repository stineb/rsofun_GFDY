<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prepare rsofun forcing data • rsofun</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Prepare rsofun forcing data">
<meta property="og:description" content="rsofun">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rsofun</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/benchmark_gpp_FLUXNET2015_ensemble_EXAMPLE.html">Benchmarking rsofun</a>
    </li>
    <li>
      <a href="../articles/example_lm3ppa.html">Example using LM3-PPA</a>
    </li>
    <li>
      <a href="../articles/example_pmodel.html">Example using P-model</a>
    </li>
    <li>
      <a href="../articles/prepare_inputs_rsofun.html">Prepare rsofun forcing data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/stineb/rsofun/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="prepare_inputs_rsofun_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Prepare rsofun forcing data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/stineb/rsofun/blob/master/vignettes/prepare_inputs_rsofun.Rmd"><code>vignettes/prepare_inputs_rsofun.Rmd</code></a></small>
      <div class="hidden name"><code>prepare_inputs_rsofun.Rmd</code></div>

    </div>

    
    
<p>The following describes how to use the <a href="https://stineb.github.io/ingestr/">ingestr R package</a> for collecting rsofun forcing data. This is to create the object <code>df_drivers</code>, required as an input (forcing) to rsofun. rsofun is designed for site-level (point-scale) simulations and is scalable (parallelised, using *multidplyr*), enabling large ensemble simulations.</p>
<p>This vignette describes forcing data collection for two typical cases of site ensemble simulations:</p>
<ul>
<li><p>Ensemble simulations for a **network** of sites, where specifically formatted site-level climate forcing data is provided, e.g., FLUXNET simulations.</p></li>
<li><p>Ensemble simulations for **“no-network”** sites, i.e., where no site-specific environmental forcing data is provided. In this case, climate forcing data is read from global maps, given the geographical location of sites.</p></li>
</ul>
<p>This vignette is specific for collecting forcing data where no site-specific measurements are available, but all data is extracted from global maps. Head over to the vignette <code>prepare_fluxnetinputs_rsofun.Rmd</code> for an example for collecting forcing data for a FLUXNET site, using site-specific meteorological data. Note that this code requires the <a href="https://www.tidyverse.org/">tidyverse</a> R package.</p>
<p>We need the following two packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stineb/ingestr">ingestr</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Loading required package: dplyr</code></pre>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<pre><code>## Loading required package: purrr</code></pre>
<pre><code>## Loading required package: lubridate</code></pre>
<pre><code>## 
## Attaching package: 'lubridate'</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     date, intersect, setdiff, union</code></pre>
<pre><code>## Loading required package: tidyr</code></pre>
<pre><code>## Loading required package: raster</code></pre>
<pre><code>## Loading required package: sp</code></pre>
<pre><code>## 
## Attaching package: 'raster'</code></pre>
<pre><code>## The following object is masked from 'package:tidyr':
## 
##     extract</code></pre>
<pre><code>## The following object is masked from 'package:dplyr':
## 
##     select</code></pre>
<pre><code>## Loading required package: stringi</code></pre>
<pre><code>## Loading required package: stringr</code></pre>
<pre><code>## Loading required package: ncdf4</code></pre>
<pre><code>## Loading required package: signal</code></pre>
<pre><code>## 
## Attaching package: 'signal'</code></pre>
<pre><code>## The following object is masked from 'package:raster':
## 
##     resample</code></pre>
<pre><code>## The following object is masked from 'package:dplyr':
## 
##     filter</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, poly</code></pre>
<pre><code>## Loading required package: climate</code></pre>
<pre><code>## Loading required package: rgdal</code></pre>
<pre><code>## rgdal: version: 1.5-21, (SVN revision 1105)
## Geospatial Data Abstraction Library extensions to R successfully loaded
## Loaded GDAL runtime: GDAL 3.2.1, released 2020/12/29
## Path to GDAL shared files: /usr/local/Cellar/gdal/3.2.1/share/gdal
## GDAL binary built with GEOS: TRUE 
## Loaded PROJ runtime: Rel. 7.2.1, January 1st, 2021, [PJ_VERSION: 721]
## Path to PROJ shared files: /Users/benjaminstocker/Library/Application Support/proj:/usr/local/opt/proj/share/proj:/usr/local/Cellar/proj/7.2.1/share/proj
## PROJ CDN enabled: FALSE
## Linking to sp version:1.4-5
## To mute warnings of possible GDAL/OSR exportToProj4() degradation,
## use options("rgdal_show_exportToProj4_warnings"="none") before loading rgdal.</code></pre>
<pre><code>## Loading required package: sf</code></pre>
<pre><code>## Linking to GEOS 3.9.0, GDAL 3.2.1, PROJ 7.2.1</code></pre>
<pre><code>## Loading required package: gdalUtils</code></pre>
<pre><code>## 
## Attaching package: 'gdalUtils'</code></pre>
<pre><code>## The following object is masked from 'package:sf':
## 
##     gdal_rasterize</code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org">readr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stineb/rsofun">rsofun</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Loading required package: GenSA</code></pre>
<pre><code>## Loading required package: rlang</code></pre>
<pre><code>## 
## Attaching package: 'rlang'</code></pre>
<pre><code>## The following objects are masked from 'package:purrr':
## 
##     %@%, as_function, flatten, flatten_chr, flatten_dbl, flatten_int,
##     flatten_lgl, flatten_raw, invoke, list_along, modify, prepend,
##     splice</code></pre>
<pre><code>## 
## Attaching package: 'rsofun'</code></pre>
<pre><code>## The following object is masked from 'package:ingestr':
## 
##     init_dates_dataframe</code></pre>
<p>Get the package <a href="https://stineb.github.io/ingestr/">ingestr</a> from github by</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"stineb/ingestr"</span><span class="op">)</span></code></pre></div>
<div id="no-network-site-ensemble" class="section level1">
<h1 class="hasAnchor">
<a href="#no-network-site-ensemble" class="anchor"></a>No-network site ensemble</h1>
<p>The following is an example for an ensemble of simulations of three arbitrarily located sites.</p>
<div id="site-selection-and-meta-data" class="section level2">
<h2 class="hasAnchor">
<a href="#site-selection-and-meta-data" class="anchor"></a>Site selection and meta data</h2>
<p>In both cases, a small number of meta data variables have to be specified for each site to define site meta information. This information is also used for input, calibration, and evaluation data ingestion. Required meta information is specified as a data frame with sites along rows and the following variables (by columns):</p>
<ul>
<li>
<code>sitename</code>: any unique identifying of the site(s)</li>
<li>
<code>lat</code> for latitude (decimal degrees)</li>
<li>
<code>lon</code> for longitude (decimal degrees) - this is only used for data ingestion but not for the P-model simulation with <code>rsofun</code>.</li>
<li>
<code>elv</code> for elevation (m a.s.l.). If this is not known, <em>ingestr</em> may be used to extract information from a digital elevation model.</li>
<li>
<code>year_start</code> and <code>year_end</code> specifying years covered by the simulation. Data extraction and model simulations always cover all 365 days of each year.</li>
<li>
<code>whc</code> for the total rooting zone soil water holding capacity. This is not a temporary “fudge” solution. Set it to 170 mm if no better information is available.</li>
<li>
<code>koeppen_code</code> to group sites for evaluation by Koeppen-Geiger climate zones (may be ignored, only required for <code><a href="../reference/eval_sofun.html">eval_sofun()</a></code>).</li>
</ul>
<p>Subsequent steps are described distinguishing the two cases (network, vs. no-network site ensemble).</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">siteinfo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  sitename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"site_rsofun_demo_1"</span>, <span class="st">"site_rsofun_demo_2"</span>, <span class="st">"site_rsofun_demo_3"</span><span class="op">)</span>,
  lon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100.05</span>, <span class="fl">100.45</span>, <span class="fl">90</span><span class="op">)</span>,
  lat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">50</span>, <span class="fl">50</span><span class="op">)</span>,
  elv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">250</span>, <span class="fl">2500</span><span class="op">)</span>,
  year_start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2003</span>, <span class="fl">2001</span>, <span class="fl">2005</span><span class="op">)</span>,
  year_end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2005</span>, <span class="fl">2006</span>, <span class="fl">2007</span><span class="op">)</span>,
  whc <span class="op">=</span> <span class="fl">200</span>
<span class="op">)</span>
<span class="va">siteinfo</span></code></pre></div>
<pre><code>## # A tibble: 3 x 7
##   sitename             lon   lat   elv year_start year_end   whc
##   &lt;chr&gt;              &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;
## 1 site_rsofun_demo_1  100.    50  1000       2003     2005   200
## 2 site_rsofun_demo_2  100.    50   250       2001     2006   200
## 3 site_rsofun_demo_3   90     50  2500       2005     2007   200</code></pre>
<p>Note that sites “s1” and “s2” are located close to each other - within 0.5 degrees in longitude and on the same latitude. Climate forcing used in this example (see below) is from the WATCH-WFDEI reanalysis data, provided at 0.5 degrees. This implies that sites “s1” and “s2” are forced with the same climate (but different fAPAR data). To speed up climate data ingest, we can determine the 0.5 degrees gridcells containing at least one site and ingest respective data. These steps are explained in Section <em>Forcing by gridcell</em>. Below, we continue explaining simulations with forcing by site. This facilitates the coding (while dealing with larger amount of climate forcing data, which slows it down) …</p>
<p>Input data, used as model forcing, is collected using the <a href="https://stineb.github.io/ingestr/">ingestr</a> package. A brief description for how to use it for our present application is provided here.</p>
<div id="climate-forcing" class="section level3">
<h3 class="hasAnchor">
<a href="#climate-forcing" class="anchor"></a>Climate forcing</h3>
<p>This extracts from original WATCH-WFDEI files, provided as NetCDF (global, 0.5 degree resolution), provided as monthly files containing all days in each month. The data directory specified here (<code>dir = "~/data/watch_wfdei/"</code>) contains sub-directories with names corresponding to ingestr standard names (e.g., <code>"temp"</code>). The variables for which data is to be ingested, is given by the argument <code>getvars</code>. See the <a href="https://stineb.github.io/ingestr/">ingestr</a> website for a list of all standard variable names. For P-model simulations with rsofun, we typically use the variables indicated below. An additional variable (cloud cover fraction) is read from CRU TS data, for which a data ingest option is also available in the ingestr package.</p>
<p>For multiple sites, data is ingested as follows.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ddf_watch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  siteinfo <span class="op">=</span> <span class="va">siteinfo</span>,
  source    <span class="op">=</span> <span class="st">"watch_wfdei"</span>,
  getvars   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"temp"</span>, <span class="st">"prec"</span>, <span class="st">"ppfd"</span>, <span class="st">"vpd"</span><span class="op">)</span>,
  dir       <span class="op">=</span> <span class="st">"~/data/watch_wfdei/"</span>  <span class="co"># adjust this with your local path</span>
<span class="op">)</span>

<span class="va">ddf_cru</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  siteinfo <span class="op">=</span> <span class="va">siteinfo</span>,
  source    <span class="op">=</span> <span class="st">"cru"</span>,
  getvars   <span class="op">=</span> <span class="st">"ccov"</span>,
  dir       <span class="op">=</span> <span class="st">"~/data/cru/ts_4.01/"</span>  <span class="co"># adjust this with your local path</span>
<span class="op">)</span>

<span class="va">watch_wfdei</span>
<span class="va">ddf_cru</span></code></pre></div>
<p>The data objects <code>ddf_watch</code> and <code>ddf_cru</code> are organised as a nested table with rows for sites and time series nested inside the column <code>data</code>. See <a href="https://tidyr.tidyverse.org/reference/nest.html">here</a> for how to handle nested data frames.</p>
<p>Note that climate data extraction for a large number of sites takes a long time to complete and (irrespective of the number of sites for which data is extracted) requires original data files (WATCH-WFDEI and CRU TS) to be stored and accessible locally.</p>
<p>For internals of <a href="https://computationales.ethz.ch/">CES, ETH Zurich</a>: It is advisable to run this on the Euler HPC. For this, create an R script containing above code plus library load and file saving statements (e.g. as <code>rscript_get_watch_cru.R</code>), and send it as a job to the cluster by the following command, entered in the terminal:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bsub</span> -u username -J get_watch_cru -R <span class="st">"rusage[mem=25000]"</span> <span class="st">"Rscript --vanilla rscript_get_watch_cru.R"</span></span></code></pre></div>
<p>Now, Combine the two meteo data frames into one, containing <code>ccov</code> (cloud cover) from CRU and all other variables from WATCH-WFDEI</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ddf_meteo</span> <span class="op">&lt;-</span> <span class="va">ddf_watch</span> <span class="op">%&gt;%</span> 
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">ddf_cru</span> <span class="op">%&gt;%</span> 
      <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sitename"</span>, <span class="st">"date"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">sitename</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="fapar-forcing" class="section level3">
<h3 class="hasAnchor">
<a href="#fapar-forcing" class="anchor"></a>fAPAR forcing</h3>
<p>fAPAR data is prescribed in the P-model setup. MODIS data can be ingested either using the <a href="https://docs.ropensci.org/MODISTools/">MODISTools</a> R package from MODIS LP DAAC (see a complete description <a href="https://stineb.github.io/ingestr/articles/example.html#modis-lp-daac-1">here</a>), or from MODIS data hosted on Google Earth Engine using the <a href="https://github.com/bluegreen-labs/gee_subset">gee_subset</a> R package. The former provides full functionality for extracting data for larger areas, including multiple pixels. The latter works much faster but allows only data ingest for single pixels. Choose the appropriate option for your application. Both are available through the <a href="https://stineb.github.io/ingestr/">ingestr</a> R package and an example is provided below.</p>
<p>Note that the P-model provides predictions also for leaf-level quantities (acclimated Vcmax and Jmax). These are independent of fAPAR. Hence, this step can be skipped and the fAPAR forcing set to 1.0 for all dates. To get an object in the required standard format, use <code>ingest</code> once more, this time with <code>source = "fapar_unity"</code>:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ddf_fapar_unity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  siteinfo  <span class="op">=</span> <span class="va">siteinfo</span>,
  source    <span class="op">=</span> <span class="st">"fapar_unity"</span>
  <span class="op">)</span>

<span class="va">ddf_fapar_unity</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 2
##   date       fapar
##   &lt;date&gt;     &lt;dbl&gt;
## 1 2003-01-01     1
## 2 2003-01-02     1
## 3 2003-01-03     1
## 4 2003-01-04     1
## 5 2003-01-05     1
## 6 2003-01-06     1</code></pre>
<div id="modistools" class="section level4">
<h4 class="hasAnchor">
<a href="#modistools" class="anchor"></a>MODISTools</h4>
<p>The following example is for downloading MODIS collection 6, MCD15A3H, band <code>Fpar_500m</code> data.</p>
<p>For <a href="https://computationales.ethz.ch/">CES</a> internals: A large number of MODIS subsets are available for network-sites on Euler (<code>~/data/modis_subsets/</code>).</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">settings_modis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/get_settings_modis.html">get_settings_modis</a></span><span class="op">(</span>
  bundle            <span class="op">=</span> <span class="st">"modis_fpar"</span>,
  data_path         <span class="op">=</span> <span class="st">"~/data/modis_subsets/"</span>,
  method_interpol   <span class="op">=</span> <span class="st">"loess"</span>,
  keep              <span class="op">=</span> <span class="cn">TRUE</span>,
  overwrite_raw     <span class="op">=</span> <span class="cn">FALSE</span>,
  overwrite_interpol<span class="op">=</span> <span class="cn">TRUE</span>,
  n_focal           <span class="op">=</span> <span class="fl">0</span>
  <span class="op">)</span>

<span class="va">df_modis_fpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  <span class="va">siteinfo</span>, 
  source <span class="op">=</span> <span class="st">"modis"</span>,
  settings <span class="op">=</span> <span class="va">settings_modis</span>, 
  parallel <span class="op">=</span> <span class="cn">FALSE</span>,
  ncores <span class="op">=</span> <span class="fl">2</span>  <span class="co"># allows parallelised download</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   .default = col_double(),
##   band = col_character(),
##   units = col_character(),
##   site = col_character(),
##   product = col_character(),
##   start = col_date(format = ""),
##   end = col_date(format = ""),
##   complete = col_logical(),
##   modis_date = col_character(),
##   calendar_date = col_date(format = ""),
##   tile = col_character()
## )
## ℹ Use `spec()` for the full column specifications.</code></pre>
<pre><code>## Warning: 6875 parsing failures.
##  row   col expected        actual                                                                    file
## 6876 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_1.csv'
## 6877 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_1.csv'
## 6878 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_1.csv'
## 6879 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_1.csv'
## 6880 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_1.csv'
## .... ..... ........ ............. .......................................................................
## See problems(...) for more details.</code></pre>
<pre><code>## Averaging across number of pixels:  25</code></pre>
<pre><code>## loess...</code></pre>
<pre><code>## spline...</code></pre>
<pre><code>## linear ...</code></pre>
<pre><code>## sgfilter ...</code></pre>
<pre><code>## Warning: Filling values with last available data point at head</code></pre>
<pre><code>## Warning: Filling values with last available data point at tail.</code></pre>
<pre><code>## Warning: The `path` argument of `write_csv()` is deprecated as of readr 1.4.0.
## Please use the `file` argument instead.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_warnings()` to see where this warning was generated.</code></pre>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   .default = col_double(),
##   band = col_character(),
##   units = col_character(),
##   site = col_character(),
##   product = col_character(),
##   start = col_date(format = ""),
##   end = col_date(format = ""),
##   complete = col_logical(),
##   modis_date = col_character(),
##   calendar_date = col_date(format = ""),
##   tile = col_character()
## )
## ℹ Use `spec()` for the full column specifications.</code></pre>
<pre><code>## Warning: 10300 parsing failures.
##   row   col expected        actual                                                                    file
## 10301 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_2.csv'
## 10302 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_2.csv'
## 10303 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_2.csv'
## 10304 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_2.csv'
## 10305 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_2.csv'
## ..... ..... ........ ............. .......................................................................
## See problems(...) for more details.</code></pre>
<pre><code>## Averaging across number of pixels:  25</code></pre>
<pre><code>## loess...</code></pre>
<pre><code>## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : k-d tree limited by memory. ncmax= 277</code></pre>
<pre><code>## spline...</code></pre>
<pre><code>## linear ...</code></pre>
<pre><code>## sgfilter ...</code></pre>
<pre><code>## Warning: Filling values with last available data point at head</code></pre>
<pre><code>## Warning: Filling values with last available data point at tail.</code></pre>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   .default = col_double(),
##   band = col_character(),
##   units = col_character(),
##   site = col_character(),
##   product = col_character(),
##   start = col_date(format = ""),
##   end = col_date(format = ""),
##   complete = col_logical(),
##   modis_date = col_character(),
##   calendar_date = col_date(format = ""),
##   tile = col_character()
## )
## ℹ Use `spec()` for the full column specifications.</code></pre>
<pre><code>## Warning: 6900 parsing failures.
##  row   col expected        actual                                                                    file
## 6901 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_3.csv'
## 6902 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_3.csv'
## 6903 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_3.csv'
## 6904 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_3.csv'
## 6905 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_site_rsofun_demo_3.csv'
## .... ..... ........ ............. .......................................................................
## See problems(...) for more details.</code></pre>
<pre><code>## Averaging across number of pixels:  25</code></pre>
<pre><code>## loess...</code></pre>
<pre><code>## spline...</code></pre>
<pre><code>## linear ...</code></pre>
<pre><code>## sgfilter ...</code></pre>
<pre><code>## Warning: Filling values with last available data point at head

## Warning: Filling values with last available data point at tail.</code></pre>
<p>To make this output consistent for use below, let’s nest it and rename the desired column to <code>fapar</code>.</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_modis_fpar</span> <span class="op">&lt;-</span> <span class="va">df_modis_fpar</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="va">.</span>, fapar <span class="op">=</span> <span class="va">modisvar_filled</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="gee_subsets" class="section level4">
<h4 class="hasAnchor">
<a href="#gee_subsets" class="anchor"></a>gee_subsets</h4>
<p>This requires authentication with Google Earth Engine. See <a href="https://stineb.github.io/ingestr/articles/example.html#google-earth-engine">here</a> for a guide of required steps. Once this is done, do the following.</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">settings_gee</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/get_settings_gee.html">get_settings_gee</a></span><span class="op">(</span>
  bundle            <span class="op">=</span> <span class="st">"modis_fpar"</span>,
  python_path       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.html">system</a></span><span class="op">(</span><span class="st">"which python"</span>, intern <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  gee_path          <span class="op">=</span> <span class="st">"~/google_earth_engine_subsets/gee_subset/"</span>, 
  data_path         <span class="op">=</span> <span class="st">"~/data/gee_subsets/"</span>,    <span class="co"># adjust this with your local path</span>
  method_interpol   <span class="op">=</span> <span class="st">"linear"</span>,
  keep              <span class="op">=</span> <span class="cn">TRUE</span>,
  overwrite_raw     <span class="op">=</span> <span class="cn">FALSE</span>,
  overwrite_interpol<span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span>

<span class="va">df_gee_modis_fpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  siteinfo<span class="op">=</span> <span class="va">siteinfo</span>,
  source  <span class="op">=</span> <span class="st">"gee"</span>,
  settings<span class="op">=</span> <span class="va">settings_gee</span>,
  verbose <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span></code></pre></div>
</div>
</div>
<div id="co2-forcing" class="section level3">
<h3 class="hasAnchor">
<a href="#co2-forcing" class="anchor"></a>CO2 forcing</h3>
<p>Ingesting CO2 data is particularly simple. We can safely assume it’s well mixed in the atmosphere (independent of site location), and we can use a annual mean value for all days in respective years.</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_co2</span> <span class="op">&lt;-</span> <span class="fu">ingestr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  <span class="va">siteinfo</span>,
  source  <span class="op">=</span> <span class="st">"co2_mlo"</span>,
  verbose <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## [1] "ftp://aftp.cmdl.noaa.gov/products/trends/co2/co2_mm_mlo.txt"</code></pre>
<pre><code>## /var/folders/50/6vwrc_t54pv4n9vty5dgt4fw0000gn/T//RtmpmXFCCa/file113d32fe5e3f9</code></pre>
</div>
</div>
<div id="simulation-settings" class="section level2">
<h2 class="hasAnchor">
<a href="#simulation-settings" class="anchor"></a>Simulation settings</h2>
<p>This and all subsequent sections are not specific to whether you’re doing a network or no-network site ensemble.</p>
<p>Specify additional simulation parameters that are identical for all site-scale simulations in multi-site runs,</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">params_siml</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  spinup             <span class="op">=</span> <span class="cn">TRUE</span>,      <span class="co"># to bring soil moisture to steady state</span>
  spinupyears        <span class="op">=</span> <span class="fl">10</span>,        <span class="co"># number of spinup years. 10 is enough for soil moisture.</span>
  recycle            <span class="op">=</span> <span class="fl">1</span>,         <span class="co"># number of years recycled during spinup </span>
  soilmstress        <span class="op">=</span> <span class="cn">FALSE</span>,     <span class="co"># boolean for whether soil moisture stress function is included</span>
  tempstress         <span class="op">=</span> <span class="cn">FALSE</span>,     <span class="co"># boolean for whether temperature stress function is included</span>
  calc_aet_fapar_vpd <span class="op">=</span> <span class="cn">FALSE</span>,     <span class="co"># set to FALSE - should be dropped again</span>
  in_ppfd            <span class="op">=</span> <span class="cn">TRUE</span>,      <span class="co"># if available from forcing files, set to TRUE</span>
  in_netrad          <span class="op">=</span> <span class="cn">FALSE</span>,     <span class="co"># if available from forcing files, set to TRUE</span>
  outdt              <span class="op">=</span> <span class="fl">1</span>,
  ltre               <span class="op">=</span> <span class="cn">FALSE</span>,
  ltne               <span class="op">=</span> <span class="cn">FALSE</span>,
  ltrd               <span class="op">=</span> <span class="cn">FALSE</span>,
  ltnd               <span class="op">=</span> <span class="cn">FALSE</span>,
  lgr3               <span class="op">=</span> <span class="cn">TRUE</span>,
  lgn3               <span class="op">=</span> <span class="cn">FALSE</span>,
  lgr4               <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span></code></pre></div>
<!-- Run `prepare_setup_sofun()` to define the simulation settings that contain all the information specified by the two steps above (meta info, and simulation parameters), global simulation parameters are wrapped inside an additional column `params_siml`, added to the site meta info dataframe. -->
<!-- ```{r} -->
<!-- siteinfo <- prepare_setup_sofun(siteinfo = siteinfo, params_siml = params_siml) -->
<!-- ``` -->
</div>
<div id="define-model-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#define-model-parameters" class="anchor"></a>Define model parameters</h2>
<p>Specify model parameters based on prior model calibration. See <code>benchmarking/tag_v*/benchmark_gpp_FLUXNET2015_ensemble.html</code> for latest calibrations.</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">params_modl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  kphio           <span class="op">=</span> <span class="fl">0.09423773</span>,
  soilm_par_a     <span class="op">=</span> <span class="fl">0.33349283</span>,
  soilm_par_b     <span class="op">=</span> <span class="fl">1.45602286</span>
  <span class="op">)</span></code></pre></div>
</div>
<div id="define-soil-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#define-soil-parameters" class="anchor"></a>Define soil parameters</h2>
<p>For now, this is implemented as an illustration. Should be made site-specific. Values entered here take no effect.</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_soiltexture</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  top    <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>layer <span class="op">=</span> <span class="st">"top"</span>,    fsand <span class="op">=</span> <span class="fl">0.4</span>, fclay <span class="op">=</span> <span class="fl">0.3</span>, forg <span class="op">=</span> <span class="fl">0.1</span>, fgravel <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,
  bottom <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>layer <span class="op">=</span> <span class="st">"bottom"</span>, fsand <span class="op">=</span> <span class="fl">0.4</span>, fclay <span class="op">=</span> <span class="fl">0.3</span>, forg <span class="op">=</span> <span class="fl">0.1</span>, fgravel <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="collect-all-drivers" class="section level2">
<h2 class="hasAnchor">
<a href="#collect-all-drivers" class="anchor"></a>Collect all drivers</h2>
<p>Finally, we can collect forcing data, simulation parameters, and site meta info into a single object that will be used to drive rsofun. All of the above steps can be customized. The function <code><a href="../reference/collect_drivers_sofun.html">collect_drivers_sofun()</a></code> can in general be used to process forcing data into the format required to run SOFUN. The arguments must have the following form:</p>
<ul>
<li>
<code>siteinfo</code>: A data frame (tibble) with columns <code>sitename</code>, <code>lon</code>, <code>lat</code>, <code>elv</code> (elevation), <code>year_start</code>, <code>year_end</code>, <code>whc</code> (water holding capacity used for simulating the soil water balance). We have created this above.</li>
</ul>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">siteinfo</span></code></pre></div>
<pre><code>## # A tibble: 3 x 7
##   sitename             lon   lat   elv year_start year_end   whc
##   &lt;chr&gt;              &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;
## 1 site_rsofun_demo_1  100.    50  1000       2003     2005   200
## 2 site_rsofun_demo_2  100.    50   250       2001     2006   200
## 3 site_rsofun_demo_3   90     50  2500       2005     2007   200</code></pre>
<ul>
<li>
<code>meteo</code>: A nested data frame with columns <code>sitename</code> and <code>data</code>. The latter contains the nested meteorological forcing data frames, with columns <code>date</code>, <code>temp</code>, <code>prec</code>, <code>vpd</code>, <code>ppfd</code>, <code>patm</code>, and <code>ccov</code>. Like this:</li>
</ul>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## nested data frame:</span>
<span class="va">ddf_meteo</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
## # Groups:   sitename [3]
##   sitename           data                 
##   &lt;chr&gt;              &lt;list&gt;               
## 1 site_rsofun_demo_2 &lt;tibble [2,190 × 12]&gt;
## 2 site_rsofun_demo_1 &lt;tibble [1,095 × 12]&gt;
## 3 site_rsofun_demo_3 &lt;tibble [1,095 × 12]&gt;</code></pre>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## inside .$data:</span>
<span class="va">ddf_meteo</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ccov_int</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 2,190 x 11
##    myvar date          ppfd  rain    snow    prec    qair  temp   patm   vpd
##    &lt;dbl&gt; &lt;date&gt;       &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
##  1  49.5 2001-01-01 1.01e-4     0 0.      0.      2.02e-4 -31.5 82275. 16.9 
##  2  61.2 2001-01-02 1.25e-4     0 0.      0.      1.60e-4 -33.8 82626. 13.5 
##  3  42.3 2001-01-03 8.63e-5     0 0.      0.      2.58e-4 -29.9 82206. 16.6 
##  4  48.2 2001-01-04 9.84e-5     0 3.30e-6 3.30e-6 4.88e-4 -25.6 82013. 11.6 
##  5  25.5 2001-01-05 5.20e-5     0 3.33e-6 3.33e-6 6.38e-4 -23.1 81619. 11.0 
##  6  31.8 2001-01-06 6.49e-5     0 5.12e-7 5.12e-7 2.43e-4 -32.1 82037.  9.09
##  7  66.7 2001-01-07 1.36e-4     0 0.      0.      9.38e-5 -38.8 82810.  8.40
##  8  62.0 2001-01-08 1.26e-4     0 0.      0.      1.37e-4 -35.0 82545. 12.7 
##  9  42.3 2001-01-09 8.64e-5     0 0.      0.      2.98e-4 -27.9 81940. 21.9 
## 10  59.9 2001-01-10 1.22e-4     0 0.      0.      3.55e-4 -27.7 81973. 15.8 
## # … with 2,180 more rows, and 1 more variable: ccov &lt;dbl&gt;</code></pre>
<ul>
<li>
<code>fapar</code>: A nested data frame with columns <code>sitename</code> and <code>data</code>. The latter contains the nested meteorological forcing data frames, with columns <code>date</code>, and <code>fapar</code>. Like this:</li>
</ul>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## nested data frame:</span>
<span class="va">df_modis_fpar</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
## # Groups:   sitename [3]
##   sitename           data                
##   &lt;chr&gt;              &lt;list&gt;              
## 1 site_rsofun_demo_1 &lt;tibble [1,096 × 9]&gt;
## 2 site_rsofun_demo_2 &lt;tibble [2,191 × 9]&gt;
## 3 site_rsofun_demo_3 &lt;tibble [1,095 × 9]&gt;</code></pre>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## inside .$data:</span>
<span class="va">df_modis_fpar</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">fapar</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 1,096 x 2
##    date       fapar
##    &lt;date&gt;     &lt;dbl&gt;
##  1 2003-01-01 0.111
##  2 2003-01-02 0.111
##  3 2003-01-03 0.111
##  4 2003-01-04 0.111
##  5 2003-01-05 0.111
##  6 2003-01-06 0.111
##  7 2003-01-07 0.111
##  8 2003-01-08 0.111
##  9 2003-01-09 0.111
## 10 2003-01-10 0.111
## # … with 1,086 more rows</code></pre>
<ul>
<li>
<code>co2</code> : A nested data frame with columns <code>sitename</code> and <code>data</code>. The latter contains the nested meteorological forcing data frames, with columns <code>date</code>, and <code>co2</code>. Like this:</li>
</ul>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## nested data frame:</span>
<span class="va">df_co2</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
## # Groups:   sitename [3]
##   sitename           data                
##   &lt;chr&gt;              &lt;list&gt;              
## 1 site_rsofun_demo_1 &lt;tibble [1,096 × 2]&gt;
## 2 site_rsofun_demo_2 &lt;tibble [2,191 × 2]&gt;
## 3 site_rsofun_demo_3 &lt;tibble [1,095 × 2]&gt;</code></pre>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## inside .$data:</span>
<span class="va">df_co2</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">co2</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 1,096 x 2
##    date         co2
##    &lt;date&gt;     &lt;dbl&gt;
##  1 2003-01-01  376.
##  2 2003-01-02  376.
##  3 2003-01-03  376.
##  4 2003-01-04  376.
##  5 2003-01-05  376.
##  6 2003-01-06  376.
##  7 2003-01-07  376.
##  8 2003-01-08  376.
##  9 2003-01-09  376.
## 10 2003-01-10  376.
## # … with 1,086 more rows</code></pre>
<ul>
<li>
<code>df_soiltexture</code>: See above (‘Define soil parameters’)</li>
</ul>
<p>See <a href="https://tidyr.tidyverse.org/reference/nest.html">here</a> for how to handle nested dataframes.</p>
<p>Finally, all input data can be collected by:</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_drivers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/collect_drivers_sofun.html">collect_drivers_sofun</a></span><span class="op">(</span> 
  siteinfo       <span class="op">=</span> <span class="va">siteinfo</span>,
  params_siml    <span class="op">=</span> <span class="va">params_siml</span>,
  meteo          <span class="op">=</span> <span class="va">ddf_meteo</span>, 
  fapar          <span class="op">=</span> <span class="va">df_modis_fpar</span>,
  co2            <span class="op">=</span> <span class="va">df_co2</span>,
  df_soiltexture <span class="op">=</span> <span class="va">df_soiltexture</span>
  <span class="op">)</span>
<span class="va">df_drivers</span></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   sitename        forcing           params_siml    siteinfo      df_soiltexture 
##   &lt;chr&gt;           &lt;list&gt;            &lt;list&gt;         &lt;list&gt;        &lt;list&gt;         
## 1 site_rsofun_de… &lt;tibble [1,095 ×… &lt;tibble [1 × … &lt;tibble [1 ×… &lt;tibble [2 × 5…
## 2 site_rsofun_de… &lt;tibble [2,190 ×… &lt;tibble [1 × … &lt;tibble [1 ×… &lt;tibble [2 × 5…
## 3 site_rsofun_de… &lt;tibble [1,095 ×… &lt;tibble [1 × … &lt;tibble [1 ×… &lt;tibble [2 × 5…</code></pre>
</div>
<div id="run-model" class="section level2">
<h2 class="hasAnchor">
<a href="#run-model" class="anchor"></a>Run model</h2>
<p>Finally, run the model for a set of sites.</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runread_pmodel_f.html">runread_pmodel_f</a></span><span class="op">(</span>
     <span class="va">df_drivers</span>,
     params_modl <span class="op">=</span> <span class="va">params_modl</span>, 
     makecheck <span class="op">=</span> <span class="cn">TRUE</span>,
     parallel <span class="op">=</span> <span class="cn">FALSE</span>
     <span class="op">)</span></code></pre></div>
<pre><code>## Warning: Problem with `mutate()` input `data`.
## ℹ the condition has length &gt; 1 and only the first element will be used
## ℹ Input `data` is `purrr::pmap(...)`.

## Warning: Problem with `mutate()` input `data`.
## ℹ the condition has length &gt; 1 and only the first element will be used
## ℹ Input `data` is `purrr::pmap(...)`.

## Warning: Problem with `mutate()` input `data`.
## ℹ the condition has length &gt; 1 and only the first element will be used
## ℹ Input `data` is `purrr::pmap(...)`.</code></pre>
</div>
</div>
<div id="network-site-ensemble" class="section level1">
<h1 class="hasAnchor">
<a href="#network-site-ensemble" class="anchor"></a>Network site ensemble</h1>
<p>In this case, sites are not identified by their longitude and latitude, but by site names, that follow a standard, given by the site network. Preparing forcing data, calibrating, and evaluating rsofun is made particularly easy for FLUXNET simulations. Site meta information for FLUXNET is provided through the ingestr package:</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">siteinfo_fluxnet2015</span></code></pre></div>
<pre><code>## # A tibble: 166 x 12
##    sitename   lon   lat   elv year_start year_end classid c4      whc
##    &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;    &lt;chr&gt;   &lt;lgl&gt; &lt;dbl&gt;
##  1 AR-SLu   -66.5 -33.5   499 2009       2011     MF      FALSE  268.
##  2 AR-Vir   -56.2 -28.2    97 2009       2012     ENF     FALSE  302.
##  3 AT-Neu    11.3  47.1   970 2002       2012     GRA     FALSE  270.
##  4 AU-Ade   131.  -13.1    81 2007       2009     WSA     FALSE  269.
##  5 AU-ASM   133.  -22.3   606 2010       2013     ENF     FALSE  215.
##  6 AU-Cpr   141.  -34.0    57 2010       2014     SAV     FALSE  217.
##  7 AU-Cum   151.  -33.6    28 2012       2014     EBF     FALSE  311.
##  8 AU-DaP   131.  -14.1   102 2007       2013     GRA     FALSE  295.
##  9 AU-DaS   131.  -14.2    98 2008       2014     SAV     FALSE  249.
## 10 AU-Dry   132.  -15.3   172 2008       2014     SAV     FALSE  239.
## # … with 156 more rows, and 3 more variables: koeppen_code &lt;chr&gt;,
## #   igbp_land_use &lt;chr&gt;, plant_functional_type &lt;chr&gt;</code></pre>
<p>Note that <code>year_start</code> and <code>year_end</code> are for data available through the FLUXNET2015 distribution, and the ensemble of sites corresponds to those for which data is made available open access (Tier 1).</p>
<p>For the demo below, let’s use just the first three sites.</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">siteinfo</span> <span class="op">&lt;-</span> <span class="va">siteinfo_fluxnet2015</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></code></pre></div>
<div id="climate-forcing-1" class="section level3">
<h3 class="hasAnchor">
<a href="#climate-forcing-1" class="anchor"></a>Climate forcing</h3>
<p>The following ingests meteorological data from the FLUXNET 2015 files for variables daytime temperature, precipitation, daytime VPD, shortwave incoming radiation, net radiation, and atmospheric pressure. Arguments that are specific for this data source are provided in the <code>settings</code> list. Unfortunately, FLUXNET 2015 doesn’t provide daytime VPD. But we can derive it using the ingestr R package as described <a href="https://stineb.github.io/ingestr/articles/calc_daytime_vpd.html">here</a> and done below. This writes files with daytime VPD into the directory specified by <code>settings_fluxnet$dir_hh</code>. The data object <code>ddf_fluxnet</code> is organised as a nested table with rows for sites and time series nested inside the column <code>data</code>. See <a href="https://tidyr.tidyverse.org/reference/nest.html">here</a> for how to handle nested dataframes.</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stineb/ingestr">ingestr</a></span><span class="op">)</span>
<span class="va">ddf_fluxnet</span> <span class="op">&lt;-</span> <span class="fu">ingestr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  siteinfo  <span class="op">=</span> <span class="va">siteinfo</span>,
  source    <span class="op">=</span> <span class="st">"fluxnet"</span>,
  getvars   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>temp <span class="op">=</span> <span class="st">"TA_F_DAY"</span>, prec <span class="op">=</span> <span class="st">"P_F"</span>, vpd  <span class="op">=</span> <span class="st">"VPD_F_DAY"</span>, ppfd <span class="op">=</span> <span class="st">"SW_IN_F"</span>, patm <span class="op">=</span> <span class="st">"PA_F"</span><span class="op">)</span>,
  dir       <span class="op">=</span> <span class="st">"~/data/FLUXNET-2015_Tier1/20191024/DD/"</span>,
  settings  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dir_hh <span class="op">=</span> <span class="st">"~/data/FLUXNET-2015_Tier1/20191024/HH/"</span>, getswc <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
  timescale <span class="op">=</span> <span class="st">"d"</span>
  <span class="op">)</span></code></pre></div>
<p>Some meteo data is not available from FLUXNET. Extract it from CRU global climate files instead.</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ddf_cru</span> <span class="op">&lt;-</span> <span class="fu">ingestr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  siteinfo  <span class="op">=</span> <span class="va">siteinfo</span>,
  source    <span class="op">=</span> <span class="st">"cru"</span>,
  getvars   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"ccov"</span><span class="op">)</span>,
  dir       <span class="op">=</span> <span class="st">"~/data/cru/ts_4.01/"</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## Warning in .varName(nc, varname, warn = warn): varname used is: cld
## If that is not correct, you can set it to one of: cld, stn</code></pre>
<pre><code>## Warning: Problem with `mutate()` input `data`.
## ℹ The `x` argument of `as_tibble.matrix()` must have unique column names if `.name_repair` is omitted as of tibble 2.0.0.
## Using compatibility `.name_repair`.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_warnings()` to see where this warning was generated.
## ℹ Input `data` is `purrr::map(data, ~as_tibble(.))`.</code></pre>
<p>Combine the two meteo data frames into one, containing <code>ccov</code> (cloud cover) from CRU and all other variables from FLUXNET.</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ddf_meteo</span> <span class="op">&lt;-</span> <span class="va">ddf_fluxnet</span> <span class="op">%&gt;%</span> 
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span>
    <span class="va">ddf_cru</span> <span class="op">%&gt;%</span> 
      <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,
    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sitename"</span>, <span class="st">"date"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">sitename</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="fapar-forcing-1" class="section level3">
<h3 class="hasAnchor">
<a href="#fapar-forcing-1" class="anchor"></a>fAPAR forcing</h3>
<p>To get the data given the longitude and latitude of sites, follow the same instructions as above for the no-network case.</p>
<p>The following example is for downloading MODIS collection 6, MCD15A3H, band <code>Fpar_500m</code> data.</p>
<p>For <a href="https://computationales.ethz.ch/">CES</a> internals: A large number of MODIS subsets are available for network-sites on Euler (<code>~/data/modis_subsets/</code>).</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">settings_modis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/get_settings_modis.html">get_settings_modis</a></span><span class="op">(</span>
  bundle            <span class="op">=</span> <span class="st">"modis_fpar"</span>,
  data_path         <span class="op">=</span> <span class="st">"~/data/modis_subsets/"</span>,
  method_interpol   <span class="op">=</span> <span class="st">"loess"</span>,
  keep              <span class="op">=</span> <span class="cn">TRUE</span>,
  overwrite_raw     <span class="op">=</span> <span class="cn">FALSE</span>,
  overwrite_interpol<span class="op">=</span> <span class="cn">TRUE</span>,
  n_focal           <span class="op">=</span> <span class="fl">0</span>
  <span class="op">)</span>

<span class="va">df_modis_fpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  <span class="va">siteinfo</span>, 
  source <span class="op">=</span> <span class="st">"modis"</span>,
  settings <span class="op">=</span> <span class="va">settings_modis</span>, 
  parallel <span class="op">=</span> <span class="cn">FALSE</span>,
  ncores <span class="op">=</span> <span class="fl">2</span>  <span class="co"># allows parallelised download</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   .default = col_double(),
##   band = col_character(),
##   units = col_character(),
##   site = col_character(),
##   product = col_character(),
##   start = col_date(format = ""),
##   end = col_date(format = ""),
##   complete = col_logical(),
##   modis_date = col_character(),
##   calendar_date = col_date(format = ""),
##   tile = col_character()
## )
## ℹ Use `spec()` for the full column specifications.</code></pre>
<pre><code>## Warning: 6900 parsing failures.
##  row   col expected        actual                                                        file
## 6901 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AR-SLu.csv'
## 6902 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AR-SLu.csv'
## 6903 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AR-SLu.csv'
## 6904 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AR-SLu.csv'
## 6905 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AR-SLu.csv'
## .... ..... ........ ............. ...........................................................
## See problems(...) for more details.</code></pre>
<pre><code>## Averaging across number of pixels:  25</code></pre>
<pre><code>## loess...</code></pre>
<pre><code>## spline...</code></pre>
<pre><code>## linear ...</code></pre>
<pre><code>## sgfilter ...</code></pre>
<pre><code>## Warning in max(idxs): no non-missing arguments to max; returning -Inf</code></pre>
<pre><code>## Warning in min(idxs): no non-missing arguments to min; returning Inf</code></pre>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   .default = col_double(),
##   band = col_character(),
##   units = col_character(),
##   site = col_character(),
##   product = col_character(),
##   start = col_date(format = ""),
##   end = col_date(format = ""),
##   complete = col_logical(),
##   modis_date = col_character(),
##   calendar_date = col_date(format = ""),
##   tile = col_character()
## )
## ℹ Use `spec()` for the full column specifications.</code></pre>
<pre><code>## Warning: 9200 parsing failures.
##  row   col expected        actual                                                        file
## 9201 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AR-Vir.csv'
## 9202 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AR-Vir.csv'
## 9203 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AR-Vir.csv'
## 9204 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AR-Vir.csv'
## 9205 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AR-Vir.csv'
## .... ..... ........ ............. ...........................................................
## See problems(...) for more details.</code></pre>
<pre><code>## Averaging across number of pixels:  25</code></pre>
<pre><code>## loess...</code></pre>
<pre><code>## spline...</code></pre>
<pre><code>## linear ...</code></pre>
<pre><code>## sgfilter ...</code></pre>
<pre><code>## Warning in max(idxs): no non-missing arguments to max; returning -Inf</code></pre>
<pre><code>## Warning: Filling values with last available data point at tail.</code></pre>
<pre><code>## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   .default = col_double(),
##   band = col_character(),
##   units = col_character(),
##   site = col_character(),
##   product = col_character(),
##   start = col_date(format = ""),
##   end = col_date(format = ""),
##   complete = col_logical(),
##   modis_date = col_character(),
##   calendar_date = col_date(format = ""),
##   tile = col_character()
## )
## ℹ Use `spec()` for the full column specifications.</code></pre>
<pre><code>## Warning: 24100 parsing failures.
##   row   col expected        actual                                                        file
## 24101 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AT-Neu.csv'
## 24102 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AT-Neu.csv'
## 24103 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AT-Neu.csv'
## 24104 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AT-Neu.csv'
## 24105 scale a double Not Available '~/data/modis_subsets//raw//MODIS_FPAR_MCD15A3H_AT-Neu.csv'
## ..... ..... ........ ............. ...........................................................
## See problems(...) for more details.</code></pre>
<pre><code>## Averaging across number of pixels:  25</code></pre>
<pre><code>## loess...</code></pre>
<pre><code>## spline...</code></pre>
<pre><code>## linear ...</code></pre>
<pre><code>## sgfilter ...</code></pre>
<pre><code>## Warning: Filling values with last available data point at head

## Warning: Filling values with last available data point at tail.</code></pre>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_modis_fpar</span> <span class="op">&lt;-</span> <span class="va">df_modis_fpar</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="va">.</span>, fapar <span class="op">=</span> <span class="va">modisvar_filled</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="co2-forcing-1" class="section level3">
<h3 class="hasAnchor">
<a href="#co2-forcing-1" class="anchor"></a>CO2 forcing</h3>
<p>Ingesting CO2 data is particularly simple. We can safely assume it’s well mixed in the atmosphere (independent of site location), and we can use a annual mean value for all days in respective years.</p>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_co2</span> <span class="op">&lt;-</span> <span class="fu">ingestr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ingestr/man/ingest.html">ingest</a></span><span class="op">(</span>
  <span class="va">siteinfo</span>,
  source  <span class="op">=</span> <span class="st">"co2_mlo"</span>,
  verbose <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## [1] "ftp://aftp.cmdl.noaa.gov/products/trends/co2/co2_mm_mlo.txt"</code></pre>
<pre><code>## /var/folders/50/6vwrc_t54pv4n9vty5dgt4fw0000gn/T//RtmpmXFCCa/file113d364377bcc</code></pre>
</div>
<div id="simulation-settings-1" class="section level2">
<h2 class="hasAnchor">
<a href="#simulation-settings-1" class="anchor"></a>Simulation settings</h2>
<p>This and all subsequent sections are not specific to whether you’re doing a network or no-network site ensemble.</p>
<p>Specify additional simulation parameters that are identical for all site-scale simulations in multi-site runs,</p>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">params_siml</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  spinup             <span class="op">=</span> <span class="cn">TRUE</span>,      <span class="co"># to bring soil moisture to steady state</span>
  spinupyears        <span class="op">=</span> <span class="fl">10</span>,        <span class="co"># number of spinup years. 10 is enough for soil moisture.</span>
  recycle            <span class="op">=</span> <span class="fl">1</span>,         <span class="co"># number of years recycled during spinup </span>
  soilmstress        <span class="op">=</span> <span class="cn">FALSE</span>,     <span class="co"># boolean for whether soil moisture stress function is included</span>
  tempstress         <span class="op">=</span> <span class="cn">FALSE</span>,     <span class="co"># boolean for whether temperature stress function is included</span>
  calc_aet_fapar_vpd <span class="op">=</span> <span class="cn">FALSE</span>,     <span class="co"># set to FALSE - should be dropped again</span>
  in_ppfd            <span class="op">=</span> <span class="cn">TRUE</span>,      <span class="co"># if available from forcing files, set to TRUE</span>
  in_netrad          <span class="op">=</span> <span class="cn">FALSE</span>,     <span class="co"># if available from forcing files, set to TRUE</span>
  outdt              <span class="op">=</span> <span class="fl">1</span>,
  ltre               <span class="op">=</span> <span class="cn">FALSE</span>,
  ltne               <span class="op">=</span> <span class="cn">FALSE</span>,
  ltrd               <span class="op">=</span> <span class="cn">FALSE</span>,
  ltnd               <span class="op">=</span> <span class="cn">FALSE</span>,
  lgr3               <span class="op">=</span> <span class="cn">TRUE</span>,
  lgn3               <span class="op">=</span> <span class="cn">FALSE</span>,
  lgr4               <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span></code></pre></div>
<!-- Run `prepare_setup_sofun()` to define the simulation settings that contain all the information specified by the two steps above (meta info, and simulation parameters), global simulation parameters are wrapped inside an additional column `params_siml`, added to the site meta info dataframe. -->
<!-- ```{r} -->
<!-- siteinfo <- prepare_setup_sofun(siteinfo = siteinfo, params_siml = params_siml) -->
<!-- ``` -->
</div>
<div id="define-model-parameters-1" class="section level2">
<h2 class="hasAnchor">
<a href="#define-model-parameters-1" class="anchor"></a>Define model parameters</h2>
<p>Specify model parameters based on prior model calibration. See <code>benchmarking/tag_v*/benchmark_gpp_FLUXNET2015_ensemble.html</code> for latest calibrations.</p>
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">params_modl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  kphio           <span class="op">=</span> <span class="fl">0.09423773</span>,
  soilm_par_a     <span class="op">=</span> <span class="fl">0.33349283</span>,
  soilm_par_b     <span class="op">=</span> <span class="fl">1.45602286</span>
  <span class="op">)</span></code></pre></div>
</div>
<div id="define-soil-parameters-1" class="section level2">
<h2 class="hasAnchor">
<a href="#define-soil-parameters-1" class="anchor"></a>Define soil parameters</h2>
<p>For now, this is implemented as an illustration. Should be made site-specific. Values entered here take no effect.</p>
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_soiltexture</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>
  top    <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>layer <span class="op">=</span> <span class="st">"top"</span>,    fsand <span class="op">=</span> <span class="fl">0.4</span>, fclay <span class="op">=</span> <span class="fl">0.3</span>, forg <span class="op">=</span> <span class="fl">0.1</span>, fgravel <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,
  bottom <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>layer <span class="op">=</span> <span class="st">"bottom"</span>, fsand <span class="op">=</span> <span class="fl">0.4</span>, fclay <span class="op">=</span> <span class="fl">0.3</span>, forg <span class="op">=</span> <span class="fl">0.1</span>, fgravel <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="collect-all-drivers-1" class="section level2">
<h2 class="hasAnchor">
<a href="#collect-all-drivers-1" class="anchor"></a>Collect all drivers</h2>
<p>Finally, we can collect forcing data, simulation parameters, and site meta info into a single object that will be used to drive rsofun. All of the above steps can be customized. The function <code><a href="../reference/collect_drivers_sofun.html">collect_drivers_sofun()</a></code> can in general be used to process forcing data into the format required to run SOFUN. The arguments must have the following form:</p>
<ul>
<li>
<code>siteinfo</code>: A data frame (tibble) with columns <code>sitename</code>, <code>lon</code>, <code>lat</code>, <code>elv</code> (elevation), <code>year_start</code>, <code>year_end</code>, <code>whc</code> (water holding capacity used for simulating the soil water balance). We have created this above.</li>
</ul>
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">siteinfo</span></code></pre></div>
<pre><code>## # A tibble: 3 x 12
##   sitename   lon   lat   elv year_start year_end classid c4      whc
##   &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;    &lt;chr&gt;   &lt;lgl&gt; &lt;dbl&gt;
## 1 AR-SLu   -66.5 -33.5   499 2009       2011     MF      FALSE  268.
## 2 AR-Vir   -56.2 -28.2    97 2009       2012     ENF     FALSE  302.
## 3 AT-Neu    11.3  47.1   970 2002       2012     GRA     FALSE  270.
## # … with 3 more variables: koeppen_code &lt;chr&gt;, igbp_land_use &lt;chr&gt;,
## #   plant_functional_type &lt;chr&gt;</code></pre>
<ul>
<li>
<code>meteo</code>: A nested data frame with columns <code>sitename</code> and <code>data</code>. The latter contains the nested meteorological forcing data frames, with columns <code>date</code>, <code>temp</code>, <code>prec</code>, <code>vpd</code>, <code>ppfd</code>, <code>patm</code>, and <code>ccov</code>. Like this:</li>
</ul>
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## nested data frame:</span>
<span class="va">ddf_meteo</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
## # Groups:   sitename [3]
##   sitename data                
##   &lt;chr&gt;    &lt;list&gt;              
## 1 AR-SLu   &lt;tibble [1,095 × 8]&gt;
## 2 AR-Vir   &lt;tibble [1,460 × 8]&gt;
## 3 AT-Neu   &lt;tibble [4,015 × 8]&gt;</code></pre>
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## inside .$data:</span>
<span class="va">ddf_meteo</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></code></pre></div>
<pre><code>## # A tibble: 1,095 x 8
##    date        temp  prec   vpd     ppfd  patm ccov_int  ccov
##    &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;
##  1 2009-01-01  21.8 3.07   665. 0.000162 95295     35.9  35.9
##  2 2009-01-02  22.4 0.693 1062. 0.000520 95597     35.4  35.4
##  3 2009-01-03  25.9 0     1830. 0.000699 95651     35.0  35.0
##  4 2009-01-04  29.4 0     2620. 0.000838 95272     34.5  34.5
##  5 2009-01-05  28.8 0.985 2303. 0.000625 94956     34.0  34.0
##  6 2009-01-06  25.1 6.06   979. 0.000534 94897     33.6  33.6
##  7 2009-01-07  25.9 0     1846. 0.000474 95259     33.1  33.1
##  8 2009-01-08  26.9 0.043 2021. 0.000698 95579     32.7  32.7
##  9 2009-01-09  29.9 0     2862. 0.000791 95697     32.3  32.3
## 10 2009-01-10  31.8 0     3343. 0.000808 95500     31.8  31.8
## # … with 1,085 more rows</code></pre>
<ul>
<li>
<code>fapar</code>: A nested data frame with columns <code>sitename</code> and <code>data</code>. The latter contains the nested meteorological forcing data frames, with columns <code>date</code>, and <code>fapar</code>. Like this:</li>
</ul>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## nested data frame:</span>
<span class="va">df_modis_fpar</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
## # Groups:   sitename [3]
##   sitename data                
##   &lt;chr&gt;    &lt;list&gt;              
## 1 AR-SLu   &lt;tibble [1,095 × 9]&gt;
## 2 AR-Vir   &lt;tibble [1,461 × 9]&gt;
## 3 AT-Neu   &lt;tibble [4,018 × 9]&gt;</code></pre>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## inside .$data:</span>
<span class="va">df_modis_fpar</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">fapar</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 1,095 x 2
##    date       fapar
##    &lt;date&gt;     &lt;dbl&gt;
##  1 2009-01-01 0.548
##  2 2009-01-02 0.543
##  3 2009-01-03 0.538
##  4 2009-01-04 0.533
##  5 2009-01-05 0.529
##  6 2009-01-06 0.524
##  7 2009-01-07 0.519
##  8 2009-01-08 0.515
##  9 2009-01-09 0.510
## 10 2009-01-10 0.506
## # … with 1,085 more rows</code></pre>
<ul>
<li>
<code>co2</code> : A nested data frame with columns <code>sitename</code> and <code>data</code>. The latter contains the nested meteorological forcing data frames, with columns <code>date</code>, and <code>co2</code>. Like this:</li>
</ul>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## nested data frame:</span>
<span class="va">df_co2</span></code></pre></div>
<pre><code>## # A tibble: 3 x 2
## # Groups:   sitename [3]
##   sitename data                
##   &lt;chr&gt;    &lt;list&gt;              
## 1 AR-SLu   &lt;tibble [1,095 × 2]&gt;
## 2 AR-Vir   &lt;tibble [1,461 × 2]&gt;
## 3 AT-Neu   &lt;tibble [4,018 × 2]&gt;</code></pre>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## inside .$data:</span>
<span class="va">df_co2</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">co2</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 1,095 x 2
##    date         co2
##    &lt;date&gt;     &lt;dbl&gt;
##  1 2009-01-01  387.
##  2 2009-01-02  387.
##  3 2009-01-03  387.
##  4 2009-01-04  387.
##  5 2009-01-05  387.
##  6 2009-01-06  387.
##  7 2009-01-07  387.
##  8 2009-01-08  387.
##  9 2009-01-09  387.
## 10 2009-01-10  387.
## # … with 1,085 more rows</code></pre>
<ul>
<li>
<code>df_soiltexture</code>: See above (‘Define soil parameters’)</li>
</ul>
<p>See <a href="https://tidyr.tidyverse.org/reference/nest.html">here</a> for how to handle nested dataframes.</p>
<p>Finally, all input data can be collected by:</p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df_drivers</span> <span class="op">&lt;-</span> <span class="fu">rsofun</span><span class="fu">::</span><span class="fu"><a href="../reference/collect_drivers_sofun.html">collect_drivers_sofun</a></span><span class="op">(</span> 
  siteinfo       <span class="op">=</span> <span class="va">siteinfo</span>,
  params_siml    <span class="op">=</span> <span class="va">params_siml</span>,
  meteo          <span class="op">=</span> <span class="va">ddf_meteo</span>, 
  fapar          <span class="op">=</span> <span class="va">df_modis_fpar</span>,
  co2            <span class="op">=</span> <span class="va">df_co2</span>,
  df_soiltexture <span class="op">=</span> <span class="va">df_soiltexture</span>
  <span class="op">)</span>
<span class="va">df_drivers</span></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   sitename forcing             params_siml       siteinfo        df_soiltexture 
##   &lt;chr&gt;    &lt;list&gt;              &lt;list&gt;            &lt;list&gt;          &lt;list&gt;         
## 1 AR-SLu   &lt;tibble [1,095 × 1… &lt;tibble [1 × 18]&gt; &lt;tibble [1 × 1… &lt;tibble [2 × 5…
## 2 AR-Vir   &lt;tibble [1,460 × 1… &lt;tibble [1 × 18]&gt; &lt;tibble [1 × 1… &lt;tibble [2 × 5…
## 3 AT-Neu   &lt;tibble [4,015 × 1… &lt;tibble [1 × 18]&gt; &lt;tibble [1 × 1… &lt;tibble [2 × 5…</code></pre>
</div>
<div id="run-model-1" class="section level2">
<h2 class="hasAnchor">
<a href="#run-model-1" class="anchor"></a>Run model</h2>
<p>Finally, run the model for a set of sites.</p>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ## this works:</span>
<span class="co"># load("~/data/rsofun_benchmarking/df_drivers_fluxnet2015.Rdata")</span>
<span class="co"># df_output &lt;- runread_pmodel_f(</span>
<span class="co">#      df_drivers_fluxnet2015 %&gt;% slice(1:3),</span>
<span class="co">#      params_modl = params_modl,</span>
<span class="co">#      makecheck = TRUE,</span>
<span class="co">#      parallel = FALSE</span>
<span class="co">#      )</span>
<span class="co"># </span>
<span class="co"># ## how are the two df_drivers different?</span>
<span class="co"># ## top-level</span>
<span class="co"># df_drivers_fluxnet2015 %&gt;% slice(1:3)</span>
<span class="co"># df_drivers</span>
<span class="co"># </span>
<span class="co"># ## forcing</span>
<span class="co"># df_drivers_fluxnet2015 %&gt;% slice(1) %&gt;% pull(forcing)</span>
<span class="co"># df_drivers$forcing[[1]]</span>
<span class="co"># </span>
<span class="co"># ## params_siml</span>
<span class="co"># df_drivers_fluxnet2015 %&gt;% slice(1) %&gt;% pull(params_siml)</span>
<span class="co"># df_drivers$params_siml[[1]]</span>

<span class="co">## this crashes:</span>
<span class="va">df_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runread_pmodel_f.html">runread_pmodel_f</a></span><span class="op">(</span>
     <span class="va">df_drivers</span>,
     params_modl <span class="op">=</span> <span class="va">params_modl</span>
<span class="op">)</span></code></pre></div>
<pre><code>## Warning: Problem with `mutate()` input `data`.
## ℹ the condition has length &gt; 1 and only the first element will be used
## ℹ Input `data` is `purrr::pmap(...)`.

## Warning: Problem with `mutate()` input `data`.
## ℹ the condition has length &gt; 1 and only the first element will be used
## ℹ Input `data` is `purrr::pmap(...)`.

## Warning: Problem with `mutate()` input `data`.
## ℹ the condition has length &gt; 1 and only the first element will be used
## ℹ Input `data` is `purrr::pmap(...)`.</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Benjamin Stocker.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
